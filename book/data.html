<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>TBEP-CC - 2&nbsp; Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./intro.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./data.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">TBEP-CC</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/tbep-tech/climate-change-indicators" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./TBEP-CC.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./TBEP-CC.docx">
              <i class="bi bi-bi-file-word pe-1"></i>
            Download Docx
            </a>
          </li>
      </ul>
    </div>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-1" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-1">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#task-1.-assessment-of-available-data-and-coverage" id="toc-task-1.-assessment-of-available-data-and-coverage" class="nav-link active" data-scroll-target="#task-1.-assessment-of-available-data-and-coverage"><span class="header-section-number">2.1</span> Task 1. Assessment of available data and coverage</a></li>
  <li><a href="#air" id="toc-air" class="nav-link" data-scroll-target="#air"><span class="header-section-number">2.2</span> Air</a>
  <ul class="collapse">
  <li><a href="#observed" id="toc-observed" class="nav-link" data-scroll-target="#observed"><span class="header-section-number">2.2.1</span> Observed</a></li>
  </ul></li>
  <li><a href="#precipitation" id="toc-precipitation" class="nav-link" data-scroll-target="#precipitation"><span class="header-section-number">2.3</span> Precipitation</a>
  <ul class="collapse">
  <li><a href="#rnomads" id="toc-rnomads" class="nav-link" data-scroll-target="#rnomads"><span class="header-section-number">2.3.1</span> rNOMADS</a></li>
  </ul></li>
  <li><a href="#prism" id="toc-prism" class="nav-link" data-scroll-target="#prism"><span class="header-section-number">2.4</span> PRISM</a>
  <ul class="collapse">
  <li><a href="#example-tbeptoolsread_importprism" id="toc-example-tbeptoolsread_importprism" class="nav-link" data-scroll-target="#example-tbeptoolsread_importprism"><span class="header-section-number">2.4.1</span> Example <code>tbeptools::read_importprism()</code></a></li>
  <li><a href="#operationalize" id="toc-operationalize" class="nav-link" data-scroll-target="#operationalize"><span class="header-section-number">2.4.2</span> Operationalize</a></li>
  </ul></li>
  <li><a href="#assign-bounding-box-for-aoi-cropping-of-rasters" id="toc-assign-bounding-box-for-aoi-cropping-of-rasters" class="nav-link" data-scroll-target="#assign-bounding-box-for-aoi-cropping-of-rasters"><span class="header-section-number">2.5</span> Assign bounding box for AoI cropping of rasters</a></li>
  <li><a href="#map-swipe-yesterday-vs-climatology" id="toc-map-swipe-yesterday-vs-climatology" class="nav-link" data-scroll-target="#map-swipe-yesterday-vs-climatology"><span class="header-section-number">2.6</span> Map Swipe Yesterday vs Climatology</a>
  <ul class="collapse">
  <li><a href="#dewpoint-to-humidity" id="toc-dewpoint-to-humidity" class="nav-link" data-scroll-target="#dewpoint-to-humidity"><span class="header-section-number">2.6.1</span> Dewpoint to Humidity</a></li>
  <li><a href="#communicating-results" id="toc-communicating-results" class="nav-link" data-scroll-target="#communicating-results"><span class="header-section-number">2.6.2</span> Communicating results</a></li>
  </ul></li>
  <li><a href="#sea" id="toc-sea" class="nav-link" data-scroll-target="#sea"><span class="header-section-number">2.7</span> Sea</a>
  <ul class="collapse">
  <li><a href="#sea-level" id="toc-sea-level" class="nav-link" data-scroll-target="#sea-level"><span class="header-section-number">2.7.1</span> Sea Level</a></li>
  <li><a href="#surface-temperature" id="toc-surface-temperature" class="nav-link" data-scroll-target="#surface-temperature"><span class="header-section-number">2.7.2</span> Surface Temperature</a></li>
  <li><a href="#acidification" id="toc-acidification" class="nav-link" data-scroll-target="#acidification"><span class="header-section-number">2.7.3</span> Acidification</a></li>
  </ul></li>
  <li><a href="#extreme-weather" id="toc-extreme-weather" class="nav-link" data-scroll-target="#extreme-weather"><span class="header-section-number">2.8</span> Extreme Weather</a>
  <ul class="collapse">
  <li><a href="#hurricanes" id="toc-hurricanes" class="nav-link" data-scroll-target="#hurricanes"><span class="header-section-number">2.8.1</span> Hurricanes</a></li>
  <li><a href="#floods" id="toc-floods" class="nav-link" data-scroll-target="#floods"><span class="header-section-number">2.8.2</span> Floods</a></li>
  </ul></li>
  <li><a href="#old" id="toc-old" class="nav-link" data-scroll-target="#old"><span class="header-section-number">2.9</span> OLD</a>
  <ul class="collapse">
  <li><a href="#satellite-1" id="toc-satellite-1" class="nav-link" data-scroll-target="#satellite-1"><span class="header-section-number">2.9.1</span> Satellite</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tbep-tech/climate-change-indicators/edit/main/data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Themes for indicators seeking relevance to:</p>
<ul>
<li>Air &amp; Sea</li>
<li>People &amp; Ecosystems</li>
</ul>
<p>Icons</p>
<ul>
<li>Bootstrap
<ul>
<li><a href="https://icons.getbootstrap.com/icons/water/">water</a></li>
<li><a href="https://icons.getbootstrap.com/icons/thermometer/">thermometer</a></li>
<li><a href="https://icons.getbootstrap.com/icons/moisture/">moisture</a></li>
<li><a href="https://icons.getbootstrap.com/icons/thermometer-sun/">thermometer-sun</a></li>
<li><a href="https://icons.getbootstrap.com/icons/cloud-rain-heavy-fill/">cloud-rain-heavy-fill</a></li>
<li><a href="https://icons.getbootstrap.com/icons/tornado/">tornado</a></li>
</ul></li>
<li>Fontawesome
<ul>
<li><a href="https://fontawesome.com/v5/icons/water-rise?f=classic&amp;s=solid">water-rise</a> PRO</li>
</ul></li>
</ul>
<section id="task-1.-assessment-of-available-data-and-coverage" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="task-1.-assessment-of-available-data-and-coverage"><span class="header-section-number">2.1</span> Task 1. Assessment of available data and coverage</h2>
<p>Data descriptive of the risks of climate change can be obtained from several sources. These may include weather or climatological data, long-term tidal gauge data, or in situ water measurements responsive to climate change. Weather and climatological data could be obtained from local weather stations with long-term data, e.g., Tampa International Airport, and could include measures of air temperature, precipitation, and/or storm intensity/frequency. Tidal gauge data are readily available from the NOAA PORTS data retrieval system. Lastly, in situ water measurements could include water temperature, changes in flow hydrology, salinity, and/or pH. Data used to evaluate potential risks related to ocean acidification should also be explored.</p>
<p>The permanency and ease of access of each data source should be noted when making recommendations on indicators to operationalize. Further, indicators that communicate the risks associated with climate change are preferred, as opposed to those that simply indicate change. An example is the number of days in a year when temperature exceeds a critical threshold, as compared to temperature alone. An additional example is frequency of sunny day flooding events, as compared to tidal gauge measurements alone.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># turn off all chunks by default</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># options(repos=c(CRAN="https://cran.mirror.garr.it/CRAN/"))</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(c("sf","terra"), type = "binary")</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::snapshot()</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::clean()</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::rebuild()</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># built from source: sp, survival, rnoaa, tbeptools</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"librarian"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"librarian"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  dplyr, dygraphs, glue, here, htmltools, leaflet, leaflet.extras2, lubridate, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  sf, stringr, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools, prism, purrr,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  RColorBrewer, readr, rnoaa, terra, tidyr, webshot2,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># explicitly list packages for renv::dependencies(); renv::snapshot()</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dygraphs)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(librarian)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnoaa)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tbeptools)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(webshot2)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="air" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="air"><span class="header-section-number">2.2</span> Air</h2>
<p>noaacrwsstDaily</p>
<section id="observed" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="observed"><span class="header-section-number">2.2.1</span> Observed</h3>
<p>The <a href="https://docs.ropensci.org/rnoaa/"><code>rnoaa</code></a> R package uses NOAA NCDC API v2, which only goes to 2022-09-15.</p>
<ul>
<li><p><a href="https://www.ncdc.noaa.gov/cdo-web/webservices">NCEI Web Services | Climate Data Online (CDO) | National Center for Environmental Information (NCEI)</a></p></li>
<li><p><a href="https://www.ncdc.noaa.gov/cdo-web/datatools">Data Tools | Climate Data Online (CDO) | National Climatic Data Center (NCDC)</a></p></li>
</ul>
<section id="weather-stations" class="level4" data-number="2.2.1.1">
<h4 data-number="2.2.1.1" class="anchored" data-anchor-id="weather-stations"><span class="header-section-number">2.2.1.1</span> Weather stations</h4>
<ul>
<li><a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00012842/detail">Tampa International Airport</a>
<ul>
<li>Start Date: 1939-02-01</li>
<li>End Date: today - 3 days</li>
</ul></li>
</ul>
<p>Got token at <a href="https://www.ncdc.noaa.gov/cdo-web/token">ncdc.noaa.gov/cdo-web/token</a>. Added variable <code>NOAA_NCDC_CDO_token</code> to:</p>
<ul>
<li><p>locally:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file.edit</span>(<span class="st">"~/.Renviron"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>on GitHub: Repository secrets in <a href="https://github.com/tbep-tech/climate-change-indicators/settings/secrets/actions">Actions secrets · tbep-tech/climate-change-indicators</a></p></li>
<li><p><a href="https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt">GCHN readme</a></p>
<ul>
<li><code>PRCP</code>: Precipitation (tenths of mm)</li>
<li><code>TMAX</code>: Maximum temperature (tenths of degrees C)</li>
<li><code>TMIN</code>: Minimum temperature (tenths of degrees C)</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># provide NOAA key</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">noaakey =</span> <span class="fu">Sys.getenv</span>(<span class="st">"NOAA_NCDC_CDO_token"</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify datasetid and station</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>stn          <span class="ot">&lt;-</span> <span class="st">"GHCND:USW00012842"</span> <span class="co"># TAMPA INTERNATIONAL AIRPORT, FL US</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>stn_csv      <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/tpa_ghcnd.csv"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>stn_meta_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/tpa_meta.csv"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(stn_meta_csv)){</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cache station metadata since timeout from Github Actions</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  stn_meta <span class="ot">&lt;-</span> <span class="fu">ncdc_stations</span>(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetid =</span> <span class="st">"GHCND"</span>, </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">stationid =</span> stn)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(stn_meta<span class="sc">$</span>data, stn_meta_csv)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(stn_meta_csv)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(stn_csv)){</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  date_beg <span class="ot">&lt;-</span> stn_meta<span class="sc">$</span>data<span class="sc">$</span>mindate</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  date_end <span class="ot">&lt;-</span> stn_meta<span class="sc">$</span>data<span class="sc">$</span>maxdate</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  max_rows <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  vars     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PRCP"</span>,<span class="st">"TMIN"</span>,<span class="st">"TMAX"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  n_vars     <span class="ot">&lt;-</span> <span class="fu">length</span>(vars)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  days_batch <span class="ot">&lt;-</span> <span class="fu">floor</span>(max_rows <span class="sc">/</span> n_vars)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  dates <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ymd</span>(date_beg), </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ymd</span>(date_end), </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">glue</span>(<span class="st">"{days_batch} days"</span>)),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ymd</span>(date_end)))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  n_i <span class="ot">&lt;-</span> <span class="fu">length</span>(dates) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_i){</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for (i in 14:n_i){</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    date_beg <span class="ot">&lt;-</span> dates[i]</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> n_i){</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> dates[i<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> dates[i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">glue</span>(<span class="st">"{i} of {n_i}: {date_beg} to {date_end}  ~  {Sys.time()}"</span>))</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># retry if get Error: Service Unavailable (HTTP 503)</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    o           <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    attempt     <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    attempt_max <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">is.null</span>(o) <span class="sc">&amp;&amp;</span> attempt <span class="sc">&lt;=</span> attempt_max) {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (attempt <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">glue</span>(<span class="st">"  attempt {attempt}"</span>, <span class="at">.trim =</span> F))</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      attempt <span class="ot">&lt;-</span> attempt <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">try</span>(</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        o <span class="ot">&lt;-</span> <span class="fu">ncdc</span>(</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">datasetid  =</span> <span class="st">"GHCND"</span>, </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">stationid  =</span> stn, </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">datatypeid =</span> vars, </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">startdate  =</span> date_beg,</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">enddate    =</span> date_end,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">limit      =</span> max_rows) )</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> o<span class="sc">$</span>data</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df, o<span class="sc">$</span>data)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">duplicated</span>(df[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])<span class="sc">|&gt;</span> <span class="fu">sum</span>() <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">date     =</span> <span class="fu">as.Date</span>(<span class="fu">strptime</span>(</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        date, <span class="st">"%Y-%m-%dT00:00:00"</span>)),</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">datatype =</span> <span class="fu">recode</span>(</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        datatype, </span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">PRCP =</span> <span class="st">"precip_mm"</span>, </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">TMIN =</span> <span class="st">"temp_c_min"</span>, </span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="at">TMAX =</span> <span class="st">"temp_c_max"</span>),</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">value    =</span> value <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>station, <span class="co"># station         : all "GHCND:USW00012842"</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_m,    <span class="co"># measurement flag: 3,524 are "T" for trace</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_t,    <span class="co"># time        flag: all "2400"</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_q)    <span class="co"># quality     flag: all ""</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(df, stn_csv)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(stn_csv)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, datatype, value) <span class="sc">|&gt;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datatype <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"temp_c_min"</span>,<span class="st">"temp_c_max"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> datatype, </span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dygraph</span>(<span class="at">main =</span> <span class="st">"Daily Temperature (ºC)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyOptions</span>(</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">colors =</span> <span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"YlOrRd"</span>)[<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">3</span>)]) <span class="sc">|&gt;</span> </span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"temp_c_min"</span>, <span class="at">label =</span> <span class="st">"min"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"temp_c_max"</span>, <span class="at">label =</span> <span class="st">"max"</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, datatype, value) <span class="sc">|&gt;</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datatype <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"precip_mm"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> datatype, </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dygraph</span>(<span class="at">main =</span> <span class="st">"Daily Precipitation (mm)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"precip_mm"</span>, <span class="at">label =</span> <span class="st">"precip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>TODO: - trend analysis. e.g.&nbsp;<a href="https://www.ncdc.noaa.gov/cag/global/time-series/globe/land_ocean/ytd/12/1880-2020">NOAA’s Climate at a Glance</a>. Typically based on the last 30 years, but here we’ve got back to 1939-02-01 so almost 100 years. Keep it 5 years and see how rate changing over time.</p>
<ul>
<li>severe weather events? “Sea-level rise exponentially increases coastal flood frequency Mohsen taherkhani”</li>
</ul>
</section>
<section id="satellite" class="level4" data-number="2.2.1.2">
<h4 data-number="2.2.1.2" class="anchored" data-anchor-id="satellite"><span class="header-section-number">2.2.1.2</span> Satellite</h4>
</section>
</section>
</section>
<section id="precipitation" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="precipitation"><span class="header-section-number">2.3</span> Precipitation</h2>
<p>Materials:</p>
<ul>
<li><p>“RAIN AS A DRIVER” in <a href="https://github.com/tbep-tech/tbep-os-presentations/blob/6ff9054aa0eb1f194a9a28e3dc8b1eff02b6a58f/state_of_the_bay_2023.qmd#L354">tbep-os-presentations/state_of_the_bay_2023.qmd</a></p></li>
<li><p><a href="https://www.ncei.noaa.gov/products/climate-data-records/precipitation-nexrad-qpe">Precipitation - NEXRAD QPE CDR | National Centers for Environmental Information (NCEI)</a></p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  dplyr, here, leaflet,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapview, </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  readxl, sf, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># register with renv</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># library(mapview)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tbeptools)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># from SWFWMD grid cells, use only if interested in areas finer than TB watershed</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this currently gets the same data as the compiled spreadsheet</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>grd <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">'../tbep-os-presentations/data/swfwmd-GARR-gisfiles-utm/swfwmd_pixel_2_utm_m_83.shp'</span>), <span class="at">quiet =</span> T)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># mapView(grd)</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>tbgrdcent <span class="ot">&lt;-</span> grd <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(tbshed)) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  .[tbshed, ]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># unzip folders</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>loc <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">'../tbep-os-presentations/data/swfwmd_rain'</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(loc, pattern = '.zip', full.names = T)</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># lapply(files, unzip, exdir = loc)</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># read text files</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>raindat <span class="ot">&lt;-</span> <span class="fu">list.files</span>(loc, <span class="at">pattern =</span> <span class="st">'19.*</span><span class="sc">\\</span><span class="st">.txt$|20.*</span><span class="sc">\\</span><span class="st">.txt$'</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(read.table, <span class="at">sep =</span> <span class="st">','</span>, <span class="at">header =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(<span class="st">'rbind'</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PIXEL'</span> <span class="ot">=</span> V1,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'yr'</span> <span class="ot">=</span> V2,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'inches'</span> <span class="ot">=</span> V3) <span class="sc">%&gt;%</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PIXEL <span class="sc">%in%</span> tbgrdcent<span class="sc">$</span>PIXEL)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ave rain dat</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> raindat <span class="sc">%&gt;%</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="fu">mean</span>(inches, <span class="at">na.rm =</span> T),</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">'yr'</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co"># use compiled SWFWMD data</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co"># # https://www.swfwmd.state.fl.us/resources/data-maps/rainfall-summary-data-region</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co"># # file is from the link "USGS watershed"</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co"># download.file(</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   'https://www4.swfwmd.state.fl.us/RDDataImages/surf.xlsx?_ga=2.186665249.868698214.1705929229-785009494.1704644825',</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co">#   here('data/swfwmdrainfall.xlsx'),</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="co">#   mode = 'wb'</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>raindatave_url <span class="ot">&lt;-</span> <span class="st">"https://www4.swfwmd.state.fl.us/RDDataImages/surf.xlsx"</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">'data/swfwmd.state.fl.us'</span>))</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>raindatave_xl <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">'data/swfwmd.state.fl.us/surf.xlsx'</span>)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(raindatave_url, raindatave_xl)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(raindatave_xl)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(raindatave_url, <span class="fu">here</span>(<span class="st">'data/swfwmdrainfall.xlsx'</span>), <span class="at">mode =</span> <span class="st">'wb'</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  raindatave_xl, <span class="at">sheet =</span> <span class="st">'ann-usgsbsn'</span>, <span class="at">skip =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">%in%</span> <span class="dv">1975</span><span class="sc">:</span><span class="dv">2023</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> Year, </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="st">`</span><span class="at">Tampa Bay/Coastal Areas</span><span class="st">`</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(as.numeric)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>raindatave_now <span class="ot">&lt;-</span> </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>readxl<span class="sc">::</span><span class="fu">read_excel</span>()</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">'data/swfwmdrainfall.xlsx'</span>), <span class="at">sheet =</span> <span class="st">'ann-usgsbsn'</span>, <span class="at">skip =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">%in%</span> <span class="dv">1975</span><span class="sc">:</span><span class="dv">2023</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> Year, </span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="st">`</span><span class="at">Tampa Bay/Coastal Areas</span><span class="st">`</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(as.numeric)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co"># ave chldat</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>chlave <span class="ot">&lt;-</span> <span class="fu">anlz_avedat</span>(epcdata) <span class="sc">%&gt;%</span> </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span>ann <span class="sc">%&gt;%</span> </span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var <span class="sc">==</span> <span class="st">'mean_chla'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">chla =</span> <span class="fu">mean</span>(val, <span class="at">na.rm =</span> T),</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">'yr'</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">&gt;=</span> <span class="dv">1975</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>toplo <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(chlave, raindatave, <span class="at">by =</span> <span class="st">'yr'</span>)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(raindatave, <span class="fu">aes</span>(<span class="at">x =</span> yr, <span class="at">y =</span> inches)) <span class="sc">+</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> raindatave[chlave<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Annual rainfall (inches)'</span>, </span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual rainfall'</span>, </span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Tampa Bay watershed, 1975 - 2023'</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(chlave, <span class="fu">aes</span>(<span class="at">x =</span> yr, <span class="at">y =</span> chla)) <span class="sc">+</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> chlave[chlave<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Chlorophyll-a (ug/L)'</span>, </span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual mean chlorophyll-a'</span>, </span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'All segments, 1975 - 2023'</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(toplo, <span class="fu">aes</span>(<span class="at">x =</span> inches, <span class="at">y =</span> chla)) <span class="sc">+</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> yr), <span class="at">point.size =</span> <span class="cn">NA</span>, <span class="at">segment.size =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="at">data =</span> toplo[toplo<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="fu">aes</span>(<span class="at">label =</span> yr), <span class="at">color =</span> <span class="st">'red'</span>, <span class="at">point.size =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">se =</span> F, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span> </span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_segment(aes(x = 45, xend = 40, y = 4.86, yend = 4.86), color = 'red', arrow = arrow(length = unit(0.2, "inches")), linewidth = 1) +</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Annual rainfall (inches)'</span>, </span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Chlorophyll-a (ug/L)'</span>, </span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual mean chlorophyll-a vs. rainfall'</span>, </span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Data from EPCHC, SWFWMD'</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> (p1 <span class="sc">/</span> p2) <span class="sc">|</span> p3</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="rnomads" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="rnomads"><span class="header-section-number">2.3.1</span> rNOMADS</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># librarian::shelf(rNOMADS)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="prism" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="prism"><span class="header-section-number">2.4</span> PRISM</h2>
<ul>
<li><a href="https://qed.epa.gov/hms/meteorology/humidity/algorithms/">HMS: Hydrologic Micro Services | United States Environmental Protection Agency | US EPA</a></li>
</ul>
<blockquote class="blockquote">
<p>The <a href="https://prism.oregonstate.edu/">Parameter-elevation Relationship on Independent Slopes Model (PRISM)</a> is a combined dataset consisting of ground gauge station and RADAR products. The data is on a 4km grid resolution covering the contiguous United States. Data is available from 1981 to present.PRISM data are reported in GMT (UTC). PRISM provides daily average temperature and dew-point temperature data. Relative humidity is calculated using a version of the <a href="https://bmcnoldy.rsmas.miami.edu/Humidity.html">August-Roche-Magnus equation</a> as follows ): <code>RH = 100*(EXP((17.625*TD)/(243.04+TD))/EXP((17.625*T)/(243.04+T)))</code> where, <code>RH</code> is % relative humidity, <code>TD</code> is dew-point temperature (celsius), and <code>T</code> is air temperature (celsius).</p>
</blockquote>
<ul>
<li><p><a href="https://water.weather.gov/precip/about.php">AHPS Precipitation Analysis</a></p>
<blockquote class="blockquote">
<p>“Normal” precipitation is derived from PRISM climate data, created at Oregon State University. The PRISM gridded climate maps are considered the most detailed, highest-quality spatial climate datasets currently available.</p>
</blockquote></li>
<li><p><a href="https://docs.ropensci.org/prism/articles/prism.html#prism-data-and-parameters">prism</a> R package</p></li>
</ul>
<table class="table">
<thead>
<tr class="header">
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>tmin</code></td>
<td>Minimum temperature</td>
</tr>
<tr class="even">
<td><code>tmax</code></td>
<td>Maximum temperature</td>
</tr>
<tr class="odd">
<td><code>tmean</code></td>
<td>Mean temperature (<code>tmean == mean(tmin, tmax)</code>)</td>
</tr>
<tr class="even">
<td><code>tdmean</code></td>
<td>Mean dew point temperature</td>
</tr>
<tr class="odd">
<td><code>ppt</code></td>
<td>Total precipitation (rain and snow)</td>
</tr>
<tr class="even">
<td><code>vpdmin</code></td>
<td>Daily minimum vapor pressure deficit</td>
</tr>
<tr class="odd">
<td><code>vpdmax</code></td>
<td>Daily maximum vapor pressure deficit</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p>Data are at 4km resolution, except for the normals which can also be downloaded at 800m resolution.</p>
</blockquote>
<p>Temporal data availability:</p>
<ul>
<li><p><strong>Recent</strong><br>
1981 to present<br>
daily, monthly, annual data</p></li>
<li><p><strong>Historical</strong><br>
1895 through 1980<br>
complete monthly and annual data by year</p></li>
<li><p><strong>Normals</strong><br>
30-year normals daily, monthly, and annual normals, each as a single grid The 30 year PRISM normal from 1981-2010 is used for precipitation analysis since 2004. Prior to 2004 the 30 year PRISM normal from 1961-1990 is used.</p></li>
<li><p>Forms</p>
<ul>
<li><p>stable</p></li>
<li><p>provisional</p></li>
<li><p>early</p></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>Daily data are considered “early” for the current month. The previous six months are provisional data. After six months data are considered stable. Thus early data only exist for daily data, while there can be monthly (and presumably yearly) provisional data. – <code>?prism::prism_archive_clean</code></p>
</blockquote>
<section id="example-tbeptoolsread_importprism" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="example-tbeptoolsread_importprism"><span class="header-section-number">2.4.1</span> Example <code>tbeptools::read_importprism()</code></h3>
<ul>
<li><code>@example</code> from <a href="https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/read_importprism.R"><code>tbeptools::read_importprism()</code></a></li>
</ul>
<div class="cell" data-messages="false">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_local("../tbeptools", force = T)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::load_all("../tbeptools")</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># setup output directory and table</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>dir_tif   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../tbeptools/inst/prism"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>zonal_csv <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_tif, <span class="st">"_zones.csv"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># run function for Tampa Bay watersheds for first 3 days and 4 variables</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_importprism</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars      =</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_beg  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-01"</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-03"</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir_tif   =</span> dir_tif,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">sf_zones  =</span> tbsegshed,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">fld_zones =</span> <span class="st">"bay_segment"</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> zonal_csv)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot first of output rasters</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>tifs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_tif, <span class="at">pattern =</span> <span class="st">".tif$"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="fu">basename</span>(tifs)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(tifs[<span class="dv">1</span>])</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r) <span class="co"># {data observed}_{variable}_v{version}_{date updated}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plet</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  r[[<span class="dv">3</span>]],</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">main  =</span> <span class="fu">names</span>(r)[<span class="dv">3</span>],</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">col   =</span> <span class="st">"Spectral"</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">tiles =</span> <span class="st">"CartoDB.DarkMatter"</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary by zone</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="operationalize" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="operationalize"><span class="header-section-number">2.4.2</span> Operationalize</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  dplyr, here, sf, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>dir_prism <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/prism"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>prism_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/prism.csv"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Tampa Bay watershed zones, including whole bay ("TB")</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>tb_zones <span class="ot">&lt;-</span> tbsegshed <span class="sc">|&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    tbshed <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">bay_segment =</span> <span class="st">"TB"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(bay_segment, geometry))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># bounding box with 0.2º margin around watershed, rounded to .1</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> tbshed <span class="sc">|&gt;</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="fl">0.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     c(xmin = -82.9, ymin = 27.4, xmax = -81.9, ymax = 28.4)</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># after running terra::trim() on raster:</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_importprism</span>(</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars      =</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_beg  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-01"</span>),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end  =</span> <span class="fu">Sys.Date</span>(),</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">bbox      =</span> bb,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir_tif   =</span> dir_prism,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">sf_zones  =</span> tb_zones,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">fld_zones =</span> <span class="st">"bay_segment"</span>,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> prism_csv,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose   =</span> T)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary by zone</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>TODO: Github Action on daily cron to run <code>read_importprism()</code> for all days and variables</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get monthly (every month) and annual 30-year normals for precipitation</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get_prism_normals(</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># type = "ppt",</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># resolution = "800m",</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># mon = 1:12,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># annual = TRUE,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># keepZip = FALSE)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>var    <span class="ot">&lt;-</span> <span class="st">"tmax"</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="st">"daily"</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>date   <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>) <span class="co"># yesterday</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prism_dailys</span>(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">type    =</span> <span class="st">"tmax"</span>, </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates   =</span> date, </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepZip =</span> F)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">prism_archive_subset</span>(var, period, <span class="at">dates =</span> date)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="fu">pd_image</span>(pd, <span class="at">col=</span><span class="st">"redblue"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pd) <span class="sc">|&gt;</span> </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>r_3857 <span class="ot">&lt;-</span> <span class="fu">projectRasterForLeaflet</span>(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  r, <span class="at">method =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorNumeric</span>(</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spectral"</span>,  <span class="fu">values</span>(r_3857, <span class="at">na.rm=</span>T), </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">na.color =</span> <span class="st">"transparent"</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.Positron) <span class="sc">|&gt;</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    r_3857, <span class="at">opacity =</span> <span class="fl">0.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tbsegshed, </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">fillOpacity =</span> <span class="dv">0</span>, </span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"purple"</span>, <span class="at">weight =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="assign-bounding-box-for-aoi-cropping-of-rasters" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="assign-bounding-box-for-aoi-cropping-of-rasters"><span class="header-section-number">2.5</span> Assign bounding box for AoI cropping of rasters</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tbshed_pd &lt;- tbshed |&gt; </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(<span class="fu">prism_archive_subset</span>(<span class="st">"tmax"</span>, <span class="st">"daily"</span>)[<span class="dv">1</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>crs <span class="ot">&lt;-</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)  <span class="co"># +proj=longlat +datum=NAD83 +no_defs</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>tbshed_pd <span class="ot">&lt;-</span> tbsegshed <span class="sc">|&gt;</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(F)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>tbshed_buf <span class="ot">&lt;-</span> tbshed_pd <span class="sc">|&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_union</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_valid</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="fl">0.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbshed_buf) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># xmin  ymin  xmax  ymax </span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># -83.1  27.2 -81.7  28.6</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.1</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>ply_bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span> </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>Stadia.StamenTonerLite) <span class="sc">|&gt;</span> </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> ply_bb, <span class="at">color=</span><span class="st">"green"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> tbshed_pd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr) <span class="co"># install.packages("furrr")</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> n_cores)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>prism_archive_crop <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  type, temp_period, ...,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb  =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span>, <span class="co"># WRONG: "+proj=longlat +ellps=GRS80 +no_defs"</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> F){</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  ply_bb <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> crs) <span class="sc">|&gt;</span> </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(type, temp_period, ...)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pds)){ <span class="co"># i = 1</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">pd_stack</span>(pds[i]) <span class="sc">|&gt;</span> </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    is_cropped <span class="ot">&lt;-</span> <span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">==</span> bb)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>is_cropped){</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      r_bil <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sources</span>(r)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>      r_bb <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(r, ply_bb, <span class="at">mask =</span> T, <span class="at">touches =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">trim</span>()</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">writeRaster</span>(r_bb, r_bil, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      bb_cropped <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(r_bb) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(bb_cropped <span class="sc">==</span> bb))</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="fu">glue</span>(</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>          <span class="st">"bbox of clipped raster rounded to 1 decimal:</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="st">              {paste(bb_cropped, collapse=', ')}</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="st">           does not match input argument `bb`:</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="st">              {paste(bb, collapse=', ')}"</span>))</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>yrs  <span class="ot">&lt;-</span> <span class="dv">1981</span><span class="sc">:</span><span class="fu">year</span>(<span class="fu">now</span>())</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>mos  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>)  </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co"># skipping: "tmean" [avg(tmin,tmax)], vapor pressure ["vpdmin", "vpdmax"]</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ((today() - days(1)) - date("1981-01-01")) |&gt; as.integer() * length(vars) # 63,304 dirs expected in tmp/prism</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>n_dirs <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>), <span class="at">type =</span> <span class="st">"directory"</span>) <span class="sc">|&gt;</span> <span class="fu">length</span>()</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{n_dirs} ~ {Sys.time()}"</span>))</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 1540 ~ 2024-05-02 18:28:41.717828</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 2527 ~ 2024-05-02 18:46:32.97783</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 3357 ~ 2024-05-02 18:59:52.753584</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>n_all <span class="ot">&lt;-</span> <span class="dv">63304</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="dv">1540</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2024-05-02 18:28:41.717828"</span>, <span class="st">"Ymd HMS"</span>)</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>n2 <span class="ot">&lt;-</span> <span class="dv">3357</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>t2 <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2024-05-02 18:59:52.753584"</span>, <span class="st">"Ymd HMS"</span>)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">difftime</span>(t2, t1, <span class="at">units =</span> <span class="st">"secs"</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>dn <span class="ot">&lt;-</span> n2 <span class="sc">-</span> n1</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>n_togo <span class="ot">&lt;-</span> n_all <span class="sc">-</span> n2</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> t2 <span class="sc">+</span> <span class="fu">seconds</span>(dn <span class="sc">/</span> dt <span class="sc">*</span> n_togo)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"ETA: {eta}"</span>))</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="co"># ETA: 2024-05-03 10:20:03.1543</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="co"># ETA: 2024-05-03 11:10:09.588966</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>yesterday <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>d_ymv <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">yr =</span> yrs) <span class="sc">|&gt;</span> </span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">mo =</span> mos)) <span class="sc">|&gt;</span> </span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">var =</span> vars)) <span class="sc">|&gt;</span> </span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_beg =</span> <span class="fu">map2_chr</span>(yr, mo, \(yr, mo){</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">date</span>(<span class="fu">glue</span>(<span class="st">"{yr}-{mo}-01"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>() }),</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_end =</span> <span class="fu">map_chr</span>(date_beg, \(date_beg){</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># date_beg &lt;- "2024-05-01"</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> (<span class="fu">date</span>(date_beg) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span>)) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (date_end <span class="sc">&gt;</span> yesterday)</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>        date_end <span class="ot">&lt;-</span> yesterday</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>      date_end <span class="sc">|&gt;</span> </span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>()</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    }) ) <span class="sc">|&gt;</span> </span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">date</span>(date_beg) <span class="sc">&lt;=</span> yesterday) <span class="sc">|&gt;</span> </span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date_beg, date_end, var) <span class="sc">|&gt;</span> </span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date_beg, date_end, var) <span class="sc">|&gt;</span> </span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(date(date_beg) &gt;= date("1981-03-01")) |&gt; </span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rstudio.marinesensitivity.org:</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_beg) &gt;= date("1981-09-01"),</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_end) &lt;  date("1986-07-01")) # |&gt; </span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># laptop:</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_beg) &gt;= date("1986-12-01")) # |&gt;</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_files =</span> <span class="fu">pmap_int</span>(<span class="fu">list</span>(</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">date_beg =</span> date_beg,</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>      <span class="at">date_end =</span> date_end,</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>      <span class="at">var      =</span> var), \(date_beg, date_end, var){</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>        prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>          var, <span class="st">"daily"</span>,</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>          <span class="at">minDate =</span> date_beg,</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>          <span class="at">maxDate =</span> date_end) <span class="sc">|&gt;</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>          <span class="fu">length</span>() }),</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_days =</span> <span class="fu">map2_int</span>(date_beg, date_end, \(date_beg, date_end){</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>      <span class="fu">difftime</span>(<span class="fu">date</span>(date_end), <span class="fu">date</span>(date_beg), <span class="at">units =</span> <span class="st">"days"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.integer</span>() }),</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_done =</span> n_files <span class="sc">/</span> n_days)</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>prism_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"tmp/prism.csv"</span>)</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(d_ymv, prism_csv)</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: delete all extraneous station files</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a><span class="co"># find . -name "*_bil.stn.csv" -type f -delete</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: on server remove dir </span></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a><span class="co"># dir='PRISM_ppt_provisional_4kmD2_20231101_bil'</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="co"># re='PRISM_(.*)_(.*)_(.*)_(.*)_bil'</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a><span class="co"># [[ $dir =~ $re ]] &amp;&amp; date="${BASH_REMATCH[4]}" &amp;&amp; echo "date: $date for $dir"</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="co"># var=${dir//$re/\1}</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a><span class="co"># type=${dir//$re/\2}</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="co"># res=${dir//$re/\3}</span></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a><span class="co"># date=${dir//$re/\4}</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a><span class="fu">future_pmap</span>(d_ymv, \(date_beg, date_end, var){</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch PRISM national rasters</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_prism_dailys</span>(</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">type    =</span> var, </span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end,</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">keepZip =</span> F)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any duplicates: stable &gt; provisional &gt; early</span></span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_clean</span>(</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>    var, <span class="st">"daily"</span>, </span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end)</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim rasters to bounding box</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>    var, <span class="st">"daily"</span>, </span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end)</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a><span class="co"># clear future processes</span></span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(<span class="fu">plan</span>(), <span class="st">"sequential"</span>)) <span class="fu">plan</span>(sequential)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> vars)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(var, <span class="st">"daily"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr) <span class="co"># install.packages("furrr")</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> n_cores)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>dir_prism <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(dir_prism)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>vars      <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>dates_all <span class="ot">&lt;-</span> (<span class="fu">date</span>(<span class="st">"1981-01-01"</span>)<span class="sc">:</span>(<span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>))) <span class="sc">|&gt;</span> <span class="fu">as.Date</span>()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>rx   <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>d_done <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> vars){ <span class="co"># var &lt;- vars[4]</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(<span class="at">type =</span> var, <span class="at">temp_period =</span> <span class="st">"daily"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  d_var <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">pd =</span> pds) <span class="sc">|&gt;</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>) ) </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(d_done) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    d_done <span class="ot">&lt;-</span> d_var</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    d_done <span class="ot">&lt;-</span> d_done <span class="sc">|&gt;</span> </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(d_var)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_done$var)</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">#    ppt tdmean   tmax   tmin </span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">#  15759  15807  15746  15805</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>d_todo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> vars) <span class="sc">|&gt;</span> </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(<span class="fu">tibble</span>(</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> dates_all)) <span class="sc">|&gt;</span> </span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    d_done <span class="sc">|&gt;</span> </span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(var, date),</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"var"</span>))</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>prism_dates_crop <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    var, </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    dates, </span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">dir_prism =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>)){</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var = "tmin"; dates = date("2024-05-01"); dir_prism = here::here("tmp/prism")</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep -v stable | grep -v provisional | tail</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_stable      | head : PRISM_tmin_stable_4kmD2_19810101_bil</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_stable      | tail : PRISM_tmin_stable_4kmD2_20231031_bil</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_provisional | head : PRISM_tmin_provisional_4kmD2_20231101_bil</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_provisional | tail : PRISM_tmin_provisional_4kmD2_20240430_bil</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_early       | head : PRISM_tmin_early_4kmD2_20240501_bil</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_early       | tail : PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rm -r PRISM_tmin_stable_4kmD2_19810101_bil \</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_stable_4kmD2_20231031_bil \</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_provisional_4kmD2_20231101_bil \</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_provisional_4kmD2_20240430_bil \</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_early_4kmD2_20240501_bil \</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prism_dates_crop(</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   "tmin", </span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   c("1981-01-01","2023-10-31", "2023-11-01", "2024-04-30", "2024-05-01") # , "2024-05-09"))</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_set_dl_dir</span>(dir_prism)</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch PRISM national rasters</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get_prism_dailys(</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   type    = var,</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dates   = dates,</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   keepZip = F)</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any duplicates: stable &gt; provisional &gt; early</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_clean</span>(</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">type        =</span> var, </span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_period =</span> <span class="st">"daily"</span>, </span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">dates       =</span> dates)</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bil &lt;- prism_archive_subset(</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   type        = var,</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   temp_period = "daily",</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dates       = dates) |&gt;</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   pd_to_file()</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># crs_r &lt;- rast(bil) |&gt; crs(proj=T) </span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(paste(glue("{basename(bil)}: {crs_r}"),"\n"))</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># early (PRISM_tmin_early_4kmD2_20240509_bil):</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   "+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim rasters to bounding box</span></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">type        =</span> var,</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_period =</span> <span class="st">"daily"</span>,</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">dates       =</span> dates)</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_dates_crop</span>(</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tmin"</span>,</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"1981-01-01"</span>,<span class="st">"2023-10-31"</span>, <span class="st">"2023-11-01"</span>, <span class="st">"2024-04-30"</span>, <span class="st">"2024-05-01"</span>)) <span class="co"># , "2024-05-09"))</span></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a><span class="co"># 20240430_bil</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="co"># ls -l | grep -v stable | grep -v provisional | tail</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>d_todo <span class="sc">|&gt;</span> </span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># future_pmap(prism_dates_crop)</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(prism_dates_crop)</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>var  <span class="ot">&lt;-</span> vars[<span class="dv">1</span>] <span class="co"># </span><span class="al">TODO</span><span class="co">: loop all vars</span></span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a> <span class="co"># check only one crs and bb</span></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_bils<span class="sc">$</span>crs)</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_bils<span class="sc">$</span>bb)</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a><span class="co"># save daily climatologies ----</span></span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>  fs)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>rx   <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>d_bils <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">dir_ls</span>(dir_prism, <span class="at">glob =</span> <span class="st">"*.bil"</span>, <span class="at">recurse =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">pd    =</span> <span class="fu">basename</span>(path_bil) <span class="sc">|&gt;</span> <span class="fu">path_ext_remove</span>(),</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">md    =</span> <span class="fu">format</span>(date, <span class="st">"%m-%d"</span>))</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>crs <span class="ot">=</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>bb  <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>ply_bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>d_bils <span class="sc">|&gt;</span> </span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(md, date, var) <span class="sc">|&gt;</span>  <span class="co"># order by: month-day, date, variable</span></span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(md, path) <span class="sc">|&gt;</span> </span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(md) <span class="sc">|&gt;</span> </span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">paths =</span> path) <span class="sc">|&gt;</span> </span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(md <span class="sc">==</span> <span class="st">"01-01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pull(md) %&gt;% .[92]</span></span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># slice(91:93) |&gt; </span></span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pwalk</span>(\(md, paths){</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (md <span class="sc">==</span> <span class="st">"01-01"</span>)</span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">browser</span>()</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    r_tif <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"tmp/daily/prism_daily_{md}.tif"</span>))</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(r_tif)){</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{basename(r_tif)} exists, skipping"</span>))</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{basename(r_tif)} building"</span>))</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>    paths <span class="sc">|&gt;</span> </span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>        <span class="at">ext =</span> <span class="fu">map_chr</span>(</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>          path, \(p){ </span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ext</span>(<span class="fu">rast</span>(p)) <span class="sc">|&gt;</span> <span class="fu">as.vector</span>() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(<span class="at">collapse=</span><span class="st">","</span>) } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(ext <span class="sc">==</span> <span class="st">"-125,-66.5,24.1,49.9"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(path) <span class="sc">|&gt;</span>  <span class="co">#  |&gt; basename()</span></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [1] "PRISM_tdmean_stable_4kmD2_19920401_bil.bil"</span></span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [2] "PRISM_tdmean_stable_4kmD2_19960401_bil.bil"</span></span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [3] "PRISM_ppt_stable_4kmD2_20030401_bil.bil" </span></span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pwalk</span>(\(path){</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>        r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(path)</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>        r_bb <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(r, ply_bb, <span class="at">mask =</span> T, <span class="at">touches =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">trim</span>()</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="fu">tempdir</span>(), <span class="at">fileext =</span> <span class="st">".bil"</span>)</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dir.create</span>(<span class="fu">dirname</span>(tmp), <span class="at">recursive =</span> T, <span class="at">showWarnings =</span> F)</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">writeRaster</span>(<span class="at">x =</span> r_bb, <span class="at">filename =</span> tmp, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">writeRaster</span>(<span class="fu">rast</span>(tmp), path, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">unlist</span>(paths))</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crs</span>(r) <span class="ot">&lt;-</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>      r, r_tif, </span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">datatype =</span> <span class="st">"FLT4S"</span>,</span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">filetype =</span> <span class="st">"GTiff"</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>),</span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">overwrite =</span> T)</span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Yay: avg filesize = 0.5 MB * 365/6 (leap day) = 179 MB</span></span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(r_tif)</span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>d_r <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pd =</span> <span class="fu">names</span>(r)) <span class="sc">|&gt;</span> </span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>) ) </span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">names</span>(r)) <span class="co"># 176</span></span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a><span class="fu">plet</span>(r[[<span class="dv">100</span>]], <span class="at">tiles=</span>providers<span class="sc">$</span>CartoDB.DarkMatter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  dplyr, fs, glue, here, lubridate, purrr, sf, stringr, terra, tibble, tidyr)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>dir_daily <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/prism"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># https://services.nacse.org/prism/data/public/4km/ppt/20240512</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>vars      <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>prism_beg <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">date</span>(<span class="st">"1981-01-01"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># yesterday &lt;- lubridate::today(tzone = "UTC") - lubridate::days(1)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># accommodate up to 12 hrs to publish yesterday</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>yesterday_tz <span class="ot">&lt;-</span> <span class="st">"Etc/GMT+12"</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>yesterday <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">today</span>(<span class="at">tzone =</span> yesterday_tz) <span class="sc">-</span> lubridate<span class="sc">::</span><span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>dates_all <span class="ot">&lt;-</span> (prism_beg<span class="sc">:</span>(yesterday)) <span class="sc">|&gt;</span> <span class="fu">as.Date</span>()</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>rx_tif <span class="ot">&lt;-</span> <span class="st">"prism_daily_([0-9]{2})-([0-9]{2}).tif"</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>rx_lyr <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>d_done <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">tif_path =</span> <span class="fu">list.files</span>(dir_daily, <span class="st">".*</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="at">full.names =</span> T),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">tif  =</span> <span class="fu">basename</span>(tif_path),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">tif_md   =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(tif, rx_tif, <span class="st">"</span><span class="sc">\\</span><span class="st">1-</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">tif_mo   =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(tif, rx_tif, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">tif_day  =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(tif, rx_tif, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">lyr =</span> purrr<span class="sc">::</span><span class="fu">map</span>(tif_path, \(tif_path) terra<span class="sc">::</span><span class="fu">rast</span>(tif_path) <span class="sc">|&gt;</span> <span class="fu">names</span>() ) ) <span class="sc">|&gt;</span> </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">unnest</span>(lyr) <span class="sc">|&gt;</span> </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">lyr_var       =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx_lyr, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">lyr_stability =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx_lyr, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">lyr_date      =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx_lyr, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(tif_md, lyr_date, lyr_var) <span class="co"># order by: month-day, date, variable</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># define expected stability by date</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>early_end  <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">today</span>(<span class="at">tzone =</span> <span class="st">"UTC"</span>) <span class="sc">-</span> lubridate<span class="sc">::</span><span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>early_beg  <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">ym</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{lubridate::year(early_end)}-{lubridate::month(early_end)}"</span>))</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>prov_end   <span class="ot">&lt;-</span> early_beg <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>prov_beg   <span class="ot">&lt;-</span> early_beg <span class="sc">-</span> <span class="fu">months</span>(<span class="dv">6</span>)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>stable_end <span class="ot">&lt;-</span> prov_beg <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>stable_beg <span class="ot">&lt;-</span> prism_beg</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co"># early:       2024-05-01 to 2024-05-06 (this month)</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co"># provisional: 2023-11-01   to 2024-04-30 (previous 6 months)</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co"># stable:      1981-01-01 to 2023-10-31 (before 6 months)</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>d_todo <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">lyr_var =</span> vars <span class="sc">|&gt;</span> <span class="fu">sort</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">cross_join</span>(</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">lyr_date =</span> dates_all) <span class="sc">|&gt;</span> </span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">lyr_stability =</span> <span class="fu">cut</span>(</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>          lyr_date,</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(stable_beg, stable_end, prov_beg, prov_end, early_beg, early_end),</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"stable"</span>, <span class="st">"stable"</span>, <span class="st">"provisional"</span>, <span class="st">"provisional"</span>, <span class="st">"early"</span>),</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">include.lowest =</span> T) ) ) <span class="sc">|&gt;</span> </span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    d_done <span class="sc">|&gt;</span> </span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(lyr_date, lyr_var, lyr_stability) <span class="sc">|&gt;</span> </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(lyr_date, lyr_var, lyr_stability),</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"lyr_date"</span>, <span class="st">"lyr_var"</span>, <span class="st">"lyr_stability"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(lyr_date, lyr_var, lyr_stability)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 ppt     2024-05-07 early</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>prism_rast_parameters <span class="ot">&lt;-</span> <span class="cf">function</span>(r){</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert raster names to data frame with components</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  rx <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">idx =</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(r),</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">lyr =</span> <span class="fu">names</span>(r)) <span class="sc">|&gt;</span> </span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">var       =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">stability =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">date      =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(lyr, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>))</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>prism_get_daily <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    var, date, </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">dir_daily =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/prism"</span>),</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs_proj  =</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span>,</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">bb        =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)){</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"https://services.nacse.org/prism/data/public/4km/{var}/{format(date, '%Y%m%d')}"</span>)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>  ply_bb <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> crs_proj) <span class="sc">|&gt;</span> </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># date = as.Date("1981-01-01"); var = "tdmean"</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{dir_daily}/temp_{date}_{var}.zip"</span>)</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Downloading PRISM daily {date} {var}"</span>))</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(u, z, <span class="at">quiet =</span> T)</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If downloaded zip &lt; 1 KB, assume one of these errors:</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - You have tried to download the file PRISM_tdmean_stable_4kmD2_19810101_bil.zip more than twice in one day (Pacific local time).  Note that repeated offenses may result in your IP address being blocked.</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - Invalid date: 20240513&lt;/br&gt;Valid day ranges for the given month are 1 to 12 [real reason: requesting beyond available date, ie not yet published]</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.size</span>(z) <span class="sc">&lt;</span> <span class="dv">1000</span>)</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">readLines</span>(z, <span class="at">warn=</span>F))</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  dir_z <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_ext_remove</span>(z)</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(dir_z, <span class="at">showWarnings =</span> F)</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(z, <span class="at">exdir =</span> dir_z)</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(z)</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>  r_new <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_z, <span class="st">"PRISM_.*_bil</span><span class="sc">\\</span><span class="st">.bil$"</span>, <span class="at">full.names =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># file.exists()</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>() <span class="sc">|&gt;</span> </span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">crop</span>(ply_bb, <span class="at">mask =</span> T, <span class="at">touches =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">trim</span>()</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crs</span>(r_new) <span class="ot">&lt;-</span> crs_proj</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>  md_tif <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s/prism_daily_%02d-%02d.tif"</span>, dir_daily, <span class="fu">month</span>(date), <span class="fu">day</span>(date))</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(md_tif)){</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>        r_new, md_tif, </span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">datatype =</span> <span class="st">"FLT4S"</span>,</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>        <span class="at">filetype =</span> <span class="st">"GTiff"</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>),</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>        <span class="at">overwrite =</span> T)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir_delete</span>(dir_z)</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(T)</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>  r_md  <span class="ot">&lt;-</span> <span class="fu">rast</span>(md_tif)</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>  df_md <span class="ot">&lt;-</span> <span class="fu">prism_rast_parameters</span>(r_md)</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove old date-var, eg for stability improved</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>  i_lyr_rm <span class="ot">&lt;-</span> df_md <span class="sc">|&gt;</span> </span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>      date <span class="sc">==</span> <span class="sc">!!</span>date,</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>      var  <span class="sc">==</span> <span class="sc">!!</span>var) <span class="sc">|&gt;</span> </span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(idx)</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(i_lyr_rm) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    r_md <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">subset</span>(r_md, i_lyr_rm, <span class="at">negate =</span> T)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine old and new</span></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>  r_md <span class="ot">&lt;-</span> <span class="fu">c</span>(r_md, r_new)</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write out</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".tif"</span>)</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>    r_md, tmp,</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">datatype =</span> <span class="st">"FLT4S"</span>,</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">filetype =</span> <span class="st">"GTiff"</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>),</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> T)</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rast</span>(tmp), md_tif, </span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">datatype =</span> <span class="st">"FLT4S"</span>,</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">filetype =</span> <span class="st">"GTiff"</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>),</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> T)</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>  fs<span class="sc">::</span><span class="fu">dir_delete</span>(dir_z)</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmp)</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>msg <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>(d_todo) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Summary: {nrow(d_todo)} variable-dates {paste(range(d_todo$lyr_date), collapse=' to ')} to download and crop "</span>),</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Summary: up to date as of yesterday ({yesterday_tz}): {yesterday}"</span>))</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(msg)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>d_todo <span class="sc">|&gt;</span> </span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">var =</span> lyr_var, <span class="at">date =</span> lyr_date) <span class="sc">|&gt;</span> </span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pwalk</span>(prism_get_daily)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code># early:       2024-05-01 to 2024-05-06
# provisional: 2023-11-01   to 2024-04-30
# stable:      1981-01-01 to 2023-10-31
# https://prism.nacse.org/documents/PRISM_downloads_web_service.pdf
# PRISM_&lt;var&gt;_&lt;stability&gt;_&lt;scale&amp;version&gt;_&lt;time period&gt;[_all|_annual]_bil.zip
# https://services.nacse.org/prism/data/public/4km/&lt;element&gt;/&lt;date&gt;&lt;?format=[nc|asc|grib2]&gt;
# https://services.nacse.org/prism/data/public/4km/tmin/20090405
# https://prism.oregonstate.edu/documents/PRISM_update_schedule.pdf

# dates &lt;- gen_dates(minDate = minDate, maxDate = maxDate, dates = dates)
dates &lt;- date("2024-05-12")
# prism:::prism_vars() |&gt; sort()
service &lt;- "http://services.nacse.org/prism/data/public/4km"
type = "ppt"
uri_dates &lt;- gsub(pattern = "-",replacement = "",dates)
# uris &lt;- prism:::gen_prism_url(uri_dates, type, service)
uris &lt;- paste(service, type, dates, sep = "/")
# "http://services.nacse.org/prism/data/public/4km/ppt/2024-05-12"

x &lt;- httr::HEAD(uris[1])
fn &lt;- x$headers$`content-disposition`
fn &lt;- regmatches(fn,regexpr('\\"[a-zA-Z0-9_\\.]+',fn))
fn &lt;- substr(fn,2,nchar((fn)))
fn &lt;- gsub("provisional|early", "stable", fn)
file_names &lt;- stringr::str_replace(
  fn, 
  "[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]", 
  uri_dates
)
to_download_lgl &lt;- prism_check(file_names, lgl = TRUE)
uris &lt;- uris[to_download_lgl]

get_prism_dailys &lt;- function(type, minDate = NULL, maxDate =  NULL, 
                             dates = NULL, keepZip = TRUE, check = "httr",
                             service = NULL)</code></pre>
<p><a href="https://prism.oregonstate.edu/documents/PRISM_datasets.pdf">PRISM datasets</a>:</p>
<blockquote class="blockquote">
<p>AN - Daily Time Series (AN81d/AN91d) Climate elements: tmin, tmax, tmean (derived), tdmean, ppt, vpdmin, vpdmax Units and scaling: tmin, tmax, tmean, tdmean (deg C); ppt (mm); vpdmin, vpdmax (hPa); all values are floating point Description: Daily dataset covering the conterminous US, starting on 1 January 1981 and ending yesterday.</p>
</blockquote>
<p><a href="https://prism.oregonstate.edu/documents/PRISM_update_schedule.pdf">PRISM_update_schedule</a>:</p>
<ol type="1">
<li><p>asdf &gt; The PRISM map sequence is first updated to include a particular day about 24 hours after it has ended (Grid Count = 1). &gt; Note that a “PRISM Day” is defined as the 24-hour period ending at 1200 UTC on that day, e.g., a grid for July 2 covers the period 1200 UTC July 1 – 1200 UTC July 2</p></li>
<li><p>asdf &gt; A second update (Grid Count = 2) is made after five days have elapsed; the five-day milestone was chosen because a large amount of new station data is typically received at this point.</p></li>
<li></li>
</ol>
<blockquote class="blockquote">
<p>The third update (Grid Count = 3) is produced during what is termed the “monthly update,” which is typically completed on about the 15th of the following month.</p>
</blockquote>
</section>
<section id="map-swipe-yesterday-vs-climatology" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="map-swipe-yesterday-vs-climatology"><span class="header-section-number">2.6</span> Map Swipe Yesterday vs Climatology</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>var <span class="ot">=</span> <span class="st">"tmax"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)  <span class="co"># yesterday</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>yrs <span class="ot">&lt;-</span> <span class="dv">1981</span><span class="sc">:</span>(<span class="dv">1981</span><span class="sc">+</span><span class="dv">20</span>) <span class="co"># 20 yr climatology</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%d-%02d-%02d"</span>, yrs, <span class="fu">month</span>(date), <span class="fu">day</span>(date))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(var, <span class="st">"daily"</span>, <span class="at">dates =</span> dates)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># web mercator for use with slippy maps</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>proj4_3857 <span class="ot">&lt;-</span> <span class="st">"+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs +type=crs"</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>r_c <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pds) <span class="sc">|&gt;</span> </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">projectRaster</span>(<span class="at">crs =</span> proj4_3857) <span class="sc">|&gt;</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="at">na.rm=</span>T)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_c) <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{var}_historical"</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(r_c)</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># get_prism_dailys(type = var, dates = date, keepZip = F)</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># prism_archive_clean(var, "daily", dates = date)</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co"># prism_archive_crop(var, "daily", dates = date)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(var, <span class="st">"daily"</span>, <span class="at">dates =</span> date)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>r_d <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pd) <span class="sc">|&gt;</span> </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">projectRaster</span>(<span class="at">crs =</span> proj4_3857) <span class="sc">|&gt;</span> </span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_d) <span class="ot">&lt;-</span> var</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(r_d)</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># plet(r_d, tiles=providers$Esri.OceanBasemap)</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">values</span>(r_c, <span class="at">na.rm=</span>T), <span class="fu">values</span>(r_d, <span class="at">na.rm=</span>T))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorNumeric</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spectral"</span>, vals, <span class="at">reverse =</span> T, <span class="at">na.color =</span> <span class="st">"transparent"</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># leaflet() |&gt; </span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   addProviderTiles(</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     providers$Stadia.StamenTonerLite) |&gt; </span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   addRasterImage(</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     # r_c, colors = pal, opacity = 0.8, project = F) |&gt; </span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     r_d, colors = pal, opacity = 0.8, project = F) |&gt; </span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co">#   addLegend(</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     pal = pal, values = vals, title = var)</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMapPane</span>(<span class="st">"left"</span>,  <span class="at">zIndex =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMapPane</span>(<span class="st">"right"</span>, <span class="at">zIndex =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.DarkMatter,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">"left"</span>),</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">group   =</span> <span class="st">"base"</span>, </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"base_l"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.DarkMatter,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">"right"</span>),</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">group   =</span> <span class="st">"base"</span>, </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"base_r"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    r_c, <span class="at">colors =</span> pal, <span class="at">opacity =</span> <span class="fl">0.8</span>, <span class="at">project =</span> F,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">pane =</span> <span class="st">"left"</span>),</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"r_c"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    r_d, <span class="at">colors =</span> pal, <span class="at">opacity =</span> <span class="fl">0.8</span>, <span class="at">project =</span> F,</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">pane =</span> <span class="st">"right"</span>),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"r_d"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLayersControl</span>(<span class="at">overlayGroups =</span> <span class="fu">c</span>(<span class="st">"r_c"</span>, <span class="st">"r_d"</span>)) <span class="sc">|&gt;</span>  </span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addSidebyside</span>(</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"sidecontrols"</span>,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">leftId  =</span> <span class="st">"base_l"</span>,</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">rightId =</span> <span class="st">"base_r"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addControl</span>(</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">HTML</span>(<span class="fu">glue</span>(</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&lt;b&gt;Historical&lt;/b&gt;&lt;br&gt;</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="st">      ({paste(range(yrs), collapse = '-')})-{str_pad(month(date),2,pad='0')}-{str_pad(day(date),2,pad='0')}"</span>)), </span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"topleft"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addControl</span>(</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">HTML</span>(<span class="fu">glue</span>(</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&lt;b&gt;Yesterday&lt;/b&gt;&lt;br&gt;</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="st">      {date}"</span>)), </span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"topright"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># leaflet() |&gt; </span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># addTiles() |&gt; </span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tbeptools<span class="sc">::</span>tbsegshed, </span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"white"</span>, <span class="at">weight =</span> <span class="dv">2</span>, <span class="at">fillOpacity=</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapview::mapView()</span></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">pal =</span> pal, <span class="at">values =</span> vals, <span class="at">title =</span> var)</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>d_c <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>  r_c,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>  tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">exact =</span> T, <span class="at">touches =</span> T, <span class="at">method =</span> <span class="st">"bilinear"</span>,</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">bind =</span> T,</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>  mean, <span class="at">na.rm=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>d_d <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>  r_d,</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>  tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">exact =</span> T, <span class="at">touches =</span> T, <span class="at">method =</span> <span class="st">"bilinear"</span>,</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">bind =</span> T,</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>  mean, <span class="at">na.rm=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d_c <span class="sc">|&gt;</span> </span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>    d_d,</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"long_name"</span>, <span class="st">"bay_segment"</span>))</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>options(repos=c(CRAN=“https://cran.rstudio.com/”)); renv::snapshot()</p>
<section id="dewpoint-to-humidity" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="dewpoint-to-humidity"><span class="header-section-number">2.6.1</span> Dewpoint to Humidity</h3>
<ul>
<li><a href="https://opensnow.com/news/post/what-is-the-dewpoint-how-is-it-related-to-the-relative-humidity-heat-index">What is the Dewpoint &amp; How is it Related to Relative Humidity &amp; Heat Index? | OpenSnow</a><br>
Once the dewpoint reaches above 55 degrees Fahrenheit (°F), the air becomes sticky and can be described as ‘muggy’ above 65°F. If the dewpoint reaches above 75°F, the air can often be described as ‘oppressive’…<br>
The relative humidity is expressed in a percent (0-100%) and is the ratio of the amount of atmospheric moisture present relative to the amount that would be present if the air were saturated. What this means is that the relative humidity is <strong>dependent on both the dewpoint and the air temperature.</strong></li>
<li><a href="https://www.wpc.ncep.noaa.gov/html/heatindex.shtml">Heat Index Calculation</a>
<ul>
<li><a href="https://www.wpc.ncep.noaa.gov/html/heatindex_equation.shtml">Heat Index Equation</a></li>
<li><a href="https://brownmath.com/bsci/notheat.htm#DewpointBackward">It’s Not the Heat&nbsp;…</a><br>
Suppose you know the current temperature and the dew point. Can you get the relative humidity from them? Absolutely!</li>
<li><a href="https://w2.weather.gov/arx/heat_index">Heat Index | NWS</a></li>
<li>Lawrence (2005) <a href="https://journals.ametsoc.org/view/journals/bams/86/2/bams-86-2-225.xml">The Relationship between Relative Humidity and the Dewpoint Temperature in Moist Air: A Simple Conversion and Applications</a> <em>Bulletin of the American Meteorological Society</em></li>
<li><a href="https://meteor.geol.iastate.edu/~ckarsten/bufkit/apparent_temperature.html">What is Apparent Temperature?</a></li>
</ul></li>
</ul>
<p>TODO: - [ ] summarize by tbeptools::tbsegshed, zip code - [ ] compare these precip data w/ Water District data to make case for using PRISM data</p>
<p>Questions:</p>
<ol type="1">
<li>Given variability within each polygon, which of these products shall we use to plot: min(min_temp), mean(mean_temp), max(max_temp); min(mean_temp), mean(mean_temp), max(max_temp)?</li>
</ol>
</section>
<section id="communicating-results" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="communicating-results"><span class="header-section-number">2.6.2</span> Communicating results</h3>
<ul>
<li>Choi et al.&nbsp;(2024) <a href="https://journals.ametsoc.org/view/journals/clim/aop/JCLI-D-23-0346.1/JCLI-D-23-0346.1.xml">North-South disparity in impact of climate change on “outdoor days”</a>. <em>Journal of Climate</em>
<ul>
<li>news summary: <a href="https://news.mit.edu/2024/new-way-quantify-climate-change-impacts-outdoor-days-0322">A new way to quantify climate change impacts: “Outdoor days” | MIT News | Massachusetts Institute of Technology</a></li>
<li>Shiny app: <a href="https://eltahir.mit.edu/california-outdoor-days/">California Outdoor Days | Eltahir Research Group</a></li>
</ul></li>
</ul>
</section>
</section>
<section id="sea" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="sea"><span class="header-section-number">2.7</span> Sea</h2>
<section id="sea-level" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="sea-level"><span class="header-section-number">2.7.1</span> Sea Level</h3>
<p>Sea level rise occurs from principally two sources: 1) thermal expansion; and 2) freshwater inputs from glacial melting. Data for these trends can be obtained from NOAA’s <a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends.html">Sea Level Trends</a> (<a href="#fig-slr-noaa" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>)</p>
<p>Types of data:</p>
<ol type="1">
<li>Observed (past, present) - tide gauge - satellite, e.g.&nbsp;<a href="https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/">Laboratory for Satellite Altimetry / Sea Level Rise</a>
<ul>
<li>Level-3 products distributed through NOAA CoastWatch (Sea Level Anomaly and along-track altimetry)</li>
</ul></li>
<li>Projected (future). modeled</li>
</ol>
<section id="gauges" class="level4" data-number="2.7.1.1">
<h4 data-number="2.7.1.1" class="anchored" data-anchor-id="gauges"><span class="header-section-number">2.7.1.1</span> Gauges</h4>
<div id="fig-slr-noaa" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-slr-noaa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/slr_tidesandcurrents.noaa.gov-sltrends.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" data-glightbox="description: .lightbox-desc-1"><img src="figures/slr_tidesandcurrents.noaa.gov-sltrends.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-slr-noaa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: Screenshot of NOAA’s <a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends.html">Sea Level Trends</a> zoomed into the Tampa Bay.
</figcaption>
</figure>
</div>
<p>https://tidesandcurrents.noaa.gov/sltrends/</p>
<ul>
<li><p><a href="https://tidesandcurrents.noaa.gov/ports/index.html?port=tb">PORTS: Tampa Bay PORTS - NOAA Tides &amp; Currents</a></p></li>
<li><p><a href="https://api.tidesandcurrents.noaa.gov/api/prod/">api.tidesandcurrents.noaa.gov</a></p></li>
<li><p><a href="https://api.tidesandcurrents.noaa.gov/api/prod/">CO-OPS Data Retrieval API</a></p></li>
<li><p><a href="https://api.tidesandcurrents.noaa.gov/mdapi/prod/">CO-OPS Metadata API v1.0</a></p></li>
</ul>
<p>https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/id.extension https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724.json https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724/details.json - “established”: “1973-04-19 00:00:00.0” - “origyear”: “1995-07-27 23:00:00.0” https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724/products.json - “name”: “Water Levels”, - “value”: “https://tidesandcurrents.noaa.gov/waterlevels.html?id=8726724”</p>
<p>https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?id=8726724 https://tidesandcurrents.noaa.gov/sltrends/data/8726724_meantrend.csv</p>
<p><a href="https://tidesandcurrents.noaa.gov/inundationdb/inundation.html?id=8726724#flooddays">Inundation History - NOAA Tides &amp; Currents</a></p>
<ul>
<li><a href="https://tidesandcurrents.noaa.gov/sltrends/faq.html#:~:text=Relative%20Sea%20Level%20Trends%20reflect%20changes,stations%2C%20called%20monthly%20mean%20sea%20level.">FAQ for Sea Level Trends | NOAA Tides &amp; Currents</a> &gt; <strong>Relative Sea Level Trends</strong> reflect changes in local sea level over time and are typically the most critical sea level trend for many coastal applications, including coastal mapping, marine boundary delineation, coastal zone management, coastal engineering, sustainable habitat restoration design, and the general public enjoying their favorite beach. This website focuses on relative sea level trends, computed from monthly averages of hourly water levels observed at specific tide stations, called <strong>monthly mean sea level</strong>.</li>
</ul>
<p>See <code>tbeptools</code> additions:</p>
<ul>
<li><p><a href="https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/sealevelstations.R">sealevelstations.R</a></p></li>
<li><p><a href="https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/read_importsealevels.R">read_importsealevels.R</a></p></li>
<li><p><a href="https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/vignettes/sealevels.Rmd">sealevels.Rmd</a></p></li>
<li><p><a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends.html">Sea Level Trends - NOAA Tides &amp; Currents</a></p></li>
</ul>
<ol type="1">
<li>Clearwater Beach, FL<br>
<code>8726724</code><br>
The relative sea level trend is 4.33 mm/year with a 95% confidence interval of +/- 0.52 mm/year based on monthly mean sea level data from 1973 to 2023 which is equivalent to a change of 1.42 feet in 100 years.</li>
</ol>
<ul>
<li><a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?id=8726724">Relative Sea Level Trend</a></li>
<li><a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=scenario&amp;id=8726724">Annual Mean Relative Sea Level</a></li>
<li><a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=intannvar&amp;id=8726724">Interannual Variation</a></li>
<li><a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=seasonal&amp;id=8726724">Average Seasonal Cycle</a></li>
<li><a href="https://earthengine.google.com/timelapse/#v=27.978,-82.832,12,latLng&amp;t-3">Timelapse – Google Earth Engine</a></li>
</ul>
<ol type="1">
<li>East Bay, FL<br>
<code>8726674</code><br>
The relative sea level trend is 5.8 mm/year with a 95% confidence interval of +/- 0.85 mm/year based on monthly mean sea level data from 1976 to 2023 which is equivalent to a change of 1.90 feet in 100 years.</li>
<li>Port Manatee, FL<br>
<code>8726384</code><br>
The relative sea level trend is 5.5 mm/year with a 95% confidence interval of +/- 0.68 mm/year based on monthly mean sea level data from 1976 to 2023 which is equivalent to a change of 1.80 feet in 100 years.</li>
<li>St.&nbsp;Petersburg, FL<br>
<code>8726520</code><br>
The relative sea level trend is 3.09 mm/year with a 95% confidence interval of +/- 0.23 mm/year based on monthly mean sea level data from 1947 to 2023 which is equivalent to a change of 1.01 feet in 100 years.</li>
</ol>
<ul>
<li><a href="https://tidesandcurrents.noaa.gov/inundationdb/">Inundation Dashboard - NOAA Tides &amp; Currents</a></li>
</ul>
</section>
</section>
<section id="surface-temperature" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="surface-temperature"><span class="header-section-number">2.7.2</span> Surface Temperature</h3>
<ul>
<li><p>coral reefs: ecosystem health, ecotourism</p></li>
<li><p>fisheries</p></li>
<li><p>energy for hurricanes</p></li>
<li><p>background: <a href="https://coralreefwatch.noaa.gov/product/5km/tutorial/crw05a_sst_product.php">NOAA Coral Reef Watch Tutorial</a></p>
<ul>
<li><a href="https://coastwatch.noaa.gov/erddap/griddap/noaacrwsstDaily.html">ERDDAP - Sea Surface Temperature, NOAA Coral Reef Watch Daily Global 5km Satellite SST (CoralTemp), 1985-present, Daily - Data Access Form</a></li>
</ul></li>
</ul>
<p>Output is stored in a single raster file containing about a little over 13K layers, which seems to read and render reasonably fast (whereas for the more numerous PRISM layers, it was way too slow).</p>
<ul>
<li><p><a href="https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation.html">Basic Detection and Visualisation of Events • heatwaveR</a></p>
<p><a href="https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example1-1.png" class="img-fluid"></a></p>
<p><a href="https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example5-1.png" class="img-fluid"></a></p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  sf, tbeptools, mapview)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>tbshed_buf <span class="ot">&lt;-</span> tbshed <span class="sc">|&gt;</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="dv">10000</span>) <span class="sc">|&gt;</span> <span class="co"># buffer by 10 km</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># st_bbox(tbshed_buf) |&gt; round(1)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  xmin  ymin  xmax  ymax </span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># -83.0  27.3 -81.8  28.5</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># after clipping to non-NA raster values</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>bbox <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.0</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">82.3</span>, <span class="at">ymax=</span> <span class="fl">28.5</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>sst_bbox <span class="ot">&lt;-</span> bbox <span class="sc">|&gt;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="st">"+proj=longlat +datum=WGS84 +no_defs"</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(tbsegshed, <span class="at">col.regions=</span><span class="st">"gray"</span>) <span class="sc">+</span> </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapView</span>(tbshed_buf, <span class="at">col.regions =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapView</span>(sst_bbox, <span class="at">col.regions =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  marinebon<span class="sc">/</span>extractr,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  here)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ed_extract</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ed        =</span> <span class="fu">ed_info</span>(<span class="st">"https://coastwatch.noaa.gov/erddap/griddap/noaacrwsstDaily.html"</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">var       =</span> <span class="st">"analysed_sst"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bbox      =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.0</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">82.3</span>, <span class="at">ymax=</span> <span class="fl">28.5</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">aoi       =</span> tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> <span class="fu">here</span>(<span class="st">"data/sst/tbep_sst.csv"</span>),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rast_tif  =</span> <span class="fu">here</span>(<span class="st">"data/sst/tbep_sst.tif"</span>),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">mask_tif =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  ggplot2, here, highcharter, lubridate, plotly, readr)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data("mpg", "diamonds", "economics_long", package = "ggplot2")</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># economics_long2 &lt;- dplyr::filter(economics_long, variable %in% c("pop", "uempmed", "unemploy"))</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># hchart(economics_long2, "line", hcaes(x = date, y = value01, group = variable))</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>sst_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/sst/tb_sst.csv"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>d_sst   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(sst_csv, <span class="at">show_col_types =</span> F)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_sst<span class="sc">$</span>bay_segment)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   BCB    HB   LTB    MR   MTB   OTB   TCB </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 13169 13169 13169 13169 13169 13169 13169 </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>bay_segment <span class="ot">&lt;-</span> <span class="st">"BCB"</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d_sst <span class="sc">|&gt;</span> </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bay_segment <span class="sc">==</span> <span class="sc">!!</span>bay_segment) <span class="sc">|&gt;</span> </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">year  =</span> <span class="fu">year</span>(time),</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># yday  = yday(time),</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">sprintf</span>(</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">"%d-%02d-%02d"</span>, </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">year</span>(<span class="fu">today</span>()), <span class="fu">month</span>(time), <span class="fu">day</span>(time) ) <span class="sc">|&gt;</span> </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.POSIXct</span>(),</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">==</span> <span class="fu">year</span>(<span class="fu">today</span>())     <span class="sc">~</span> <span class="st">"red"</span>,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">==</span> <span class="fu">year</span>(<span class="fu">today</span>()) <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="st">"gray"</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(year, yday, date, color, val) |&gt; </span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># arrange(year, yday, date, val)</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, year, date, color, val) <span class="sc">|&gt;</span> </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, date, val)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d$yday) |&gt; range()</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>yrs    <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(d<span class="sc">$</span>year))</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(<span class="st">"darkgray"</span>, <span class="fu">length</span>(yrs)), yrs)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>colors[<span class="fu">as.character</span>(<span class="fu">year</span>(<span class="fu">today</span>()))]     <span class="ot">&lt;-</span> <span class="st">"red"</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>colors[<span class="fu">as.character</span>(<span class="fu">year</span>(<span class="fu">today</span>()) <span class="sc">-</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  slider, scales)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span> </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">val_sl =</span> slider<span class="sc">::</span><span class="fu">slide_mean</span>(</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>      val, <span class="at">before =</span> <span class="dv">3</span>L, <span class="at">after =</span> <span class="dv">3</span>L, <span class="at">step =</span> <span class="dv">1</span>L, </span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">complete =</span> F, <span class="at">na_rm =</span> T),</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">txt_date =</span> <span class="fu">as.Date</span>(time),</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">txt_val  =</span> <span class="fu">round</span>(val_sl, <span class="dv">2</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">|&gt;</span> </span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: darkly theme w/ bslib</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>  d,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> date, </span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> val_sl,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> year,</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(year),</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> txt_date,</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> txt_val)) <span class="sc">+</span>  <span class="co"># frame = yday</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># aes(text  = text),</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> colors) <span class="sc">+</span> </span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">date_format</span>(<span class="st">"%b %d"</span>)) <span class="sc">+</span> </span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day of year"</span>,</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Temperature ºC"</span>)</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>g</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a><span class="co"># x, y, alpha, color, group, linetype, size</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="co"># add color theming</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rstudio.github.io/thematic/articles/auto.html</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(g, <span class="at">tooltip=</span><span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"value"</span>))</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="co"># https://plotly-r.com/scatter-traces 3</span></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a><span class="co"># https://plotly-r.com/client-side-linking 16</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/76435688/how-to-autoplay-a-plotly-chart-in-shiny</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> <span class="sc">~</span>date,</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="sc">~</span>val,</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span>yday,</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># group = ~year,</span></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># color = ~color,</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">type  =</span> <span class="st">'scatter'</span>, </span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode  =</span> <span class="st">'lines'</span>,</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># marker = list(size = 20),</span></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">showlegend =</span> F,</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">transforms =</span> <span class="fu">list</span>(</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">'groupby'</span>,</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">groups =</span> d<span class="sc">$</span>year,</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">styles =</span> <span class="fu">list</span>(</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2024</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'red'</span>))),</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2023</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'orange'</span>))),</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2022</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'darkgray'</span>))) ) ) ) )</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_button</span>(<span class="at">visible =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a><span class="st">    function(el,x) {</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a><span class="st">      Plotly.animate(el);</span></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a><span class="st">    }"</span>)</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmlwidgets)</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), </span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), </span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span>x,</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span>y,</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span>f,</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">'scatter'</span>,</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">'markers'</span>,</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">showlegend =</span> <span class="cn">FALSE</span></span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_button</span>(<span class="at">visible =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a><span class="st">        function(el,x) {</span></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a><span class="st">          Plotly.animate(el);</span></span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a><span class="st">        }"</span>)</span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/61152879/change-the-frame-label-in-plotly-animation</span></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1980</span>L, <span class="dv">2020</span>L), <span class="at">each =</span> <span class="dv">12</span>), </span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="dv">41</span>), </span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">month_char =</span> <span class="fu">rep</span>(<span class="fu">factor</span>(month.abb), <span class="dv">41</span>),</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_depth =</span> <span class="fu">runif</span>(<span class="dv">492</span>) )</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a><span class="co"># with(DF, paste0(sprintf("%02d", month), " - ", month_char) )</span></span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> DF <span class="sc">|&gt;</span> </span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span>year, </span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span>avg_depth,</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span><span class="fu">paste0</span>(<span class="fu">sprintf</span>(<span class="st">"%02d"</span>, month), <span class="st">" - "</span>, month_char),</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">'bar'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_slider</span>(</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">currentvalue =</span> <span class="fu">list</span>(<span class="at">prefix =</span> <span class="st">"Month: "</span>) )</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/50843134/r-plotly-animated-chart-only-showing-groups-with-data-in-initial-frame</span></span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2010</span></span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a>countries <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"US"</span>, <span class="st">"GB"</span>, <span class="st">"JP"</span>)</span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dates, countries, <span class="at">all=</span><span class="cn">TRUE</span>)</span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"Country"</span>)</span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df))</span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df))</span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">frame =</span> Date)) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(p)</span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a><span class="co"># other</span></span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>  d,</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> date, </span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> val, </span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(year))) <span class="sc">+</span></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> colors) <span class="sc">+</span> </span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>g</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplotly</span>(g) <span class="sc">|&gt;</span> </span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a><span class="st">    function(el,x) {</span></span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a><span class="st">      Plotly.animate(el);</span></span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a><span class="st">    }"</span>)</span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hchart</span>(</span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>    <span class="st">"line"</span>, <span class="co"># "line"</span></span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hcaes</span>(</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a>      <span class="at">x            =</span> date, </span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>      <span class="at">y            =</span> val, </span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a>      <span class="at">group        =</span> year,</span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a>      <span class="at">segmentColor =</span> clr),</span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">showInLegend =</span> F)</span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a>mpgman2 <span class="ot">&lt;-</span> <span class="fu">count</span>(mpg, manufacturer, year)</span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a><span class="fu">hchart</span>(</span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a>  mpgman2, </span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bar"</span>,</span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcaes</span>(<span class="at">x =</span> manufacturer, <span class="at">y =</span> n, <span class="at">group =</span> year),</span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"#7CB5EC"</span>, <span class="st">"#F7A35C"</span>),</span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Year 1999"</span>, <span class="st">"Year 2008"</span>),</span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">showInLegend =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>) <span class="co"># only show the first one in the legend</span></span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="acidification" class="level3" data-number="2.7.3">
<h3 data-number="2.7.3" class="anchored" data-anchor-id="acidification"><span class="header-section-number">2.7.3</span> Acidification</h3>
</section>
</section>
<section id="extreme-weather" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="extreme-weather"><span class="header-section-number">2.8</span> Extreme Weather</h2>
<p>Or “Severe Weather”</p>
<ul>
<li><a href="https://docs.ropensci.org/rnoaa/articles/swdi_vignette.html">SWDI vignette • rnoaa</a></li>
</ul>
<section id="hurricanes" class="level3" data-number="2.8.1">
<h3 data-number="2.8.1" class="anchored" data-anchor-id="hurricanes"><span class="header-section-number">2.8.1</span> Hurricanes</h3>
<ul>
<li>property damage</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rnoaa<span class="sc">::</span><span class="fu">coops_search</span>()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># swdi - Severe Weather Data Inventory (SWDI) vignette</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="floods" class="level3" data-number="2.8.2">
<h3 data-number="2.8.2" class="anchored" data-anchor-id="floods"><span class="header-section-number">2.8.2</span> Floods</h3>
</section>
</section>
<section id="old" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="old"><span class="header-section-number">2.9</span> OLD</h2>
<section id="satellite-1" class="level3" data-number="2.9.1">
<h3 data-number="2.9.1" class="anchored" data-anchor-id="satellite-1"><span class="header-section-number">2.9.1</span> Satellite</h3>
<ul>
<li><a href="https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/LSA_SLR_maps.php">NOAA / NESDIS / STAR - Laboratory for Satellite Altimetry / Sea Level Rise</a></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>slr_nc    <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/slr/slr_map_txj1j2.nc"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>r_slr_gcs <span class="ot">&lt;-</span> <span class="fu">rast</span>(slr_nc)  <span class="co"># 0.5 degree resolution</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>r_slr_mer <span class="ot">&lt;-</span> <span class="fu">projectRasterForLeaflet</span>(r_slr_gcs, <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbsegshed)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>r_slr_tb_mer <span class="ot">&lt;-</span> <span class="fu">rast</span>(slr_nc) <span class="sc">|&gt;</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crop</span>(b) <span class="co"># |&gt; </span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># projectRasterForLeaflet(method="bilinear")</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># only one value for Tampa Bay extracted at 0.5 degree resolution</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># values(r_slr_tb_mer, mat=F, na.rm=T)  # 5.368306</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbshed)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plet</span>(r_slr_mer, <span class="at">tiles=</span>providers<span class="sc">$</span>Esri.OceanBasemap) <span class="sc">|&gt;</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>CartoDB.DarkMatterOnlyLabels) <span class="sc">|&gt;</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> tbsegshed) <span class="sc">|&gt;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fitBounds</span>(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">lng1 =</span> b[[<span class="st">"xmin"</span>]], <span class="at">lat1 =</span> b[[<span class="st">"ymin"</span>]], </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">lng2 =</span> b[[<span class="st">"xmax"</span>]], <span class="at">lat2 =</span> b[[<span class="st">"ymax"</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">Figure&nbsp;2.1: Screenshot of NOAA’s <a href="https://tidesandcurrents.noaa.gov/sltrends/sltrends.html">Sea Level Trends</a> zoomed into the Tampa Bay.</span>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./intro.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb22" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> html_document</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>Themes for indicators seeking relevance to:</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Air &amp; Sea</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>People &amp; Ecosystems</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>Icons</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Bootstrap</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">water</span><span class="co">](https://icons.getbootstrap.com/icons/water/)</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">thermometer</span><span class="co">](https://icons.getbootstrap.com/icons/thermometer/)</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">moisture</span><span class="co">](https://icons.getbootstrap.com/icons/moisture/)</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">thermometer-sun</span><span class="co">](https://icons.getbootstrap.com/icons/thermometer-sun/)</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">cloud-rain-heavy-fill</span><span class="co">](https://icons.getbootstrap.com/icons/cloud-rain-heavy-fill/)</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">tornado</span><span class="co">](https://icons.getbootstrap.com/icons/tornado/)</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fontawesome</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">water-rise</span><span class="co">](https://fontawesome.com/v5/icons/water-rise?f=classic&amp;s=solid)</span> PRO</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Task 1. Assessment of available data and coverage</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>Data descriptive of the risks of climate change can be obtained from several sources. These may include weather or climatological data, long-term tidal gauge data, or in situ water measurements responsive to climate change. Weather and climatological data could be obtained from local weather stations with long-term data, e.g., Tampa International Airport, and could include measures of air temperature, precipitation, and/or storm intensity/frequency. Tidal gauge data are readily available from the NOAA PORTS data retrieval system. Lastly, in situ water measurements could include water temperature, changes in flow hydrology, salinity, and/or pH. Data used to evaluate potential risks related to ocean acidification should also be explored.</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>The permanency and ease of access of each data source should be noted when making recommendations on indicators to operationalize. Further, indicators that communicate the risks associated with climate change are preferred, as opposed to those that simply indicate change. An example is the number of days in a year when temperature exceeds a critical threshold, as compared to temperature alone. An additional example is frequency of sunny day flooding events, as compared to tidal gauge measurements alone.</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co"># turn off all chunks by default</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co"># options(repos=c(CRAN="https://cran.mirror.garr.it/CRAN/"))</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(c("sf","terra"), type = "binary")</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::snapshot()</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::clean()</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::rebuild()</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="co"># built from source: sp, survival, rnoaa, tbeptools</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="st">"librarian"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"librarian"</span>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  dplyr, dygraphs, glue, here, htmltools, leaflet, leaflet.extras2, lubridate, </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  sf, stringr, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools, prism, purrr,</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  RColorBrewer, readr, rnoaa, terra, tidyr, webshot2,</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="co"># explicitly list packages for renv::dependencies(); renv::snapshot()</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dygraphs)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(librarian)</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnoaa)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tbeptools)</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(webshot2)</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Air</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>noaacrwsstDaily</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="fu">### Observed</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">`rnoaa`</span><span class="co">](https://docs.ropensci.org/rnoaa/)</span> R package uses NOAA NCDC API v2, which only goes to 2022-09-15.</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">NCEI Web Services \| Climate Data Online (CDO) \| National Center for Environmental Information (NCEI)</span><span class="co">](https://www.ncdc.noaa.gov/cdo-web/webservices)</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Data Tools \| Climate Data Online (CDO) \| National Climatic Data Center (NCDC)</span><span class="co">](https://www.ncdc.noaa.gov/cdo-web/datatools)</span></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Weather stations</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Tampa International Airport</span><span class="co">](https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USW00012842/detail)</span></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Start Date: 1939-02-01</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>End Date: today - 3 days</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>Got token at <span class="co">[</span><span class="ot">ncdc.noaa.gov/cdo-web/token</span><span class="co">](https://www.ncdc.noaa.gov/cdo-web/token)</span>. Added variable <span class="in">`NOAA_NCDC_CDO_token`</span> to:</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>locally:</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>    <span class="in">``` r</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.edit</span>(<span class="st">"~/.Renviron"</span>)</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>    <span class="in">```</span></span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>on GitHub: Repository secrets in <span class="co">[</span><span class="ot">Actions secrets · tbep-tech/climate-change-indicators</span><span class="co">](https://github.com/tbep-tech/climate-change-indicators/settings/secrets/actions)</span></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">GCHN readme</span><span class="co">](https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt)</span></span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`PRCP`</span>: Precipitation (tenths of mm)</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`TMAX`</span>: Maximum temperature (tenths of degrees C)</span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`TMIN`</span>: Minimum temperature (tenths of degrees C)</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-weather-station</span></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a><span class="co"># provide NOAA key</span></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">noaakey =</span> <span class="fu">Sys.getenv</span>(<span class="st">"NOAA_NCDC_CDO_token"</span>))</span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify datasetid and station</span></span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>stn          <span class="ot">&lt;-</span> <span class="st">"GHCND:USW00012842"</span> <span class="co"># TAMPA INTERNATIONAL AIRPORT, FL US</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a>stn_csv      <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/tpa_ghcnd.csv"</span>)</span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a>stn_meta_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/tpa_meta.csv"</span>)</span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(stn_meta_csv)){</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cache station metadata since timeout from Github Actions</span></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a>  stn_meta <span class="ot">&lt;-</span> <span class="fu">ncdc_stations</span>(</span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetid =</span> <span class="st">"GHCND"</span>, </span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">stationid =</span> stn)</span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(stn_meta<span class="sc">$</span>data, stn_meta_csv)</span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(stn_meta_csv)</span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(stn_csv)){</span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a>  date_beg <span class="ot">&lt;-</span> stn_meta<span class="sc">$</span>data<span class="sc">$</span>mindate</span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>  date_end <span class="ot">&lt;-</span> stn_meta<span class="sc">$</span>data<span class="sc">$</span>maxdate</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a>  max_rows <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a>  vars     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PRCP"</span>,<span class="st">"TMIN"</span>,<span class="st">"TMAX"</span>)</span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a>  n_vars     <span class="ot">&lt;-</span> <span class="fu">length</span>(vars)</span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a>  days_batch <span class="ot">&lt;-</span> <span class="fu">floor</span>(max_rows <span class="sc">/</span> n_vars)</span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a>  dates <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(</span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ymd</span>(date_beg), </span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ymd</span>(date_end), </span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">glue</span>(<span class="st">"{days_batch} days"</span>)),</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ymd</span>(date_end)))</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a>  n_i <span class="ot">&lt;-</span> <span class="fu">length</span>(dates) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_i){</span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for (i in 14:n_i){</span></span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a>    date_beg <span class="ot">&lt;-</span> dates[i]</span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> n_i){</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> dates[i<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> dates[i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">glue</span>(<span class="st">"{i} of {n_i}: {date_beg} to {date_end}  ~  {Sys.time()}"</span>))</span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># retry if get Error: Service Unavailable (HTTP 503)</span></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a>    o           <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a>    attempt     <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a>    attempt_max <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="fu">is.null</span>(o) <span class="sc">&amp;&amp;</span> attempt <span class="sc">&lt;=</span> attempt_max) {</span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (attempt <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">glue</span>(<span class="st">"  attempt {attempt}"</span>, <span class="at">.trim =</span> F))</span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a>      attempt <span class="ot">&lt;-</span> attempt <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a>      <span class="fu">try</span>(</span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a>        o <span class="ot">&lt;-</span> <span class="fu">ncdc</span>(</span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a>          <span class="at">datasetid  =</span> <span class="st">"GHCND"</span>, </span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a>          <span class="at">stationid  =</span> stn, </span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a>          <span class="at">datatypeid =</span> vars, </span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a>          <span class="at">startdate  =</span> date_beg,</span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a>          <span class="at">enddate    =</span> date_end,</span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a>          <span class="at">limit      =</span> max_rows) )</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> o<span class="sc">$</span>data</span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df, o<span class="sc">$</span>data)</span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">duplicated</span>(df[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])<span class="sc">|&gt;</span> <span class="fu">sum</span>() <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a>      <span class="at">date     =</span> <span class="fu">as.Date</span>(<span class="fu">strptime</span>(</span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a>        date, <span class="st">"%Y-%m-%dT00:00:00"</span>)),</span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>      <span class="at">datatype =</span> <span class="fu">recode</span>(</span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a>        datatype, </span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>        <span class="at">PRCP =</span> <span class="st">"precip_mm"</span>, </span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a>        <span class="at">TMIN =</span> <span class="st">"temp_c_min"</span>, </span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a>        <span class="at">TMAX =</span> <span class="st">"temp_c_max"</span>),</span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a>      <span class="at">value    =</span> value <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>station, <span class="co"># station         : all "GHCND:USW00012842"</span></span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_m,    <span class="co"># measurement flag: 3,524 are "T" for trace</span></span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_t,    <span class="co"># time        flag: all "2400"</span></span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>fl_q)    <span class="co"># quality     flag: all ""</span></span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(df, stn_csv)</span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-209"><a href="#cb22-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-210"><a href="#cb22-210" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(stn_csv)</span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, datatype, value) <span class="sc">|&gt;</span></span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datatype <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"temp_c_min"</span>,<span class="st">"temp_c_max"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> datatype, </span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dygraph</span>(<span class="at">main =</span> <span class="st">"Daily Temperature (ºC)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dyOptions</span>(</span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">colors =</span> <span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"YlOrRd"</span>)[<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">3</span>)]) <span class="sc">|&gt;</span> </span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"temp_c_min"</span>, <span class="at">label =</span> <span class="st">"min"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"temp_c_max"</span>, <span class="at">label =</span> <span class="st">"max"</span>)</span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, datatype, value) <span class="sc">|&gt;</span></span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datatype <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"precip_mm"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb22-228"><a href="#cb22-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> datatype, </span>
<span id="cb22-229"><a href="#cb22-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb22-230"><a href="#cb22-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dygraph</span>(<span class="at">main =</span> <span class="st">"Daily Precipitation (mm)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-231"><a href="#cb22-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dySeries</span>(<span class="st">"precip_mm"</span>, <span class="at">label =</span> <span class="st">"precip"</span>)</span>
<span id="cb22-232"><a href="#cb22-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-233"><a href="#cb22-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-234"><a href="#cb22-234" aria-hidden="true" tabindex="-1"></a>TODO: - trend analysis. e.g. <span class="co">[</span><span class="ot">NOAA's Climate at a Glance</span><span class="co">](https://www.ncdc.noaa.gov/cag/global/time-series/globe/land_ocean/ytd/12/1880-2020)</span>. Typically based on the last 30 years, but here we've got back to 1939-02-01 so almost 100 years. Keep it 5 years and see how rate changing over time.</span>
<span id="cb22-235"><a href="#cb22-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-236"><a href="#cb22-236" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>severe weather events? "Sea-level rise exponentially increases coastal flood frequency Mohsen taherkhani"</span>
<span id="cb22-237"><a href="#cb22-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-238"><a href="#cb22-238" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Satellite</span></span>
<span id="cb22-239"><a href="#cb22-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-240"><a href="#cb22-240" aria-hidden="true" tabindex="-1"></a><span class="fu">## Precipitation</span></span>
<span id="cb22-241"><a href="#cb22-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-242"><a href="#cb22-242" aria-hidden="true" tabindex="-1"></a>Materials:</span>
<span id="cb22-243"><a href="#cb22-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-244"><a href="#cb22-244" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"RAIN AS A DRIVER" in <span class="co">[</span><span class="ot">tbep-os-presentations/state_of_the_bay_2023.qmd</span><span class="co">](https://github.com/tbep-tech/tbep-os-presentations/blob/6ff9054aa0eb1f194a9a28e3dc8b1eff02b6a58f/state_of_the_bay_2023.qmd#L354)</span></span>
<span id="cb22-245"><a href="#cb22-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-246"><a href="#cb22-246" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Precipitation - NEXRAD QPE CDR \| National Centers for Environmental Information (NCEI)</span><span class="co">](https://www.ncei.noaa.gov/products/climate-data-records/precipitation-nexrad-qpe)</span></span>
<span id="cb22-247"><a href="#cb22-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-250"><a href="#cb22-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-251"><a href="#cb22-251" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb22-252"><a href="#cb22-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-253"><a href="#cb22-253" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-254"><a href="#cb22-254" aria-hidden="true" tabindex="-1"></a>  dplyr, here, leaflet,</span>
<span id="cb22-255"><a href="#cb22-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapview, </span></span>
<span id="cb22-256"><a href="#cb22-256" aria-hidden="true" tabindex="-1"></a>  readxl, sf, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools)</span>
<span id="cb22-257"><a href="#cb22-257" aria-hidden="true" tabindex="-1"></a><span class="co"># register with renv</span></span>
<span id="cb22-258"><a href="#cb22-258" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb22-259"><a href="#cb22-259" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb22-260"><a href="#cb22-260" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb22-261"><a href="#cb22-261" aria-hidden="true" tabindex="-1"></a><span class="co"># library(mapview)</span></span>
<span id="cb22-262"><a href="#cb22-262" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb22-263"><a href="#cb22-263" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb22-264"><a href="#cb22-264" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tbeptools)</span>
<span id="cb22-265"><a href="#cb22-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-266"><a href="#cb22-266" aria-hidden="true" tabindex="-1"></a><span class="co"># from SWFWMD grid cells, use only if interested in areas finer than TB watershed</span></span>
<span id="cb22-267"><a href="#cb22-267" aria-hidden="true" tabindex="-1"></a><span class="co"># this currently gets the same data as the compiled spreadsheet</span></span>
<span id="cb22-268"><a href="#cb22-268" aria-hidden="true" tabindex="-1"></a>grd <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">'../tbep-os-presentations/data/swfwmd-GARR-gisfiles-utm/swfwmd_pixel_2_utm_m_83.shp'</span>), <span class="at">quiet =</span> T)</span>
<span id="cb22-269"><a href="#cb22-269" aria-hidden="true" tabindex="-1"></a><span class="co"># mapView(grd)</span></span>
<span id="cb22-270"><a href="#cb22-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-271"><a href="#cb22-271" aria-hidden="true" tabindex="-1"></a>tbgrdcent <span class="ot">&lt;-</span> grd <span class="sc">%&gt;%</span></span>
<span id="cb22-272"><a href="#cb22-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(tbshed)) <span class="sc">%&gt;%</span></span>
<span id="cb22-273"><a href="#cb22-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-274"><a href="#cb22-274" aria-hidden="true" tabindex="-1"></a>  .[tbshed, ]</span>
<span id="cb22-275"><a href="#cb22-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-276"><a href="#cb22-276" aria-hidden="true" tabindex="-1"></a><span class="co"># unzip folders</span></span>
<span id="cb22-277"><a href="#cb22-277" aria-hidden="true" tabindex="-1"></a>loc <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">'../tbep-os-presentations/data/swfwmd_rain'</span>)</span>
<span id="cb22-278"><a href="#cb22-278" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(loc, pattern = '.zip', full.names = T)</span></span>
<span id="cb22-279"><a href="#cb22-279" aria-hidden="true" tabindex="-1"></a><span class="co"># lapply(files, unzip, exdir = loc)</span></span>
<span id="cb22-280"><a href="#cb22-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-281"><a href="#cb22-281" aria-hidden="true" tabindex="-1"></a><span class="co"># read text files</span></span>
<span id="cb22-282"><a href="#cb22-282" aria-hidden="true" tabindex="-1"></a>raindat <span class="ot">&lt;-</span> <span class="fu">list.files</span>(loc, <span class="at">pattern =</span> <span class="st">'19.*</span><span class="sc">\\</span><span class="st">.txt$|20.*</span><span class="sc">\\</span><span class="st">.txt$'</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb22-283"><a href="#cb22-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(read.table, <span class="at">sep =</span> <span class="st">','</span>, <span class="at">header =</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb22-284"><a href="#cb22-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(<span class="st">'rbind'</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb22-285"><a href="#cb22-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb22-286"><a href="#cb22-286" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PIXEL'</span> <span class="ot">=</span> V1,</span>
<span id="cb22-287"><a href="#cb22-287" aria-hidden="true" tabindex="-1"></a>    <span class="st">'yr'</span> <span class="ot">=</span> V2,</span>
<span id="cb22-288"><a href="#cb22-288" aria-hidden="true" tabindex="-1"></a>    <span class="st">'inches'</span> <span class="ot">=</span> V3) <span class="sc">%&gt;%</span></span>
<span id="cb22-289"><a href="#cb22-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PIXEL <span class="sc">%in%</span> tbgrdcent<span class="sc">$</span>PIXEL)</span>
<span id="cb22-290"><a href="#cb22-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-291"><a href="#cb22-291" aria-hidden="true" tabindex="-1"></a><span class="co"># ave rain dat</span></span>
<span id="cb22-292"><a href="#cb22-292" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> raindat <span class="sc">%&gt;%</span></span>
<span id="cb22-293"><a href="#cb22-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-294"><a href="#cb22-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="fu">mean</span>(inches, <span class="at">na.rm =</span> T),</span>
<span id="cb22-295"><a href="#cb22-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">'yr'</span>)</span>
<span id="cb22-296"><a href="#cb22-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-297"><a href="#cb22-297" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb22-298"><a href="#cb22-298" aria-hidden="true" tabindex="-1"></a><span class="co"># use compiled SWFWMD data</span></span>
<span id="cb22-299"><a href="#cb22-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-300"><a href="#cb22-300" aria-hidden="true" tabindex="-1"></a><span class="co"># # https://www.swfwmd.state.fl.us/resources/data-maps/rainfall-summary-data-region</span></span>
<span id="cb22-301"><a href="#cb22-301" aria-hidden="true" tabindex="-1"></a><span class="co"># # file is from the link "USGS watershed"</span></span>
<span id="cb22-302"><a href="#cb22-302" aria-hidden="true" tabindex="-1"></a><span class="co"># download.file(</span></span>
<span id="cb22-303"><a href="#cb22-303" aria-hidden="true" tabindex="-1"></a><span class="co">#   'https://www4.swfwmd.state.fl.us/RDDataImages/surf.xlsx?_ga=2.186665249.868698214.1705929229-785009494.1704644825',</span></span>
<span id="cb22-304"><a href="#cb22-304" aria-hidden="true" tabindex="-1"></a><span class="co">#   here('data/swfwmdrainfall.xlsx'),</span></span>
<span id="cb22-305"><a href="#cb22-305" aria-hidden="true" tabindex="-1"></a><span class="co">#   mode = 'wb'</span></span>
<span id="cb22-306"><a href="#cb22-306" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb22-307"><a href="#cb22-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-308"><a href="#cb22-308" aria-hidden="true" tabindex="-1"></a>raindatave_url <span class="ot">&lt;-</span> <span class="st">"https://www4.swfwmd.state.fl.us/RDDataImages/surf.xlsx"</span></span>
<span id="cb22-309"><a href="#cb22-309" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">'data/swfwmd.state.fl.us'</span>))</span>
<span id="cb22-310"><a href="#cb22-310" aria-hidden="true" tabindex="-1"></a>raindatave_xl <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">'data/swfwmd.state.fl.us/surf.xlsx'</span>)</span>
<span id="cb22-311"><a href="#cb22-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-312"><a href="#cb22-312" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(raindatave_url, raindatave_xl)</span>
<span id="cb22-313"><a href="#cb22-313" aria-hidden="true" tabindex="-1"></a><span class="fu">read_excel</span>(raindatave_xl)</span>
<span id="cb22-314"><a href="#cb22-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-315"><a href="#cb22-315" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(raindatave_url, <span class="fu">here</span>(<span class="st">'data/swfwmdrainfall.xlsx'</span>), <span class="at">mode =</span> <span class="st">'wb'</span>)</span>
<span id="cb22-316"><a href="#cb22-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-317"><a href="#cb22-317" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb22-318"><a href="#cb22-318" aria-hidden="true" tabindex="-1"></a>  raindatave_xl, <span class="at">sheet =</span> <span class="st">'ann-usgsbsn'</span>, <span class="at">skip =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-319"><a href="#cb22-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">%in%</span> <span class="dv">1975</span><span class="sc">:</span><span class="dv">2023</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-320"><a href="#cb22-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb22-321"><a href="#cb22-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> Year, </span>
<span id="cb22-322"><a href="#cb22-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="st">`</span><span class="at">Tampa Bay/Coastal Areas</span><span class="st">`</span></span>
<span id="cb22-323"><a href="#cb22-323" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-324"><a href="#cb22-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(as.numeric)</span>
<span id="cb22-325"><a href="#cb22-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-326"><a href="#cb22-326" aria-hidden="true" tabindex="-1"></a>raindatave_now <span class="ot">&lt;-</span> </span>
<span id="cb22-327"><a href="#cb22-327" aria-hidden="true" tabindex="-1"></a>readxl<span class="sc">::</span><span class="fu">read_excel</span>()</span>
<span id="cb22-328"><a href="#cb22-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-329"><a href="#cb22-329" aria-hidden="true" tabindex="-1"></a>raindatave <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">here</span>(<span class="st">'data/swfwmdrainfall.xlsx'</span>), <span class="at">sheet =</span> <span class="st">'ann-usgsbsn'</span>, <span class="at">skip =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-330"><a href="#cb22-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">%in%</span> <span class="dv">1975</span><span class="sc">:</span><span class="dv">2023</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-331"><a href="#cb22-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb22-332"><a href="#cb22-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> Year, </span>
<span id="cb22-333"><a href="#cb22-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">inches =</span> <span class="st">`</span><span class="at">Tampa Bay/Coastal Areas</span><span class="st">`</span></span>
<span id="cb22-334"><a href="#cb22-334" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-335"><a href="#cb22-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(as.numeric)</span>
<span id="cb22-336"><a href="#cb22-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-337"><a href="#cb22-337" aria-hidden="true" tabindex="-1"></a><span class="co"># ave chldat</span></span>
<span id="cb22-338"><a href="#cb22-338" aria-hidden="true" tabindex="-1"></a>chlave <span class="ot">&lt;-</span> <span class="fu">anlz_avedat</span>(epcdata) <span class="sc">%&gt;%</span> </span>
<span id="cb22-339"><a href="#cb22-339" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span>ann <span class="sc">%&gt;%</span> </span>
<span id="cb22-340"><a href="#cb22-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(var <span class="sc">==</span> <span class="st">'mean_chla'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-341"><a href="#cb22-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-342"><a href="#cb22-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">chla =</span> <span class="fu">mean</span>(val, <span class="at">na.rm =</span> T),</span>
<span id="cb22-343"><a href="#cb22-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="st">'yr'</span></span>
<span id="cb22-344"><a href="#cb22-344" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-345"><a href="#cb22-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(yr <span class="sc">&gt;=</span> <span class="dv">1975</span>)</span>
<span id="cb22-346"><a href="#cb22-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-347"><a href="#cb22-347" aria-hidden="true" tabindex="-1"></a>toplo <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(chlave, raindatave, <span class="at">by =</span> <span class="st">'yr'</span>)</span>
<span id="cb22-348"><a href="#cb22-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-349"><a href="#cb22-349" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(raindatave, <span class="fu">aes</span>(<span class="at">x =</span> yr, <span class="at">y =</span> inches)) <span class="sc">+</span></span>
<span id="cb22-350"><a href="#cb22-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb22-351"><a href="#cb22-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb22-352"><a href="#cb22-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> raindatave[chlave<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb22-353"><a href="#cb22-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb22-354"><a href="#cb22-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-355"><a href="#cb22-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-356"><a href="#cb22-356" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb22-357"><a href="#cb22-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-358"><a href="#cb22-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb22-359"><a href="#cb22-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Annual rainfall (inches)'</span>, </span>
<span id="cb22-360"><a href="#cb22-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual rainfall'</span>, </span>
<span id="cb22-361"><a href="#cb22-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Tampa Bay watershed, 1975 - 2023'</span></span>
<span id="cb22-362"><a href="#cb22-362" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-363"><a href="#cb22-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-364"><a href="#cb22-364" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(chlave, <span class="fu">aes</span>(<span class="at">x =</span> yr, <span class="at">y =</span> chla)) <span class="sc">+</span></span>
<span id="cb22-365"><a href="#cb22-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb22-366"><a href="#cb22-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb22-367"><a href="#cb22-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> chlave[chlave<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb22-368"><a href="#cb22-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb22-369"><a href="#cb22-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-370"><a href="#cb22-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-371"><a href="#cb22-371" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb22-372"><a href="#cb22-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-373"><a href="#cb22-373" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb22-374"><a href="#cb22-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Chlorophyll-a (ug/L)'</span>, </span>
<span id="cb22-375"><a href="#cb22-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual mean chlorophyll-a'</span>, </span>
<span id="cb22-376"><a href="#cb22-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'All segments, 1975 - 2023'</span></span>
<span id="cb22-377"><a href="#cb22-377" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-378"><a href="#cb22-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-379"><a href="#cb22-379" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(toplo, <span class="fu">aes</span>(<span class="at">x =</span> inches, <span class="at">y =</span> chla)) <span class="sc">+</span></span>
<span id="cb22-380"><a href="#cb22-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> yr), <span class="at">point.size =</span> <span class="cn">NA</span>, <span class="at">segment.size =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb22-381"><a href="#cb22-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="at">data =</span> toplo[toplo<span class="sc">$</span>yr <span class="sc">==</span> <span class="dv">2023</span>, ], <span class="fu">aes</span>(<span class="at">label =</span> yr), <span class="at">color =</span> <span class="st">'red'</span>, <span class="at">point.size =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb22-382"><a href="#cb22-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">se =</span> F, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span> </span>
<span id="cb22-383"><a href="#cb22-383" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_segment(aes(x = 45, xend = 40, y = 4.86, yend = 4.86), color = 'red', arrow = arrow(length = unit(0.2, "inches")), linewidth = 1) +</span></span>
<span id="cb22-384"><a href="#cb22-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb22-385"><a href="#cb22-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-386"><a href="#cb22-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb22-387"><a href="#cb22-387" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb22-388"><a href="#cb22-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-389"><a href="#cb22-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Annual rainfall (inches)'</span>, </span>
<span id="cb22-390"><a href="#cb22-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Chlorophyll-a (ug/L)'</span>, </span>
<span id="cb22-391"><a href="#cb22-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Annual mean chlorophyll-a vs. rainfall'</span>, </span>
<span id="cb22-392"><a href="#cb22-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Data from EPCHC, SWFWMD'</span></span>
<span id="cb22-393"><a href="#cb22-393" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-394"><a href="#cb22-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-395"><a href="#cb22-395" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> (p1 <span class="sc">/</span> p2) <span class="sc">|</span> p3</span>
<span id="cb22-396"><a href="#cb22-396" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb22-397"><a href="#cb22-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-398"><a href="#cb22-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-399"><a href="#cb22-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### rNOMADS</span></span>
<span id="cb22-400"><a href="#cb22-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-403"><a href="#cb22-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-404"><a href="#cb22-404" aria-hidden="true" tabindex="-1"></a><span class="co"># librarian::shelf(rNOMADS)</span></span>
<span id="cb22-405"><a href="#cb22-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-406"><a href="#cb22-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-407"><a href="#cb22-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-408"><a href="#cb22-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-409"><a href="#cb22-409" aria-hidden="true" tabindex="-1"></a><span class="fu">## PRISM</span></span>
<span id="cb22-410"><a href="#cb22-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-411"><a href="#cb22-411" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">HMS: Hydrologic Micro Services \| United States Environmental Protection Agency \| US EPA</span><span class="co">](https://qed.epa.gov/hms/meteorology/humidity/algorithms/)</span></span>
<span id="cb22-412"><a href="#cb22-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-413"><a href="#cb22-413" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The </span><span class="co">[</span><span class="ot">Parameter-elevation Relationship on Independent Slopes Model (PRISM)</span><span class="co">](https://prism.oregonstate.edu/)</span><span class="at"> is a combined dataset consisting of ground gauge station and RADAR products. The data is on a 4km grid resolution covering the contiguous United States. Data is available from 1981 to present.PRISM data are reported in GMT (UTC). PRISM provides daily average temperature and dew-point temperature data. Relative humidity is calculated using a version of the </span><span class="co">[</span><span class="ot">August-Roche-Magnus equation</span><span class="co">](https://bmcnoldy.rsmas.miami.edu/Humidity.html)</span><span class="at"> as follows ): </span><span class="in">`RH = 100*(EXP((17.625*TD)/(243.04+TD))/EXP((17.625*T)/(243.04+T)))`</span><span class="at"> where, </span><span class="in">`RH`</span><span class="at"> is % relative humidity, </span><span class="in">`TD`</span><span class="at"> is dew-point temperature (celsius), and </span><span class="in">`T`</span><span class="at"> is air temperature (celsius).</span></span>
<span id="cb22-414"><a href="#cb22-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-415"><a href="#cb22-415" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">AHPS Precipitation Analysis</span><span class="co">](https://water.weather.gov/precip/about.php)</span></span>
<span id="cb22-416"><a href="#cb22-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-417"><a href="#cb22-417" aria-hidden="true" tabindex="-1"></a><span class="at">    &gt; "Normal" precipitation is derived from PRISM climate data, created at Oregon State University. The PRISM gridded climate maps are considered the most detailed, highest-quality spatial climate datasets currently available.</span></span>
<span id="cb22-418"><a href="#cb22-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-419"><a href="#cb22-419" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">prism</span><span class="co">](https://docs.ropensci.org/prism/articles/prism.html#prism-data-and-parameters)</span> R package</span>
<span id="cb22-420"><a href="#cb22-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-421"><a href="#cb22-421" aria-hidden="true" tabindex="-1"></a>| Parameter | Description                                    |</span>
<span id="cb22-422"><a href="#cb22-422" aria-hidden="true" tabindex="-1"></a>|-----------|------------------------------------------------|</span>
<span id="cb22-423"><a href="#cb22-423" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tmin`</span>    | Minimum temperature                            |</span>
<span id="cb22-424"><a href="#cb22-424" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tmax`</span>    | Maximum temperature                            |</span>
<span id="cb22-425"><a href="#cb22-425" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tmean`</span>   | Mean temperature (<span class="in">`tmean == mean(tmin, tmax)`</span>) |</span>
<span id="cb22-426"><a href="#cb22-426" aria-hidden="true" tabindex="-1"></a>| <span class="in">`tdmean`</span>  | Mean dew point temperature                     |</span>
<span id="cb22-427"><a href="#cb22-427" aria-hidden="true" tabindex="-1"></a>| <span class="in">`ppt`</span>     | Total precipitation (rain and snow)            |</span>
<span id="cb22-428"><a href="#cb22-428" aria-hidden="true" tabindex="-1"></a>| <span class="in">`vpdmin`</span>  | Daily minimum vapor pressure deficit           |</span>
<span id="cb22-429"><a href="#cb22-429" aria-hidden="true" tabindex="-1"></a>| <span class="in">`vpdmax`</span>  | Daily maximum vapor pressure deficit           |</span>
<span id="cb22-430"><a href="#cb22-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-431"><a href="#cb22-431" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Data are at 4km resolution, except for the normals which can also be downloaded at 800m resolution.</span></span>
<span id="cb22-432"><a href="#cb22-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-433"><a href="#cb22-433" aria-hidden="true" tabindex="-1"></a>Temporal data availability:</span>
<span id="cb22-434"><a href="#cb22-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-435"><a href="#cb22-435" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Recent**\</span>
<span id="cb22-436"><a href="#cb22-436" aria-hidden="true" tabindex="-1"></a>    1981 to present\</span>
<span id="cb22-437"><a href="#cb22-437" aria-hidden="true" tabindex="-1"></a>    daily, monthly, annual data</span>
<span id="cb22-438"><a href="#cb22-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-439"><a href="#cb22-439" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Historical**\</span>
<span id="cb22-440"><a href="#cb22-440" aria-hidden="true" tabindex="-1"></a>    1895 through 1980\</span>
<span id="cb22-441"><a href="#cb22-441" aria-hidden="true" tabindex="-1"></a>    complete monthly and annual data by year</span>
<span id="cb22-442"><a href="#cb22-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-443"><a href="#cb22-443" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Normals**\</span>
<span id="cb22-444"><a href="#cb22-444" aria-hidden="true" tabindex="-1"></a>    30-year normals daily, monthly, and annual normals, each as a single grid The 30 year PRISM normal from 1981-2010 is used for precipitation analysis since 2004. Prior to 2004 the 30 year PRISM normal from 1961-1990 is used.</span>
<span id="cb22-445"><a href="#cb22-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-446"><a href="#cb22-446" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Forms</span>
<span id="cb22-447"><a href="#cb22-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-448"><a href="#cb22-448" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>stable</span>
<span id="cb22-449"><a href="#cb22-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-450"><a href="#cb22-450" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>provisional</span>
<span id="cb22-451"><a href="#cb22-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-452"><a href="#cb22-452" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>early</span>
<span id="cb22-453"><a href="#cb22-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-454"><a href="#cb22-454" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Daily data are considered "early" for the current month. The previous six months are provisional data. After six months data are considered stable. Thus early data only exist for daily data, while there can be monthly (and presumably yearly) provisional data. -- </span><span class="in">`?prism::prism_archive_clean`</span></span>
<span id="cb22-455"><a href="#cb22-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-456"><a href="#cb22-456" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example `tbeptools::read_importprism()`</span></span>
<span id="cb22-457"><a href="#cb22-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-458"><a href="#cb22-458" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`@example`</span> from <span class="co">[</span><span class="ot">`tbeptools::read_importprism()`</span><span class="co">](https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/read_importprism.R)</span></span>
<span id="cb22-459"><a href="#cb22-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-462"><a href="#cb22-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-463"><a href="#cb22-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: example_read_importprism</span></span>
<span id="cb22-464"><a href="#cb22-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| messages: false</span></span>
<span id="cb22-465"><a href="#cb22-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb22-466"><a href="#cb22-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-467"><a href="#cb22-467" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_local("../tbeptools", force = T)</span></span>
<span id="cb22-468"><a href="#cb22-468" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::load_all("../tbeptools")</span></span>
<span id="cb22-469"><a href="#cb22-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-470"><a href="#cb22-470" aria-hidden="true" tabindex="-1"></a><span class="co"># setup output directory and table</span></span>
<span id="cb22-471"><a href="#cb22-471" aria-hidden="true" tabindex="-1"></a>dir_tif   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../tbeptools/inst/prism"</span>)</span>
<span id="cb22-472"><a href="#cb22-472" aria-hidden="true" tabindex="-1"></a>zonal_csv <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_tif, <span class="st">"_zones.csv"</span>)</span>
<span id="cb22-473"><a href="#cb22-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-474"><a href="#cb22-474" aria-hidden="true" tabindex="-1"></a><span class="co"># run function for Tampa Bay watersheds for first 3 days and 4 variables</span></span>
<span id="cb22-475"><a href="#cb22-475" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_importprism</span>(</span>
<span id="cb22-476"><a href="#cb22-476" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars      =</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>),</span>
<span id="cb22-477"><a href="#cb22-477" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_beg  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-01"</span>),</span>
<span id="cb22-478"><a href="#cb22-478" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-03"</span>),</span>
<span id="cb22-479"><a href="#cb22-479" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir_tif   =</span> dir_tif,</span>
<span id="cb22-480"><a href="#cb22-480" aria-hidden="true" tabindex="-1"></a>  <span class="at">sf_zones  =</span> tbsegshed,</span>
<span id="cb22-481"><a href="#cb22-481" aria-hidden="true" tabindex="-1"></a>  <span class="at">fld_zones =</span> <span class="st">"bay_segment"</span>,</span>
<span id="cb22-482"><a href="#cb22-482" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> zonal_csv)</span>
<span id="cb22-483"><a href="#cb22-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-484"><a href="#cb22-484" aria-hidden="true" tabindex="-1"></a><span class="co"># plot first of output rasters</span></span>
<span id="cb22-485"><a href="#cb22-485" aria-hidden="true" tabindex="-1"></a>tifs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_tif, <span class="at">pattern =</span> <span class="st">".tif$"</span>, <span class="at">full.names =</span> T)</span>
<span id="cb22-486"><a href="#cb22-486" aria-hidden="true" tabindex="-1"></a><span class="fu">basename</span>(tifs)</span>
<span id="cb22-487"><a href="#cb22-487" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(tifs[<span class="dv">1</span>])</span>
<span id="cb22-488"><a href="#cb22-488" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r) <span class="co"># {data observed}_{variable}_v{version}_{date updated}</span></span>
<span id="cb22-489"><a href="#cb22-489" aria-hidden="true" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plet</span>(</span>
<span id="cb22-490"><a href="#cb22-490" aria-hidden="true" tabindex="-1"></a>  r[[<span class="dv">3</span>]],</span>
<span id="cb22-491"><a href="#cb22-491" aria-hidden="true" tabindex="-1"></a>  <span class="at">main  =</span> <span class="fu">names</span>(r)[<span class="dv">3</span>],</span>
<span id="cb22-492"><a href="#cb22-492" aria-hidden="true" tabindex="-1"></a>  <span class="at">col   =</span> <span class="st">"Spectral"</span>,</span>
<span id="cb22-493"><a href="#cb22-493" aria-hidden="true" tabindex="-1"></a>  <span class="at">tiles =</span> <span class="st">"CartoDB.DarkMatter"</span>)</span>
<span id="cb22-494"><a href="#cb22-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-495"><a href="#cb22-495" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary by zone</span></span>
<span id="cb22-496"><a href="#cb22-496" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb22-497"><a href="#cb22-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-498"><a href="#cb22-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-499"><a href="#cb22-499" aria-hidden="true" tabindex="-1"></a><span class="fu">### Operationalize</span></span>
<span id="cb22-500"><a href="#cb22-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-503"><a href="#cb22-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-504"><a href="#cb22-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: operationalize_read_importprism</span></span>
<span id="cb22-505"><a href="#cb22-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb22-506"><a href="#cb22-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-507"><a href="#cb22-507" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-508"><a href="#cb22-508" aria-hidden="true" tabindex="-1"></a>  dplyr, here, sf, tbep<span class="sc">-</span>tech<span class="sc">/</span>tbeptools)</span>
<span id="cb22-509"><a href="#cb22-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-510"><a href="#cb22-510" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs</span></span>
<span id="cb22-511"><a href="#cb22-511" aria-hidden="true" tabindex="-1"></a>dir_prism <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/prism"</span>)</span>
<span id="cb22-512"><a href="#cb22-512" aria-hidden="true" tabindex="-1"></a>prism_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/prism.csv"</span>)</span>
<span id="cb22-513"><a href="#cb22-513" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-514"><a href="#cb22-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Tampa Bay watershed zones, including whole bay ("TB")</span></span>
<span id="cb22-515"><a href="#cb22-515" aria-hidden="true" tabindex="-1"></a>tb_zones <span class="ot">&lt;-</span> tbsegshed <span class="sc">|&gt;</span></span>
<span id="cb22-516"><a href="#cb22-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb22-517"><a href="#cb22-517" aria-hidden="true" tabindex="-1"></a>    tbshed <span class="sc">|&gt;</span></span>
<span id="cb22-518"><a href="#cb22-518" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">bay_segment =</span> <span class="st">"TB"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-519"><a href="#cb22-519" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(bay_segment, geometry))</span>
<span id="cb22-520"><a href="#cb22-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-521"><a href="#cb22-521" aria-hidden="true" tabindex="-1"></a><span class="co"># bounding box with 0.2º margin around watershed, rounded to .1</span></span>
<span id="cb22-522"><a href="#cb22-522" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> tbshed <span class="sc">|&gt;</span> </span>
<span id="cb22-523"><a href="#cb22-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="fl">0.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-524"><a href="#cb22-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-525"><a href="#cb22-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb22-526"><a href="#cb22-526" aria-hidden="true" tabindex="-1"></a><span class="co">#     c(xmin = -82.9, ymin = 27.4, xmax = -81.9, ymax = 28.4)</span></span>
<span id="cb22-527"><a href="#cb22-527" aria-hidden="true" tabindex="-1"></a><span class="co"># after running terra::trim() on raster:</span></span>
<span id="cb22-528"><a href="#cb22-528" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb22-529"><a href="#cb22-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-530"><a href="#cb22-530" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_importprism</span>(</span>
<span id="cb22-531"><a href="#cb22-531" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars      =</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>),</span>
<span id="cb22-532"><a href="#cb22-532" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_beg  =</span> <span class="fu">as.Date</span>(<span class="st">"1981-01-01"</span>),</span>
<span id="cb22-533"><a href="#cb22-533" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end  =</span> <span class="fu">Sys.Date</span>(),</span>
<span id="cb22-534"><a href="#cb22-534" aria-hidden="true" tabindex="-1"></a>  <span class="at">bbox      =</span> bb,</span>
<span id="cb22-535"><a href="#cb22-535" aria-hidden="true" tabindex="-1"></a>  <span class="at">dir_tif   =</span> dir_prism,</span>
<span id="cb22-536"><a href="#cb22-536" aria-hidden="true" tabindex="-1"></a>  <span class="at">sf_zones  =</span> tb_zones,</span>
<span id="cb22-537"><a href="#cb22-537" aria-hidden="true" tabindex="-1"></a>  <span class="at">fld_zones =</span> <span class="st">"bay_segment"</span>,</span>
<span id="cb22-538"><a href="#cb22-538" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> prism_csv,</span>
<span id="cb22-539"><a href="#cb22-539" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose   =</span> T)</span>
<span id="cb22-540"><a href="#cb22-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-541"><a href="#cb22-541" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary by zone</span></span>
<span id="cb22-542"><a href="#cb22-542" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb22-543"><a href="#cb22-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-544"><a href="#cb22-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-545"><a href="#cb22-545" aria-hidden="true" tabindex="-1"></a>TODO: Github Action on daily cron to run <span class="in">`read_importprism()`</span> for all days and variables</span>
<span id="cb22-546"><a href="#cb22-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-549"><a href="#cb22-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-550"><a href="#cb22-550" aria-hidden="true" tabindex="-1"></a><span class="co"># Get monthly (every month) and annual 30-year normals for precipitation</span></span>
<span id="cb22-551"><a href="#cb22-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-552"><a href="#cb22-552" aria-hidden="true" tabindex="-1"></a><span class="co"># get_prism_normals(</span></span>
<span id="cb22-553"><a href="#cb22-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-554"><a href="#cb22-554" aria-hidden="true" tabindex="-1"></a><span class="co"># type = "ppt",</span></span>
<span id="cb22-555"><a href="#cb22-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-556"><a href="#cb22-556" aria-hidden="true" tabindex="-1"></a><span class="co"># resolution = "800m",</span></span>
<span id="cb22-557"><a href="#cb22-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-558"><a href="#cb22-558" aria-hidden="true" tabindex="-1"></a><span class="co"># mon = 1:12,</span></span>
<span id="cb22-559"><a href="#cb22-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-560"><a href="#cb22-560" aria-hidden="true" tabindex="-1"></a><span class="co"># annual = TRUE,</span></span>
<span id="cb22-561"><a href="#cb22-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-562"><a href="#cb22-562" aria-hidden="true" tabindex="-1"></a><span class="co"># keepZip = FALSE)</span></span>
<span id="cb22-563"><a href="#cb22-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-564"><a href="#cb22-564" aria-hidden="true" tabindex="-1"></a>var    <span class="ot">&lt;-</span> <span class="st">"tmax"</span></span>
<span id="cb22-565"><a href="#cb22-565" aria-hidden="true" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="st">"daily"</span></span>
<span id="cb22-566"><a href="#cb22-566" aria-hidden="true" tabindex="-1"></a>date   <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>) <span class="co"># yesterday</span></span>
<span id="cb22-567"><a href="#cb22-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-568"><a href="#cb22-568" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prism_dailys</span>(</span>
<span id="cb22-569"><a href="#cb22-569" aria-hidden="true" tabindex="-1"></a>  <span class="at">type    =</span> <span class="st">"tmax"</span>, </span>
<span id="cb22-570"><a href="#cb22-570" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates   =</span> date, </span>
<span id="cb22-571"><a href="#cb22-571" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepZip =</span> F)</span>
<span id="cb22-572"><a href="#cb22-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-573"><a href="#cb22-573" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">prism_archive_subset</span>(var, period, <span class="at">dates =</span> date)</span>
<span id="cb22-574"><a href="#cb22-574" aria-hidden="true" tabindex="-1"></a><span class="fu">pd_image</span>(pd, <span class="at">col=</span><span class="st">"redblue"</span>)</span>
<span id="cb22-575"><a href="#cb22-575" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pd) <span class="sc">|&gt;</span> </span>
<span id="cb22-576"><a href="#cb22-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb22-577"><a href="#cb22-577" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb22-578"><a href="#cb22-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-579"><a href="#cb22-579" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb22-580"><a href="#cb22-580" aria-hidden="true" tabindex="-1"></a>r_3857 <span class="ot">&lt;-</span> <span class="fu">projectRasterForLeaflet</span>(</span>
<span id="cb22-581"><a href="#cb22-581" aria-hidden="true" tabindex="-1"></a>  r, <span class="at">method =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb22-582"><a href="#cb22-582" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorNumeric</span>(</span>
<span id="cb22-583"><a href="#cb22-583" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spectral"</span>,  <span class="fu">values</span>(r_3857, <span class="at">na.rm=</span>T), </span>
<span id="cb22-584"><a href="#cb22-584" aria-hidden="true" tabindex="-1"></a>  <span class="at">na.color =</span> <span class="st">"transparent"</span>)</span>
<span id="cb22-585"><a href="#cb22-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-586"><a href="#cb22-586" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-587"><a href="#cb22-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb22-588"><a href="#cb22-588" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.Positron) <span class="sc">|&gt;</span></span>
<span id="cb22-589"><a href="#cb22-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb22-590"><a href="#cb22-590" aria-hidden="true" tabindex="-1"></a>    r_3857, <span class="at">opacity =</span> <span class="fl">0.7</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-591"><a href="#cb22-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(</span>
<span id="cb22-592"><a href="#cb22-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tbsegshed, </span>
<span id="cb22-593"><a href="#cb22-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">fillOpacity =</span> <span class="dv">0</span>, </span>
<span id="cb22-594"><a href="#cb22-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"purple"</span>, <span class="at">weight =</span> <span class="dv">5</span>)</span>
<span id="cb22-595"><a href="#cb22-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-596"><a href="#cb22-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-597"><a href="#cb22-597" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assign bounding box for AoI cropping of rasters</span></span>
<span id="cb22-598"><a href="#cb22-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-601"><a href="#cb22-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-602"><a href="#cb22-602" aria-hidden="true" tabindex="-1"></a><span class="co"># tbshed_pd &lt;- tbshed |&gt; </span></span>
<span id="cb22-603"><a href="#cb22-603" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(<span class="fu">prism_archive_subset</span>(<span class="st">"tmax"</span>, <span class="st">"daily"</span>)[<span class="dv">1</span>])</span>
<span id="cb22-604"><a href="#cb22-604" aria-hidden="true" tabindex="-1"></a>crs <span class="ot">&lt;-</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)  <span class="co"># +proj=longlat +datum=NAD83 +no_defs</span></span>
<span id="cb22-605"><a href="#cb22-605" aria-hidden="true" tabindex="-1"></a>tbshed_pd <span class="ot">&lt;-</span> tbsegshed <span class="sc">|&gt;</span> </span>
<span id="cb22-606"><a href="#cb22-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>()</span>
<span id="cb22-607"><a href="#cb22-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-608"><a href="#cb22-608" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(F)</span>
<span id="cb22-609"><a href="#cb22-609" aria-hidden="true" tabindex="-1"></a>tbshed_buf <span class="ot">&lt;-</span> tbshed_pd <span class="sc">|&gt;</span> </span>
<span id="cb22-610"><a href="#cb22-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_union</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-611"><a href="#cb22-611" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_valid</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-612"><a href="#cb22-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="fl">0.2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-613"><a href="#cb22-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-614"><a href="#cb22-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-615"><a href="#cb22-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb22-616"><a href="#cb22-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-617"><a href="#cb22-617" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbshed_buf) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb22-618"><a href="#cb22-618" aria-hidden="true" tabindex="-1"></a><span class="co"># xmin  ymin  xmax  ymax </span></span>
<span id="cb22-619"><a href="#cb22-619" aria-hidden="true" tabindex="-1"></a><span class="co"># -83.1  27.2 -81.7  28.6</span></span>
<span id="cb22-620"><a href="#cb22-620" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.1</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb22-621"><a href="#cb22-621" aria-hidden="true" tabindex="-1"></a>ply_bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb22-622"><a href="#cb22-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-623"><a href="#cb22-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb22-624"><a href="#cb22-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-625"><a href="#cb22-625" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-626"><a href="#cb22-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>Stadia.StamenTonerLite) <span class="sc">|&gt;</span> </span>
<span id="cb22-627"><a href="#cb22-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> ply_bb, <span class="at">color=</span><span class="st">"green"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-628"><a href="#cb22-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> tbshed_pd)</span>
<span id="cb22-629"><a href="#cb22-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-630"><a href="#cb22-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-633"><a href="#cb22-633" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-634"><a href="#cb22-634" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fetch_prism</span></span>
<span id="cb22-635"><a href="#cb22-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-636"><a href="#cb22-636" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb22-637"><a href="#cb22-637" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr) <span class="co"># install.packages("furrr")</span></span>
<span id="cb22-638"><a href="#cb22-638" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb22-639"><a href="#cb22-639" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb22-640"><a href="#cb22-640" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb22-641"><a href="#cb22-641" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prism)</span>
<span id="cb22-642"><a href="#cb22-642" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb22-643"><a href="#cb22-643" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb22-644"><a href="#cb22-644" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb22-645"><a href="#cb22-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-646"><a href="#cb22-646" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb22-647"><a href="#cb22-647" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> n_cores)</span>
<span id="cb22-648"><a href="#cb22-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-649"><a href="#cb22-649" aria-hidden="true" tabindex="-1"></a>prism_archive_crop <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb22-650"><a href="#cb22-650" aria-hidden="true" tabindex="-1"></a>  type, temp_period, ...,</span>
<span id="cb22-651"><a href="#cb22-651" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb  =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>),</span>
<span id="cb22-652"><a href="#cb22-652" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span>, <span class="co"># WRONG: "+proj=longlat +ellps=GRS80 +no_defs"</span></span>
<span id="cb22-653"><a href="#cb22-653" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> F){</span>
<span id="cb22-654"><a href="#cb22-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-655"><a href="#cb22-655" aria-hidden="true" tabindex="-1"></a>  ply_bb <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> crs) <span class="sc">|&gt;</span> </span>
<span id="cb22-656"><a href="#cb22-656" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-657"><a href="#cb22-657" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb22-658"><a href="#cb22-658" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-659"><a href="#cb22-659" aria-hidden="true" tabindex="-1"></a>  pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(type, temp_period, ...)</span>
<span id="cb22-660"><a href="#cb22-660" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-661"><a href="#cb22-661" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pds)){ <span class="co"># i = 1</span></span>
<span id="cb22-662"><a href="#cb22-662" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">pd_stack</span>(pds[i]) <span class="sc">|&gt;</span> </span>
<span id="cb22-663"><a href="#cb22-663" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">rast</span>()</span>
<span id="cb22-664"><a href="#cb22-664" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-665"><a href="#cb22-665" aria-hidden="true" tabindex="-1"></a>    is_cropped <span class="ot">&lt;-</span> <span class="fu">all</span>(sf<span class="sc">::</span><span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">==</span> bb)</span>
<span id="cb22-666"><a href="#cb22-666" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>is_cropped){</span>
<span id="cb22-667"><a href="#cb22-667" aria-hidden="true" tabindex="-1"></a>      r_bil <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">sources</span>(r)</span>
<span id="cb22-668"><a href="#cb22-668" aria-hidden="true" tabindex="-1"></a>      r_bb <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(r, ply_bb, <span class="at">mask =</span> T, <span class="at">touches =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb22-669"><a href="#cb22-669" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">trim</span>()</span>
<span id="cb22-670"><a href="#cb22-670" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">writeRaster</span>(r_bb, r_bil, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb22-671"><a href="#cb22-671" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb22-672"><a href="#cb22-672" aria-hidden="true" tabindex="-1"></a>      bb_cropped <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(r_bb) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb22-673"><a href="#cb22-673" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(bb_cropped <span class="sc">==</span> bb))</span>
<span id="cb22-674"><a href="#cb22-674" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="fu">glue</span>(</span>
<span id="cb22-675"><a href="#cb22-675" aria-hidden="true" tabindex="-1"></a>          <span class="st">"bbox of clipped raster rounded to 1 decimal:</span></span>
<span id="cb22-676"><a href="#cb22-676" aria-hidden="true" tabindex="-1"></a><span class="st">              {paste(bb_cropped, collapse=', ')}</span></span>
<span id="cb22-677"><a href="#cb22-677" aria-hidden="true" tabindex="-1"></a><span class="st">           does not match input argument `bb`:</span></span>
<span id="cb22-678"><a href="#cb22-678" aria-hidden="true" tabindex="-1"></a><span class="st">              {paste(bb, collapse=', ')}"</span>))</span>
<span id="cb22-679"><a href="#cb22-679" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-680"><a href="#cb22-680" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-681"><a href="#cb22-681" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-682"><a href="#cb22-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-683"><a href="#cb22-683" aria-hidden="true" tabindex="-1"></a>yrs  <span class="ot">&lt;-</span> <span class="dv">1981</span><span class="sc">:</span><span class="fu">year</span>(<span class="fu">now</span>())</span>
<span id="cb22-684"><a href="#cb22-684" aria-hidden="true" tabindex="-1"></a>mos  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span></span>
<span id="cb22-685"><a href="#cb22-685" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>)  </span>
<span id="cb22-686"><a href="#cb22-686" aria-hidden="true" tabindex="-1"></a><span class="co"># skipping: "tmean" [avg(tmin,tmax)], vapor pressure ["vpdmin", "vpdmax"]</span></span>
<span id="cb22-687"><a href="#cb22-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-688"><a href="#cb22-688" aria-hidden="true" tabindex="-1"></a><span class="co"># ((today() - days(1)) - date("1981-01-01")) |&gt; as.integer() * length(vars) # 63,304 dirs expected in tmp/prism</span></span>
<span id="cb22-689"><a href="#cb22-689" aria-hidden="true" tabindex="-1"></a>n_dirs <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>), <span class="at">type =</span> <span class="st">"directory"</span>) <span class="sc">|&gt;</span> <span class="fu">length</span>()</span>
<span id="cb22-690"><a href="#cb22-690" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{n_dirs} ~ {Sys.time()}"</span>))</span>
<span id="cb22-691"><a href="#cb22-691" aria-hidden="true" tabindex="-1"></a><span class="co"># 1540 ~ 2024-05-02 18:28:41.717828</span></span>
<span id="cb22-692"><a href="#cb22-692" aria-hidden="true" tabindex="-1"></a><span class="co"># 2527 ~ 2024-05-02 18:46:32.97783</span></span>
<span id="cb22-693"><a href="#cb22-693" aria-hidden="true" tabindex="-1"></a><span class="co"># 3357 ~ 2024-05-02 18:59:52.753584</span></span>
<span id="cb22-694"><a href="#cb22-694" aria-hidden="true" tabindex="-1"></a>n_all <span class="ot">&lt;-</span> <span class="dv">63304</span></span>
<span id="cb22-695"><a href="#cb22-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-696"><a href="#cb22-696" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="dv">1540</span></span>
<span id="cb22-697"><a href="#cb22-697" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(</span>
<span id="cb22-698"><a href="#cb22-698" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2024-05-02 18:28:41.717828"</span>, <span class="st">"Ymd HMS"</span>)</span>
<span id="cb22-699"><a href="#cb22-699" aria-hidden="true" tabindex="-1"></a>n2 <span class="ot">&lt;-</span> <span class="dv">3357</span></span>
<span id="cb22-700"><a href="#cb22-700" aria-hidden="true" tabindex="-1"></a>t2 <span class="ot">&lt;-</span> <span class="fu">parse_date_time</span>(</span>
<span id="cb22-701"><a href="#cb22-701" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2024-05-02 18:59:52.753584"</span>, <span class="st">"Ymd HMS"</span>)</span>
<span id="cb22-702"><a href="#cb22-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-703"><a href="#cb22-703" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">difftime</span>(t2, t1, <span class="at">units =</span> <span class="st">"secs"</span>) <span class="sc">|&gt;</span> <span class="fu">as.integer</span>()</span>
<span id="cb22-704"><a href="#cb22-704" aria-hidden="true" tabindex="-1"></a>dn <span class="ot">&lt;-</span> n2 <span class="sc">-</span> n1</span>
<span id="cb22-705"><a href="#cb22-705" aria-hidden="true" tabindex="-1"></a>n_togo <span class="ot">&lt;-</span> n_all <span class="sc">-</span> n2</span>
<span id="cb22-706"><a href="#cb22-706" aria-hidden="true" tabindex="-1"></a>eta <span class="ot">&lt;-</span> t2 <span class="sc">+</span> <span class="fu">seconds</span>(dn <span class="sc">/</span> dt <span class="sc">*</span> n_togo)</span>
<span id="cb22-707"><a href="#cb22-707" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"ETA: {eta}"</span>))</span>
<span id="cb22-708"><a href="#cb22-708" aria-hidden="true" tabindex="-1"></a><span class="co"># ETA: 2024-05-03 10:20:03.1543</span></span>
<span id="cb22-709"><a href="#cb22-709" aria-hidden="true" tabindex="-1"></a><span class="co"># ETA: 2024-05-03 11:10:09.588966</span></span>
<span id="cb22-710"><a href="#cb22-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-711"><a href="#cb22-711" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb22-712"><a href="#cb22-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-713"><a href="#cb22-713" aria-hidden="true" tabindex="-1"></a>yesterday <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb22-714"><a href="#cb22-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-715"><a href="#cb22-715" aria-hidden="true" tabindex="-1"></a>d_ymv <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb22-716"><a href="#cb22-716" aria-hidden="true" tabindex="-1"></a>  <span class="at">yr =</span> yrs) <span class="sc">|&gt;</span> </span>
<span id="cb22-717"><a href="#cb22-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(</span>
<span id="cb22-718"><a href="#cb22-718" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">mo =</span> mos)) <span class="sc">|&gt;</span> </span>
<span id="cb22-719"><a href="#cb22-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(</span>
<span id="cb22-720"><a href="#cb22-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">var =</span> vars)) <span class="sc">|&gt;</span> </span>
<span id="cb22-721"><a href="#cb22-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-722"><a href="#cb22-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_beg =</span> <span class="fu">map2_chr</span>(yr, mo, \(yr, mo){</span>
<span id="cb22-723"><a href="#cb22-723" aria-hidden="true" tabindex="-1"></a>      <span class="fu">date</span>(<span class="fu">glue</span>(<span class="st">"{yr}-{mo}-01"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-724"><a href="#cb22-724" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>() }),</span>
<span id="cb22-725"><a href="#cb22-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_end =</span> <span class="fu">map_chr</span>(date_beg, \(date_beg){</span>
<span id="cb22-726"><a href="#cb22-726" aria-hidden="true" tabindex="-1"></a>      <span class="co"># date_beg &lt;- "2024-05-01"</span></span>
<span id="cb22-727"><a href="#cb22-727" aria-hidden="true" tabindex="-1"></a>      date_end <span class="ot">&lt;-</span> (<span class="fu">date</span>(date_beg) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span>)) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb22-728"><a href="#cb22-728" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (date_end <span class="sc">&gt;</span> yesterday)</span>
<span id="cb22-729"><a href="#cb22-729" aria-hidden="true" tabindex="-1"></a>        date_end <span class="ot">&lt;-</span> yesterday</span>
<span id="cb22-730"><a href="#cb22-730" aria-hidden="true" tabindex="-1"></a>      date_end <span class="sc">|&gt;</span> </span>
<span id="cb22-731"><a href="#cb22-731" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>()</span>
<span id="cb22-732"><a href="#cb22-732" aria-hidden="true" tabindex="-1"></a>    }) ) <span class="sc">|&gt;</span> </span>
<span id="cb22-733"><a href="#cb22-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">date</span>(date_beg) <span class="sc">&lt;=</span> yesterday) <span class="sc">|&gt;</span> </span>
<span id="cb22-734"><a href="#cb22-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date_beg, date_end, var) <span class="sc">|&gt;</span> </span>
<span id="cb22-735"><a href="#cb22-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date_beg, date_end, var) <span class="sc">|&gt;</span> </span>
<span id="cb22-736"><a href="#cb22-736" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(date(date_beg) &gt;= date("1981-03-01")) |&gt; </span></span>
<span id="cb22-737"><a href="#cb22-737" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rstudio.marinesensitivity.org:</span></span>
<span id="cb22-738"><a href="#cb22-738" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(</span></span>
<span id="cb22-739"><a href="#cb22-739" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_beg) &gt;= date("1981-09-01"),</span></span>
<span id="cb22-740"><a href="#cb22-740" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_end) &lt;  date("1986-07-01")) # |&gt; </span></span>
<span id="cb22-741"><a href="#cb22-741" aria-hidden="true" tabindex="-1"></a>  <span class="co"># laptop:</span></span>
<span id="cb22-742"><a href="#cb22-742" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(</span></span>
<span id="cb22-743"><a href="#cb22-743" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   date(date_beg) &gt;= date("1986-12-01")) # |&gt;</span></span>
<span id="cb22-744"><a href="#cb22-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-745"><a href="#cb22-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_files =</span> <span class="fu">pmap_int</span>(<span class="fu">list</span>(</span>
<span id="cb22-746"><a href="#cb22-746" aria-hidden="true" tabindex="-1"></a>      <span class="at">date_beg =</span> date_beg,</span>
<span id="cb22-747"><a href="#cb22-747" aria-hidden="true" tabindex="-1"></a>      <span class="at">date_end =</span> date_end,</span>
<span id="cb22-748"><a href="#cb22-748" aria-hidden="true" tabindex="-1"></a>      <span class="at">var      =</span> var), \(date_beg, date_end, var){</span>
<span id="cb22-749"><a href="#cb22-749" aria-hidden="true" tabindex="-1"></a>        prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(</span>
<span id="cb22-750"><a href="#cb22-750" aria-hidden="true" tabindex="-1"></a>          var, <span class="st">"daily"</span>,</span>
<span id="cb22-751"><a href="#cb22-751" aria-hidden="true" tabindex="-1"></a>          <span class="at">minDate =</span> date_beg,</span>
<span id="cb22-752"><a href="#cb22-752" aria-hidden="true" tabindex="-1"></a>          <span class="at">maxDate =</span> date_end) <span class="sc">|&gt;</span></span>
<span id="cb22-753"><a href="#cb22-753" aria-hidden="true" tabindex="-1"></a>          <span class="fu">length</span>() }),</span>
<span id="cb22-754"><a href="#cb22-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_days =</span> <span class="fu">map2_int</span>(date_beg, date_end, \(date_beg, date_end){</span>
<span id="cb22-755"><a href="#cb22-755" aria-hidden="true" tabindex="-1"></a>      <span class="fu">difftime</span>(<span class="fu">date</span>(date_end), <span class="fu">date</span>(date_beg), <span class="at">units =</span> <span class="st">"days"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-756"><a href="#cb22-756" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.integer</span>() }),</span>
<span id="cb22-757"><a href="#cb22-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_done =</span> n_files <span class="sc">/</span> n_days)</span>
<span id="cb22-758"><a href="#cb22-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-759"><a href="#cb22-759" aria-hidden="true" tabindex="-1"></a>prism_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"tmp/prism.csv"</span>)</span>
<span id="cb22-760"><a href="#cb22-760" aria-hidden="true" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(d_ymv, prism_csv)</span>
<span id="cb22-761"><a href="#cb22-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-762"><a href="#cb22-762" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: delete all extraneous station files</span></span>
<span id="cb22-763"><a href="#cb22-763" aria-hidden="true" tabindex="-1"></a><span class="co"># find . -name "*_bil.stn.csv" -type f -delete</span></span>
<span id="cb22-764"><a href="#cb22-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-765"><a href="#cb22-765" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: on server remove dir </span></span>
<span id="cb22-766"><a href="#cb22-766" aria-hidden="true" tabindex="-1"></a><span class="co"># dir='PRISM_ppt_provisional_4kmD2_20231101_bil'</span></span>
<span id="cb22-767"><a href="#cb22-767" aria-hidden="true" tabindex="-1"></a><span class="co"># re='PRISM_(.*)_(.*)_(.*)_(.*)_bil'</span></span>
<span id="cb22-768"><a href="#cb22-768" aria-hidden="true" tabindex="-1"></a><span class="co"># [[ $dir =~ $re ]] &amp;&amp; date="${BASH_REMATCH[4]}" &amp;&amp; echo "date: $date for $dir"</span></span>
<span id="cb22-769"><a href="#cb22-769" aria-hidden="true" tabindex="-1"></a><span class="co"># var=${dir//$re/\1}</span></span>
<span id="cb22-770"><a href="#cb22-770" aria-hidden="true" tabindex="-1"></a><span class="co"># type=${dir//$re/\2}</span></span>
<span id="cb22-771"><a href="#cb22-771" aria-hidden="true" tabindex="-1"></a><span class="co"># res=${dir//$re/\3}</span></span>
<span id="cb22-772"><a href="#cb22-772" aria-hidden="true" tabindex="-1"></a><span class="co"># date=${dir//$re/\4}</span></span>
<span id="cb22-773"><a href="#cb22-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-774"><a href="#cb22-774" aria-hidden="true" tabindex="-1"></a><span class="fu">future_pmap</span>(d_ymv, \(date_beg, date_end, var){</span>
<span id="cb22-775"><a href="#cb22-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-776"><a href="#cb22-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb22-777"><a href="#cb22-777" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-778"><a href="#cb22-778" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch PRISM national rasters</span></span>
<span id="cb22-779"><a href="#cb22-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_prism_dailys</span>(</span>
<span id="cb22-780"><a href="#cb22-780" aria-hidden="true" tabindex="-1"></a>    <span class="at">type    =</span> var, </span>
<span id="cb22-781"><a href="#cb22-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb22-782"><a href="#cb22-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end,</span>
<span id="cb22-783"><a href="#cb22-783" aria-hidden="true" tabindex="-1"></a>    <span class="at">keepZip =</span> F)</span>
<span id="cb22-784"><a href="#cb22-784" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-785"><a href="#cb22-785" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any duplicates: stable &gt; provisional &gt; early</span></span>
<span id="cb22-786"><a href="#cb22-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_clean</span>(</span>
<span id="cb22-787"><a href="#cb22-787" aria-hidden="true" tabindex="-1"></a>    var, <span class="st">"daily"</span>, </span>
<span id="cb22-788"><a href="#cb22-788" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb22-789"><a href="#cb22-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end)</span>
<span id="cb22-790"><a href="#cb22-790" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-791"><a href="#cb22-791" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim rasters to bounding box</span></span>
<span id="cb22-792"><a href="#cb22-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(</span>
<span id="cb22-793"><a href="#cb22-793" aria-hidden="true" tabindex="-1"></a>    var, <span class="st">"daily"</span>, </span>
<span id="cb22-794"><a href="#cb22-794" aria-hidden="true" tabindex="-1"></a>    <span class="at">minDate =</span> date_beg,</span>
<span id="cb22-795"><a href="#cb22-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxDate =</span> date_end)</span>
<span id="cb22-796"><a href="#cb22-796" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb22-797"><a href="#cb22-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-798"><a href="#cb22-798" aria-hidden="true" tabindex="-1"></a><span class="co"># clear future processes</span></span>
<span id="cb22-799"><a href="#cb22-799" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(<span class="fu">plan</span>(), <span class="st">"sequential"</span>)) <span class="fu">plan</span>(sequential)</span>
<span id="cb22-800"><a href="#cb22-800" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-801"><a href="#cb22-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-804"><a href="#cb22-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-805"><a href="#cb22-805" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crop_prism</span></span>
<span id="cb22-806"><a href="#cb22-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-807"><a href="#cb22-807" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb22-808"><a href="#cb22-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-809"><a href="#cb22-809" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> vars)</span>
<span id="cb22-810"><a href="#cb22-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(var, <span class="st">"daily"</span>)</span>
<span id="cb22-811"><a href="#cb22-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-812"><a href="#cb22-812" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-813"><a href="#cb22-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-816"><a href="#cb22-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-817"><a href="#cb22-817" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prism_bil2tif</span></span>
<span id="cb22-818"><a href="#cb22-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-819"><a href="#cb22-819" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr) <span class="co"># install.packages("furrr")</span></span>
<span id="cb22-820"><a href="#cb22-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-821"><a href="#cb22-821" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb22-822"><a href="#cb22-822" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> n_cores)</span>
<span id="cb22-823"><a href="#cb22-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-824"><a href="#cb22-824" aria-hidden="true" tabindex="-1"></a>dir_prism <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>)</span>
<span id="cb22-825"><a href="#cb22-825" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(dir_prism)</span>
<span id="cb22-826"><a href="#cb22-826" aria-hidden="true" tabindex="-1"></a>vars      <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"tdmean"</span>, <span class="st">"ppt"</span>)</span>
<span id="cb22-827"><a href="#cb22-827" aria-hidden="true" tabindex="-1"></a>dates_all <span class="ot">&lt;-</span> (<span class="fu">date</span>(<span class="st">"1981-01-01"</span>)<span class="sc">:</span>(<span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>))) <span class="sc">|&gt;</span> <span class="fu">as.Date</span>()</span>
<span id="cb22-828"><a href="#cb22-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-829"><a href="#cb22-829" aria-hidden="true" tabindex="-1"></a>rx   <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb22-830"><a href="#cb22-830" aria-hidden="true" tabindex="-1"></a>d_done <span class="ot">&lt;-</span> <span class="fu">tibble</span>()</span>
<span id="cb22-831"><a href="#cb22-831" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (var <span class="cf">in</span> vars){ <span class="co"># var &lt;- vars[4]</span></span>
<span id="cb22-832"><a href="#cb22-832" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-833"><a href="#cb22-833" aria-hidden="true" tabindex="-1"></a>  pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(<span class="at">type =</span> var, <span class="at">temp_period =</span> <span class="st">"daily"</span>)</span>
<span id="cb22-834"><a href="#cb22-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-835"><a href="#cb22-835" aria-hidden="true" tabindex="-1"></a>  d_var <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb22-836"><a href="#cb22-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">pd =</span> pds) <span class="sc">|&gt;</span> </span>
<span id="cb22-837"><a href="#cb22-837" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb22-838"><a href="#cb22-838" aria-hidden="true" tabindex="-1"></a>      <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb22-839"><a href="#cb22-839" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb22-840"><a href="#cb22-840" aria-hidden="true" tabindex="-1"></a>      <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-841"><a href="#cb22-841" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>) ) </span>
<span id="cb22-842"><a href="#cb22-842" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-843"><a href="#cb22-843" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(d_done) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb22-844"><a href="#cb22-844" aria-hidden="true" tabindex="-1"></a>    d_done <span class="ot">&lt;-</span> d_var</span>
<span id="cb22-845"><a href="#cb22-845" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb22-846"><a href="#cb22-846" aria-hidden="true" tabindex="-1"></a>    d_done <span class="ot">&lt;-</span> d_done <span class="sc">|&gt;</span> </span>
<span id="cb22-847"><a href="#cb22-847" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(d_var)</span>
<span id="cb22-848"><a href="#cb22-848" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-849"><a href="#cb22-849" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-850"><a href="#cb22-850" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_done$var)</span></span>
<span id="cb22-851"><a href="#cb22-851" aria-hidden="true" tabindex="-1"></a><span class="co">#    ppt tdmean   tmax   tmin </span></span>
<span id="cb22-852"><a href="#cb22-852" aria-hidden="true" tabindex="-1"></a><span class="co">#  15759  15807  15746  15805</span></span>
<span id="cb22-853"><a href="#cb22-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-854"><a href="#cb22-854" aria-hidden="true" tabindex="-1"></a>d_todo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb22-855"><a href="#cb22-855" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> vars) <span class="sc">|&gt;</span> </span>
<span id="cb22-856"><a href="#cb22-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(<span class="fu">tibble</span>(</span>
<span id="cb22-857"><a href="#cb22-857" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> dates_all)) <span class="sc">|&gt;</span> </span>
<span id="cb22-858"><a href="#cb22-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(</span>
<span id="cb22-859"><a href="#cb22-859" aria-hidden="true" tabindex="-1"></a>    d_done <span class="sc">|&gt;</span> </span>
<span id="cb22-860"><a href="#cb22-860" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(var, date),</span>
<span id="cb22-861"><a href="#cb22-861" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"var"</span>))</span>
<span id="cb22-862"><a href="#cb22-862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-863"><a href="#cb22-863" aria-hidden="true" tabindex="-1"></a>prism_dates_crop <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb22-864"><a href="#cb22-864" aria-hidden="true" tabindex="-1"></a>    var, </span>
<span id="cb22-865"><a href="#cb22-865" aria-hidden="true" tabindex="-1"></a>    dates, </span>
<span id="cb22-866"><a href="#cb22-866" aria-hidden="true" tabindex="-1"></a>    <span class="at">dir_prism =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>)){</span>
<span id="cb22-867"><a href="#cb22-867" aria-hidden="true" tabindex="-1"></a>  <span class="co"># var = "tmin"; dates = date("2024-05-01"); dir_prism = here::here("tmp/prism")</span></span>
<span id="cb22-868"><a href="#cb22-868" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb22-869"><a href="#cb22-869" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep -v stable | grep -v provisional | tail</span></span>
<span id="cb22-870"><a href="#cb22-870" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_stable      | head : PRISM_tmin_stable_4kmD2_19810101_bil</span></span>
<span id="cb22-871"><a href="#cb22-871" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_stable      | tail : PRISM_tmin_stable_4kmD2_20231031_bil</span></span>
<span id="cb22-872"><a href="#cb22-872" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_provisional | head : PRISM_tmin_provisional_4kmD2_20231101_bil</span></span>
<span id="cb22-873"><a href="#cb22-873" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_provisional | tail : PRISM_tmin_provisional_4kmD2_20240430_bil</span></span>
<span id="cb22-874"><a href="#cb22-874" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_early       | head : PRISM_tmin_early_4kmD2_20240501_bil</span></span>
<span id="cb22-875"><a href="#cb22-875" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ls -l | grep tmin_early       | tail : PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb22-876"><a href="#cb22-876" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rm -r PRISM_tmin_stable_4kmD2_19810101_bil \</span></span>
<span id="cb22-877"><a href="#cb22-877" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_stable_4kmD2_20231031_bil \</span></span>
<span id="cb22-878"><a href="#cb22-878" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_provisional_4kmD2_20231101_bil \</span></span>
<span id="cb22-879"><a href="#cb22-879" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_provisional_4kmD2_20240430_bil \</span></span>
<span id="cb22-880"><a href="#cb22-880" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_early_4kmD2_20240501_bil \</span></span>
<span id="cb22-881"><a href="#cb22-881" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       PRISM_tmin_early_4kmD2_20240509_bil</span></span>
<span id="cb22-882"><a href="#cb22-882" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prism_dates_crop(</span></span>
<span id="cb22-883"><a href="#cb22-883" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   "tmin", </span></span>
<span id="cb22-884"><a href="#cb22-884" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   c("1981-01-01","2023-10-31", "2023-11-01", "2024-04-30", "2024-05-01") # , "2024-05-09"))</span></span>
<span id="cb22-885"><a href="#cb22-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-886"><a href="#cb22-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_set_dl_dir</span>(dir_prism)</span>
<span id="cb22-887"><a href="#cb22-887" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-888"><a href="#cb22-888" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fetch PRISM national rasters</span></span>
<span id="cb22-889"><a href="#cb22-889" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get_prism_dailys(</span></span>
<span id="cb22-890"><a href="#cb22-890" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   type    = var,</span></span>
<span id="cb22-891"><a href="#cb22-891" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dates   = dates,</span></span>
<span id="cb22-892"><a href="#cb22-892" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   keepZip = F)</span></span>
<span id="cb22-893"><a href="#cb22-893" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-894"><a href="#cb22-894" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any duplicates: stable &gt; provisional &gt; early</span></span>
<span id="cb22-895"><a href="#cb22-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_clean</span>(</span>
<span id="cb22-896"><a href="#cb22-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">type        =</span> var, </span>
<span id="cb22-897"><a href="#cb22-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_period =</span> <span class="st">"daily"</span>, </span>
<span id="cb22-898"><a href="#cb22-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">dates       =</span> dates)</span>
<span id="cb22-899"><a href="#cb22-899" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-900"><a href="#cb22-900" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bil &lt;- prism_archive_subset(</span></span>
<span id="cb22-901"><a href="#cb22-901" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   type        = var,</span></span>
<span id="cb22-902"><a href="#cb22-902" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   temp_period = "daily",</span></span>
<span id="cb22-903"><a href="#cb22-903" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   dates       = dates) |&gt;</span></span>
<span id="cb22-904"><a href="#cb22-904" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   pd_to_file()</span></span>
<span id="cb22-905"><a href="#cb22-905" aria-hidden="true" tabindex="-1"></a>  <span class="co"># crs_r &lt;- rast(bil) |&gt; crs(proj=T) </span></span>
<span id="cb22-906"><a href="#cb22-906" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(paste(glue("{basename(bil)}: {crs_r}"),"\n"))</span></span>
<span id="cb22-907"><a href="#cb22-907" aria-hidden="true" tabindex="-1"></a>  <span class="co"># early (PRISM_tmin_early_4kmD2_20240509_bil):</span></span>
<span id="cb22-908"><a href="#cb22-908" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   "+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb22-909"><a href="#cb22-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-910"><a href="#cb22-910" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim rasters to bounding box</span></span>
<span id="cb22-911"><a href="#cb22-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prism_archive_crop</span>(</span>
<span id="cb22-912"><a href="#cb22-912" aria-hidden="true" tabindex="-1"></a>    <span class="at">type        =</span> var,</span>
<span id="cb22-913"><a href="#cb22-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_period =</span> <span class="st">"daily"</span>,</span>
<span id="cb22-914"><a href="#cb22-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">dates       =</span> dates)</span>
<span id="cb22-915"><a href="#cb22-915" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-916"><a href="#cb22-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-917"><a href="#cb22-917" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_dates_crop</span>(</span>
<span id="cb22-918"><a href="#cb22-918" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tmin"</span>,</span>
<span id="cb22-919"><a href="#cb22-919" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"1981-01-01"</span>,<span class="st">"2023-10-31"</span>, <span class="st">"2023-11-01"</span>, <span class="st">"2024-04-30"</span>, <span class="st">"2024-05-01"</span>)) <span class="co"># , "2024-05-09"))</span></span>
<span id="cb22-920"><a href="#cb22-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-921"><a href="#cb22-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-922"><a href="#cb22-922" aria-hidden="true" tabindex="-1"></a><span class="co"># 20240430_bil</span></span>
<span id="cb22-923"><a href="#cb22-923" aria-hidden="true" tabindex="-1"></a><span class="co"># ls -l | grep -v stable | grep -v provisional | tail</span></span>
<span id="cb22-924"><a href="#cb22-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-925"><a href="#cb22-925" aria-hidden="true" tabindex="-1"></a>d_todo <span class="sc">|&gt;</span> </span>
<span id="cb22-926"><a href="#cb22-926" aria-hidden="true" tabindex="-1"></a>  <span class="co"># future_pmap(prism_dates_crop)</span></span>
<span id="cb22-927"><a href="#cb22-927" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(prism_dates_crop)</span>
<span id="cb22-928"><a href="#cb22-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-929"><a href="#cb22-929" aria-hidden="true" tabindex="-1"></a>var  <span class="ot">&lt;-</span> vars[<span class="dv">1</span>] <span class="co"># </span><span class="al">TODO</span><span class="co">: loop all vars</span></span>
<span id="cb22-930"><a href="#cb22-930" aria-hidden="true" tabindex="-1"></a> <span class="co"># check only one crs and bb</span></span>
<span id="cb22-931"><a href="#cb22-931" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_bils<span class="sc">$</span>crs)</span>
<span id="cb22-932"><a href="#cb22-932" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_bils<span class="sc">$</span>bb)</span>
<span id="cb22-933"><a href="#cb22-933" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-934"><a href="#cb22-934" aria-hidden="true" tabindex="-1"></a><span class="co"># save daily climatologies ----</span></span>
<span id="cb22-935"><a href="#cb22-935" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-936"><a href="#cb22-936" aria-hidden="true" tabindex="-1"></a>  fs)</span>
<span id="cb22-937"><a href="#cb22-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-938"><a href="#cb22-938" aria-hidden="true" tabindex="-1"></a>rx   <span class="ot">&lt;-</span> <span class="st">"PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb22-939"><a href="#cb22-939" aria-hidden="true" tabindex="-1"></a>d_bils <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb22-940"><a href="#cb22-940" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">dir_ls</span>(dir_prism, <span class="at">glob =</span> <span class="st">"*.bil"</span>, <span class="at">recurse =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb22-941"><a href="#cb22-941" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-942"><a href="#cb22-942" aria-hidden="true" tabindex="-1"></a>    <span class="at">pd    =</span> <span class="fu">basename</span>(path_bil) <span class="sc">|&gt;</span> <span class="fu">path_ext_remove</span>(),</span>
<span id="cb22-943"><a href="#cb22-943" aria-hidden="true" tabindex="-1"></a>    <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb22-944"><a href="#cb22-944" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb22-945"><a href="#cb22-945" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-946"><a href="#cb22-946" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>),</span>
<span id="cb22-947"><a href="#cb22-947" aria-hidden="true" tabindex="-1"></a>    <span class="at">md    =</span> <span class="fu">format</span>(date, <span class="st">"%m-%d"</span>))</span>
<span id="cb22-948"><a href="#cb22-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-949"><a href="#cb22-949" aria-hidden="true" tabindex="-1"></a>crs <span class="ot">=</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb22-950"><a href="#cb22-950" aria-hidden="true" tabindex="-1"></a>bb  <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">82.9</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">81.7</span>, <span class="at">ymax =</span> <span class="fl">28.6</span>)</span>
<span id="cb22-951"><a href="#cb22-951" aria-hidden="true" tabindex="-1"></a>ply_bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(bb, <span class="at">crs =</span> <span class="fu">crs</span>(r, <span class="at">proj=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb22-952"><a href="#cb22-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-953"><a href="#cb22-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb22-954"><a href="#cb22-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-955"><a href="#cb22-955" aria-hidden="true" tabindex="-1"></a>d_bils <span class="sc">|&gt;</span> </span>
<span id="cb22-956"><a href="#cb22-956" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(md, date, var) <span class="sc">|&gt;</span>  <span class="co"># order by: month-day, date, variable</span></span>
<span id="cb22-957"><a href="#cb22-957" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(md, path) <span class="sc">|&gt;</span> </span>
<span id="cb22-958"><a href="#cb22-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(md) <span class="sc">|&gt;</span> </span>
<span id="cb22-959"><a href="#cb22-959" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">paths =</span> path) <span class="sc">|&gt;</span> </span>
<span id="cb22-960"><a href="#cb22-960" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-961"><a href="#cb22-961" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(md <span class="sc">==</span> <span class="st">"01-01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-962"><a href="#cb22-962" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pull(md) %&gt;% .[92]</span></span>
<span id="cb22-963"><a href="#cb22-963" aria-hidden="true" tabindex="-1"></a>  <span class="co"># slice(91:93) |&gt; </span></span>
<span id="cb22-964"><a href="#cb22-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pwalk</span>(\(md, paths){</span>
<span id="cb22-965"><a href="#cb22-965" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-966"><a href="#cb22-966" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (md <span class="sc">==</span> <span class="st">"01-01"</span>)</span>
<span id="cb22-967"><a href="#cb22-967" aria-hidden="true" tabindex="-1"></a>      <span class="fu">browser</span>()</span>
<span id="cb22-968"><a href="#cb22-968" aria-hidden="true" tabindex="-1"></a>    r_tif <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"tmp/daily/prism_daily_{md}.tif"</span>))</span>
<span id="cb22-969"><a href="#cb22-969" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(r_tif)){</span>
<span id="cb22-970"><a href="#cb22-970" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{basename(r_tif)} exists, skipping"</span>))</span>
<span id="cb22-971"><a href="#cb22-971" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb22-972"><a href="#cb22-972" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-973"><a href="#cb22-973" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-974"><a href="#cb22-974" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{basename(r_tif)} building"</span>))</span>
<span id="cb22-975"><a href="#cb22-975" aria-hidden="true" tabindex="-1"></a>    paths <span class="sc">|&gt;</span> </span>
<span id="cb22-976"><a href="#cb22-976" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb22-977"><a href="#cb22-977" aria-hidden="true" tabindex="-1"></a>        <span class="at">ext =</span> <span class="fu">map_chr</span>(</span>
<span id="cb22-978"><a href="#cb22-978" aria-hidden="true" tabindex="-1"></a>          path, \(p){ </span>
<span id="cb22-979"><a href="#cb22-979" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ext</span>(<span class="fu">rast</span>(p)) <span class="sc">|&gt;</span> <span class="fu">as.vector</span>() <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-980"><a href="#cb22-980" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(<span class="at">collapse=</span><span class="st">","</span>) } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb22-981"><a href="#cb22-981" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(ext <span class="sc">==</span> <span class="st">"-125,-66.5,24.1,49.9"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-982"><a href="#cb22-982" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(path) <span class="sc">|&gt;</span>  <span class="co">#  |&gt; basename()</span></span>
<span id="cb22-983"><a href="#cb22-983" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [1] "PRISM_tdmean_stable_4kmD2_19920401_bil.bil"</span></span>
<span id="cb22-984"><a href="#cb22-984" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [2] "PRISM_tdmean_stable_4kmD2_19960401_bil.bil"</span></span>
<span id="cb22-985"><a href="#cb22-985" aria-hidden="true" tabindex="-1"></a>      <span class="co"># [3] "PRISM_ppt_stable_4kmD2_20030401_bil.bil" </span></span>
<span id="cb22-986"><a href="#cb22-986" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pwalk</span>(\(path){</span>
<span id="cb22-987"><a href="#cb22-987" aria-hidden="true" tabindex="-1"></a>        r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(path)</span>
<span id="cb22-988"><a href="#cb22-988" aria-hidden="true" tabindex="-1"></a>        r_bb <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(r, ply_bb, <span class="at">mask =</span> T, <span class="at">touches =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb22-989"><a href="#cb22-989" aria-hidden="true" tabindex="-1"></a>          terra<span class="sc">::</span><span class="fu">trim</span>()</span>
<span id="cb22-990"><a href="#cb22-990" aria-hidden="true" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="fu">tempdir</span>(), <span class="at">fileext =</span> <span class="st">".bil"</span>)</span>
<span id="cb22-991"><a href="#cb22-991" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dir.create</span>(<span class="fu">dirname</span>(tmp), <span class="at">recursive =</span> T, <span class="at">showWarnings =</span> F)</span>
<span id="cb22-992"><a href="#cb22-992" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">writeRaster</span>(<span class="at">x =</span> r_bb, <span class="at">filename =</span> tmp, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb22-993"><a href="#cb22-993" aria-hidden="true" tabindex="-1"></a>        terra<span class="sc">::</span><span class="fu">writeRaster</span>(<span class="fu">rast</span>(tmp), path, <span class="at">filetype =</span> <span class="st">"EHdr"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb22-994"><a href="#cb22-994" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb22-995"><a href="#cb22-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-996"><a href="#cb22-996" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">unlist</span>(paths))</span>
<span id="cb22-997"><a href="#cb22-997" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crs</span>(r) <span class="ot">&lt;-</span> <span class="st">"+proj=longlat +datum=NAD83 +no_defs"</span></span>
<span id="cb22-998"><a href="#cb22-998" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">writeRaster</span>(</span>
<span id="cb22-999"><a href="#cb22-999" aria-hidden="true" tabindex="-1"></a>      r, r_tif, </span>
<span id="cb22-1000"><a href="#cb22-1000" aria-hidden="true" tabindex="-1"></a>      <span class="at">datatype =</span> <span class="st">"FLT4S"</span>,</span>
<span id="cb22-1001"><a href="#cb22-1001" aria-hidden="true" tabindex="-1"></a>      <span class="at">filetype =</span> <span class="st">"GTiff"</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>),</span>
<span id="cb22-1002"><a href="#cb22-1002" aria-hidden="true" tabindex="-1"></a>      <span class="at">overwrite =</span> T)</span>
<span id="cb22-1003"><a href="#cb22-1003" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb22-1004"><a href="#cb22-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1005"><a href="#cb22-1005" aria-hidden="true" tabindex="-1"></a><span class="co"># Yay: avg filesize = 0.5 MB * 365/6 (leap day) = 179 MB</span></span>
<span id="cb22-1006"><a href="#cb22-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1007"><a href="#cb22-1007" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rast</span>(r_tif)</span>
<span id="cb22-1008"><a href="#cb22-1008" aria-hidden="true" tabindex="-1"></a>d_r <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pd =</span> <span class="fu">names</span>(r)) <span class="sc">|&gt;</span> </span>
<span id="cb22-1009"><a href="#cb22-1009" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-1010"><a href="#cb22-1010" aria-hidden="true" tabindex="-1"></a>    <span class="at">var   =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>),</span>
<span id="cb22-1011"><a href="#cb22-1011" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb22-1012"><a href="#cb22-1012" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">str_replace</span>(pd, rx, <span class="st">"</span><span class="sc">\\</span><span class="st">4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1013"><a href="#cb22-1013" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.Date</span>(<span class="at">format =</span> <span class="st">"%Y%m%d"</span>) ) </span>
<span id="cb22-1014"><a href="#cb22-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1015"><a href="#cb22-1015" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">names</span>(r)) <span class="co"># 176</span></span>
<span id="cb22-1016"><a href="#cb22-1016" aria-hidden="true" tabindex="-1"></a><span class="fu">plet</span>(r[[<span class="dv">100</span>]], <span class="at">tiles=</span>providers<span class="sc">$</span>CartoDB.DarkMatter)</span>
<span id="cb22-1017"><a href="#cb22-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1018"><a href="#cb22-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1019"><a href="#cb22-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1020"><a href="#cb22-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1021"><a href="#cb22-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1022"><a href="#cb22-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fetch_latest_prism}</span></span>
<span id="cb22-1023"><a href="#cb22-1023" aria-hidden="true" tabindex="-1"></a><span class="in">librarian::shelf(</span></span>
<span id="cb22-1024"><a href="#cb22-1024" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr, fs, glue, here, lubridate, purrr, sf, stringr, terra, tibble, tidyr)</span></span>
<span id="cb22-1025"><a href="#cb22-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1026"><a href="#cb22-1026" aria-hidden="true" tabindex="-1"></a><span class="in">dir_daily &lt;- here::here("data/prism")</span></span>
<span id="cb22-1027"><a href="#cb22-1027" aria-hidden="true" tabindex="-1"></a><span class="in"># https://services.nacse.org/prism/data/public/4km/ppt/20240512</span></span>
<span id="cb22-1028"><a href="#cb22-1028" aria-hidden="true" tabindex="-1"></a><span class="in">vars      &lt;- c("tmin", "tmax", "tdmean", "ppt")</span></span>
<span id="cb22-1029"><a href="#cb22-1029" aria-hidden="true" tabindex="-1"></a><span class="in">prism_beg &lt;- lubridate::date("1981-01-01")</span></span>
<span id="cb22-1030"><a href="#cb22-1030" aria-hidden="true" tabindex="-1"></a><span class="in"># yesterday &lt;- lubridate::today(tzone = "UTC") - lubridate::days(1)</span></span>
<span id="cb22-1031"><a href="#cb22-1031" aria-hidden="true" tabindex="-1"></a><span class="in"># accommodate up to 12 hrs to publish yesterday</span></span>
<span id="cb22-1032"><a href="#cb22-1032" aria-hidden="true" tabindex="-1"></a><span class="in">yesterday_tz &lt;- "Etc/GMT+12"</span></span>
<span id="cb22-1033"><a href="#cb22-1033" aria-hidden="true" tabindex="-1"></a><span class="in">yesterday &lt;- lubridate::today(tzone = yesterday_tz) - lubridate::days(1)</span></span>
<span id="cb22-1034"><a href="#cb22-1034" aria-hidden="true" tabindex="-1"></a><span class="in">dates_all &lt;- (prism_beg:(yesterday)) |&gt; as.Date()</span></span>
<span id="cb22-1035"><a href="#cb22-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1036"><a href="#cb22-1036" aria-hidden="true" tabindex="-1"></a><span class="in">rx_tif &lt;- "prism_daily_([0-9]{2})-([0-9]{2}).tif"</span></span>
<span id="cb22-1037"><a href="#cb22-1037" aria-hidden="true" tabindex="-1"></a><span class="in">rx_lyr &lt;- "PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb22-1038"><a href="#cb22-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1039"><a href="#cb22-1039" aria-hidden="true" tabindex="-1"></a><span class="in">d_done &lt;- tibble::tibble(</span></span>
<span id="cb22-1040"><a href="#cb22-1040" aria-hidden="true" tabindex="-1"></a><span class="in">  tif_path = list.files(dir_daily, ".*\\.tif$", full.names = T),</span></span>
<span id="cb22-1041"><a href="#cb22-1041" aria-hidden="true" tabindex="-1"></a><span class="in">  tif  = basename(tif_path),</span></span>
<span id="cb22-1042"><a href="#cb22-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  tif_md   = stringr::str_replace(tif, rx_tif, "\\1-\\2"),</span></span>
<span id="cb22-1043"><a href="#cb22-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  tif_mo   = stringr::str_replace(tif, rx_tif, "\\1"),</span></span>
<span id="cb22-1044"><a href="#cb22-1044" aria-hidden="true" tabindex="-1"></a><span class="in">  tif_day  = stringr::str_replace(tif, rx_tif, "\\2") ) |&gt; </span></span>
<span id="cb22-1045"><a href="#cb22-1045" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(</span></span>
<span id="cb22-1046"><a href="#cb22-1046" aria-hidden="true" tabindex="-1"></a><span class="in">    lyr = purrr::map(tif_path, \(tif_path) terra::rast(tif_path) |&gt; names() ) ) |&gt; </span></span>
<span id="cb22-1047"><a href="#cb22-1047" aria-hidden="true" tabindex="-1"></a><span class="in">  tidyr::unnest(lyr) |&gt; </span></span>
<span id="cb22-1048"><a href="#cb22-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::mutate(</span></span>
<span id="cb22-1049"><a href="#cb22-1049" aria-hidden="true" tabindex="-1"></a><span class="in">    lyr_var       = stringr::str_replace(lyr, rx_lyr, "\\1"),</span></span>
<span id="cb22-1050"><a href="#cb22-1050" aria-hidden="true" tabindex="-1"></a><span class="in">    lyr_stability = stringr::str_replace(lyr, rx_lyr, "\\2"),</span></span>
<span id="cb22-1051"><a href="#cb22-1051" aria-hidden="true" tabindex="-1"></a><span class="in">    lyr_date      = stringr::str_replace(lyr, rx_lyr, "\\4") |&gt; </span></span>
<span id="cb22-1052"><a href="#cb22-1052" aria-hidden="true" tabindex="-1"></a><span class="in">        as.Date(format = "%Y%m%d")) |&gt; </span></span>
<span id="cb22-1053"><a href="#cb22-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::arrange(tif_md, lyr_date, lyr_var) # order by: month-day, date, variable</span></span>
<span id="cb22-1054"><a href="#cb22-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1055"><a href="#cb22-1055" aria-hidden="true" tabindex="-1"></a><span class="in"># define expected stability by date</span></span>
<span id="cb22-1056"><a href="#cb22-1056" aria-hidden="true" tabindex="-1"></a><span class="in">early_end  &lt;- lubridate::today(tzone = "UTC") - lubridate::days(1)</span></span>
<span id="cb22-1057"><a href="#cb22-1057" aria-hidden="true" tabindex="-1"></a><span class="in">early_beg  &lt;- lubridate::ym(glue::glue("{lubridate::year(early_end)}-{lubridate::month(early_end)}"))</span></span>
<span id="cb22-1058"><a href="#cb22-1058" aria-hidden="true" tabindex="-1"></a><span class="in">prov_end   &lt;- early_beg - days(1)</span></span>
<span id="cb22-1059"><a href="#cb22-1059" aria-hidden="true" tabindex="-1"></a><span class="in">prov_beg   &lt;- early_beg - months(6)</span></span>
<span id="cb22-1060"><a href="#cb22-1060" aria-hidden="true" tabindex="-1"></a><span class="in">stable_end &lt;- prov_beg - days(1)</span></span>
<span id="cb22-1061"><a href="#cb22-1061" aria-hidden="true" tabindex="-1"></a><span class="in">stable_beg &lt;- prism_beg</span></span>
<span id="cb22-1062"><a href="#cb22-1062" aria-hidden="true" tabindex="-1"></a><span class="in"># early:       2024-05-01 to 2024-05-06 (this month)</span></span>
<span id="cb22-1063"><a href="#cb22-1063" aria-hidden="true" tabindex="-1"></a><span class="in"># provisional: 2023-11-01   to 2024-04-30 (previous 6 months)</span></span>
<span id="cb22-1064"><a href="#cb22-1064" aria-hidden="true" tabindex="-1"></a><span class="in"># stable:      1981-01-01 to 2023-10-31 (before 6 months)</span></span>
<span id="cb22-1065"><a href="#cb22-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1066"><a href="#cb22-1066" aria-hidden="true" tabindex="-1"></a><span class="in">d_todo &lt;- tibble::tibble(</span></span>
<span id="cb22-1067"><a href="#cb22-1067" aria-hidden="true" tabindex="-1"></a><span class="in">  lyr_var = vars |&gt; sort()) |&gt; </span></span>
<span id="cb22-1068"><a href="#cb22-1068" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::cross_join(</span></span>
<span id="cb22-1069"><a href="#cb22-1069" aria-hidden="true" tabindex="-1"></a><span class="in">    tibble::tibble(</span></span>
<span id="cb22-1070"><a href="#cb22-1070" aria-hidden="true" tabindex="-1"></a><span class="in">      lyr_date = dates_all) |&gt; </span></span>
<span id="cb22-1071"><a href="#cb22-1071" aria-hidden="true" tabindex="-1"></a><span class="in">      dplyr::mutate(</span></span>
<span id="cb22-1072"><a href="#cb22-1072" aria-hidden="true" tabindex="-1"></a><span class="in">        lyr_stability = cut(</span></span>
<span id="cb22-1073"><a href="#cb22-1073" aria-hidden="true" tabindex="-1"></a><span class="in">          lyr_date,</span></span>
<span id="cb22-1074"><a href="#cb22-1074" aria-hidden="true" tabindex="-1"></a><span class="in">          breaks = c(stable_beg, stable_end, prov_beg, prov_end, early_beg, early_end),</span></span>
<span id="cb22-1075"><a href="#cb22-1075" aria-hidden="true" tabindex="-1"></a><span class="in">          labels = c("stable", "stable", "provisional", "provisional", "early"),</span></span>
<span id="cb22-1076"><a href="#cb22-1076" aria-hidden="true" tabindex="-1"></a><span class="in">          include.lowest = T) ) ) |&gt; </span></span>
<span id="cb22-1077"><a href="#cb22-1077" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::anti_join(</span></span>
<span id="cb22-1078"><a href="#cb22-1078" aria-hidden="true" tabindex="-1"></a><span class="in">    d_done |&gt; </span></span>
<span id="cb22-1079"><a href="#cb22-1079" aria-hidden="true" tabindex="-1"></a><span class="in">      dplyr::select(lyr_date, lyr_var, lyr_stability) |&gt; </span></span>
<span id="cb22-1080"><a href="#cb22-1080" aria-hidden="true" tabindex="-1"></a><span class="in">      dplyr::arrange(lyr_date, lyr_var, lyr_stability),</span></span>
<span id="cb22-1081"><a href="#cb22-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    by = c("lyr_date", "lyr_var", "lyr_stability")) |&gt; </span></span>
<span id="cb22-1082"><a href="#cb22-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::arrange(lyr_date, lyr_var, lyr_stability)</span></span>
<span id="cb22-1083"><a href="#cb22-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1084"><a href="#cb22-1084" aria-hidden="true" tabindex="-1"></a><span class="in"># 1 ppt     2024-05-07 early</span></span>
<span id="cb22-1085"><a href="#cb22-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1086"><a href="#cb22-1086" aria-hidden="true" tabindex="-1"></a><span class="in">prism_rast_parameters &lt;- function(r){</span></span>
<span id="cb22-1087"><a href="#cb22-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  # convert raster names to data frame with components</span></span>
<span id="cb22-1088"><a href="#cb22-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1089"><a href="#cb22-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  rx &lt;- "PRISM_(.*)_(.*)_(.*)_(.*)_bil"</span></span>
<span id="cb22-1090"><a href="#cb22-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1091"><a href="#cb22-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  tibble::tibble(</span></span>
<span id="cb22-1092"><a href="#cb22-1092" aria-hidden="true" tabindex="-1"></a><span class="in">    idx = 1:terra::nlyr(r),</span></span>
<span id="cb22-1093"><a href="#cb22-1093" aria-hidden="true" tabindex="-1"></a><span class="in">    lyr = names(r)) |&gt; </span></span>
<span id="cb22-1094"><a href="#cb22-1094" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(</span></span>
<span id="cb22-1095"><a href="#cb22-1095" aria-hidden="true" tabindex="-1"></a><span class="in">      var       = stringr::str_replace(lyr, rx, "\\1"),</span></span>
<span id="cb22-1096"><a href="#cb22-1096" aria-hidden="true" tabindex="-1"></a><span class="in">      stability = stringr::str_replace(lyr, rx, "\\2"),</span></span>
<span id="cb22-1097"><a href="#cb22-1097" aria-hidden="true" tabindex="-1"></a><span class="in">      date      = stringr::str_replace(lyr, rx, "\\4") |&gt; </span></span>
<span id="cb22-1098"><a href="#cb22-1098" aria-hidden="true" tabindex="-1"></a><span class="in">        as.Date(format = "%Y%m%d"))</span></span>
<span id="cb22-1099"><a href="#cb22-1099" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb22-1100"><a href="#cb22-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1101"><a href="#cb22-1101" aria-hidden="true" tabindex="-1"></a><span class="in">prism_get_daily &lt;- function(</span></span>
<span id="cb22-1102"><a href="#cb22-1102" aria-hidden="true" tabindex="-1"></a><span class="in">    var, date, </span></span>
<span id="cb22-1103"><a href="#cb22-1103" aria-hidden="true" tabindex="-1"></a><span class="in">    dir_daily = here::here("data/prism"),</span></span>
<span id="cb22-1104"><a href="#cb22-1104" aria-hidden="true" tabindex="-1"></a><span class="in">    crs_proj  = "+proj=longlat +datum=NAD83 +no_defs",</span></span>
<span id="cb22-1105"><a href="#cb22-1105" aria-hidden="true" tabindex="-1"></a><span class="in">    bb        = c(xmin = -82.9, ymin = 27.2, xmax = -81.7, ymax = 28.6)){</span></span>
<span id="cb22-1106"><a href="#cb22-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1107"><a href="#cb22-1107" aria-hidden="true" tabindex="-1"></a><span class="in">  u &lt;- glue::glue("https://services.nacse.org/prism/data/public/4km/{var}/{format(date, '%Y%m%d')}")</span></span>
<span id="cb22-1108"><a href="#cb22-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1109"><a href="#cb22-1109" aria-hidden="true" tabindex="-1"></a><span class="in">  ply_bb &lt;- sf::st_bbox(bb, crs = crs_proj) |&gt; </span></span>
<span id="cb22-1110"><a href="#cb22-1110" aria-hidden="true" tabindex="-1"></a><span class="in">    sf::st_as_sfc() |&gt; </span></span>
<span id="cb22-1111"><a href="#cb22-1111" aria-hidden="true" tabindex="-1"></a><span class="in">    sf::st_as_sf()</span></span>
<span id="cb22-1112"><a href="#cb22-1112" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1113"><a href="#cb22-1113" aria-hidden="true" tabindex="-1"></a><span class="in">  # date = as.Date("1981-01-01"); var = "tdmean"</span></span>
<span id="cb22-1114"><a href="#cb22-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  z &lt;- glue::glue("{dir_daily}/temp_{date}_{var}.zip")</span></span>
<span id="cb22-1115"><a href="#cb22-1115" aria-hidden="true" tabindex="-1"></a><span class="in">  message(glue::glue("Downloading PRISM daily {date} {var}"))</span></span>
<span id="cb22-1116"><a href="#cb22-1116" aria-hidden="true" tabindex="-1"></a><span class="in">  download.file(u, z, quiet = T)</span></span>
<span id="cb22-1117"><a href="#cb22-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1118"><a href="#cb22-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  # If downloaded zip &lt; 1 KB, assume one of these errors:</span></span>
<span id="cb22-1119"><a href="#cb22-1119" aria-hidden="true" tabindex="-1"></a><span class="in">  # - You have tried to download the file PRISM_tdmean_stable_4kmD2_19810101_bil.zip more than twice in one day (Pacific local time).  Note that repeated offenses may result in your IP address being blocked.</span></span>
<span id="cb22-1120"><a href="#cb22-1120" aria-hidden="true" tabindex="-1"></a><span class="in">  # - Invalid date: 20240513&lt;/br&gt;Valid day ranges for the given month are 1 to 12 [real reason: requesting beyond available date, ie not yet published]</span></span>
<span id="cb22-1121"><a href="#cb22-1121" aria-hidden="true" tabindex="-1"></a><span class="in">  if (file.size(z) &lt; 1000)</span></span>
<span id="cb22-1122"><a href="#cb22-1122" aria-hidden="true" tabindex="-1"></a><span class="in">    stop(readLines(z, warn=F))</span></span>
<span id="cb22-1123"><a href="#cb22-1123" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1124"><a href="#cb22-1124" aria-hidden="true" tabindex="-1"></a><span class="in">  dir_z &lt;- fs::path_ext_remove(z)</span></span>
<span id="cb22-1125"><a href="#cb22-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  dir.create(dir_z, showWarnings = F)</span></span>
<span id="cb22-1126"><a href="#cb22-1126" aria-hidden="true" tabindex="-1"></a><span class="in">  unzip(z, exdir = dir_z)</span></span>
<span id="cb22-1127"><a href="#cb22-1127" aria-hidden="true" tabindex="-1"></a><span class="in">  unlink(z)</span></span>
<span id="cb22-1128"><a href="#cb22-1128" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1129"><a href="#cb22-1129" aria-hidden="true" tabindex="-1"></a><span class="in">  r_new &lt;- list.files(dir_z, "PRISM_.*_bil\\.bil$", full.names = T) |&gt; </span></span>
<span id="cb22-1130"><a href="#cb22-1130" aria-hidden="true" tabindex="-1"></a><span class="in">    # file.exists()</span></span>
<span id="cb22-1131"><a href="#cb22-1131" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::rast() |&gt; </span></span>
<span id="cb22-1132"><a href="#cb22-1132" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::crop(ply_bb, mask = T, touches = T) |&gt;</span></span>
<span id="cb22-1133"><a href="#cb22-1133" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::trim()</span></span>
<span id="cb22-1134"><a href="#cb22-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::crs(r_new) &lt;- crs_proj</span></span>
<span id="cb22-1135"><a href="#cb22-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1136"><a href="#cb22-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  md_tif &lt;- sprintf("%s/prism_daily_%02d-%02d.tif", dir_daily, month(date), day(date))</span></span>
<span id="cb22-1137"><a href="#cb22-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1138"><a href="#cb22-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!file.exists(md_tif)){</span></span>
<span id="cb22-1139"><a href="#cb22-1139" aria-hidden="true" tabindex="-1"></a><span class="in">    terra::writeRaster(</span></span>
<span id="cb22-1140"><a href="#cb22-1140" aria-hidden="true" tabindex="-1"></a><span class="in">        r_new, md_tif, </span></span>
<span id="cb22-1141"><a href="#cb22-1141" aria-hidden="true" tabindex="-1"></a><span class="in">        datatype = "FLT4S",</span></span>
<span id="cb22-1142"><a href="#cb22-1142" aria-hidden="true" tabindex="-1"></a><span class="in">        filetype = "GTiff", gdal = c("COMPRESS=DEFLATE"),</span></span>
<span id="cb22-1143"><a href="#cb22-1143" aria-hidden="true" tabindex="-1"></a><span class="in">        overwrite = T)</span></span>
<span id="cb22-1144"><a href="#cb22-1144" aria-hidden="true" tabindex="-1"></a><span class="in">    dir_delete(dir_z)</span></span>
<span id="cb22-1145"><a href="#cb22-1145" aria-hidden="true" tabindex="-1"></a><span class="in">    return(T)</span></span>
<span id="cb22-1146"><a href="#cb22-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb22-1147"><a href="#cb22-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1148"><a href="#cb22-1148" aria-hidden="true" tabindex="-1"></a><span class="in">  r_md  &lt;- rast(md_tif)</span></span>
<span id="cb22-1149"><a href="#cb22-1149" aria-hidden="true" tabindex="-1"></a><span class="in">  df_md &lt;- prism_rast_parameters(r_md)</span></span>
<span id="cb22-1150"><a href="#cb22-1150" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1151"><a href="#cb22-1151" aria-hidden="true" tabindex="-1"></a><span class="in">  # remove old date-var, eg for stability improved</span></span>
<span id="cb22-1152"><a href="#cb22-1152" aria-hidden="true" tabindex="-1"></a><span class="in">  i_lyr_rm &lt;- df_md |&gt; </span></span>
<span id="cb22-1153"><a href="#cb22-1153" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(</span></span>
<span id="cb22-1154"><a href="#cb22-1154" aria-hidden="true" tabindex="-1"></a><span class="in">      date == !!date,</span></span>
<span id="cb22-1155"><a href="#cb22-1155" aria-hidden="true" tabindex="-1"></a><span class="in">      var  == !!var) |&gt; </span></span>
<span id="cb22-1156"><a href="#cb22-1156" aria-hidden="true" tabindex="-1"></a><span class="in">    pull(idx)</span></span>
<span id="cb22-1157"><a href="#cb22-1157" aria-hidden="true" tabindex="-1"></a><span class="in">  if (length(i_lyr_rm) &gt; 0)</span></span>
<span id="cb22-1158"><a href="#cb22-1158" aria-hidden="true" tabindex="-1"></a><span class="in">    r_md &lt;- terra::subset(r_md, i_lyr_rm, negate = T)</span></span>
<span id="cb22-1159"><a href="#cb22-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1160"><a href="#cb22-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  # combine old and new</span></span>
<span id="cb22-1161"><a href="#cb22-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  r_md &lt;- c(r_md, r_new)</span></span>
<span id="cb22-1162"><a href="#cb22-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb22-1163"><a href="#cb22-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  # write out</span></span>
<span id="cb22-1164"><a href="#cb22-1164" aria-hidden="true" tabindex="-1"></a><span class="in">  tmp &lt;- tempfile(fileext = ".tif")</span></span>
<span id="cb22-1165"><a href="#cb22-1165" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::writeRaster(</span></span>
<span id="cb22-1166"><a href="#cb22-1166" aria-hidden="true" tabindex="-1"></a><span class="in">    r_md, tmp,</span></span>
<span id="cb22-1167"><a href="#cb22-1167" aria-hidden="true" tabindex="-1"></a><span class="in">    datatype = "FLT4S",</span></span>
<span id="cb22-1168"><a href="#cb22-1168" aria-hidden="true" tabindex="-1"></a><span class="in">    filetype = "GTiff", gdal = c("COMPRESS=DEFLATE"),</span></span>
<span id="cb22-1169"><a href="#cb22-1169" aria-hidden="true" tabindex="-1"></a><span class="in">    overwrite = T)</span></span>
<span id="cb22-1170"><a href="#cb22-1170" aria-hidden="true" tabindex="-1"></a><span class="in">  terra::writeRaster(</span></span>
<span id="cb22-1171"><a href="#cb22-1171" aria-hidden="true" tabindex="-1"></a><span class="in">    rast(tmp), md_tif, </span></span>
<span id="cb22-1172"><a href="#cb22-1172" aria-hidden="true" tabindex="-1"></a><span class="in">    datatype = "FLT4S",</span></span>
<span id="cb22-1173"><a href="#cb22-1173" aria-hidden="true" tabindex="-1"></a><span class="in">    filetype = "GTiff", gdal = c("COMPRESS=DEFLATE"),</span></span>
<span id="cb22-1174"><a href="#cb22-1174" aria-hidden="true" tabindex="-1"></a><span class="in">    overwrite = T)</span></span>
<span id="cb22-1175"><a href="#cb22-1175" aria-hidden="true" tabindex="-1"></a><span class="in">  fs::dir_delete(dir_z)</span></span>
<span id="cb22-1176"><a href="#cb22-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  unlink(tmp)</span></span>
<span id="cb22-1177"><a href="#cb22-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  return(T)</span></span>
<span id="cb22-1178"><a href="#cb22-1178" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb22-1179"><a href="#cb22-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1180"><a href="#cb22-1180" aria-hidden="true" tabindex="-1"></a><span class="in">msg &lt;- ifelse(</span></span>
<span id="cb22-1181"><a href="#cb22-1181" aria-hidden="true" tabindex="-1"></a><span class="in">  nrow(d_todo) &gt; 0,</span></span>
<span id="cb22-1182"><a href="#cb22-1182" aria-hidden="true" tabindex="-1"></a><span class="in">  glue::glue("Summary: {nrow(d_todo)} variable-dates {paste(range(d_todo$lyr_date), collapse=' to ')} to download and crop "),</span></span>
<span id="cb22-1183"><a href="#cb22-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  glue::glue("Summary: up to date as of yesterday ({yesterday_tz}): {yesterday}"))</span></span>
<span id="cb22-1184"><a href="#cb22-1184" aria-hidden="true" tabindex="-1"></a><span class="in">message(msg)</span></span>
<span id="cb22-1185"><a href="#cb22-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1186"><a href="#cb22-1186" aria-hidden="true" tabindex="-1"></a><span class="in">d_todo |&gt; </span></span>
<span id="cb22-1187"><a href="#cb22-1187" aria-hidden="true" tabindex="-1"></a><span class="in">  select(var = lyr_var, date = lyr_date) |&gt; </span></span>
<span id="cb22-1188"><a href="#cb22-1188" aria-hidden="true" tabindex="-1"></a><span class="in">  pwalk(prism_get_daily)</span></span>
<span id="cb22-1189"><a href="#cb22-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1190"><a href="#cb22-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1191"><a href="#cb22-1191" aria-hidden="true" tabindex="-1"></a><span class="in">```         </span></span>
<span id="cb22-1192"><a href="#cb22-1192" aria-hidden="true" tabindex="-1"></a><span class="in"># early:       2024-05-01 to 2024-05-06</span></span>
<span id="cb22-1193"><a href="#cb22-1193" aria-hidden="true" tabindex="-1"></a><span class="in"># provisional: 2023-11-01   to 2024-04-30</span></span>
<span id="cb22-1194"><a href="#cb22-1194" aria-hidden="true" tabindex="-1"></a><span class="in"># stable:      1981-01-01 to 2023-10-31</span></span>
<span id="cb22-1195"><a href="#cb22-1195" aria-hidden="true" tabindex="-1"></a><span class="in"># https://prism.nacse.org/documents/PRISM_downloads_web_service.pdf</span></span>
<span id="cb22-1196"><a href="#cb22-1196" aria-hidden="true" tabindex="-1"></a><span class="in"># PRISM_&lt;var&gt;_&lt;stability&gt;_&lt;scale&amp;version&gt;_&lt;time period&gt;[_all|_annual]_bil.zip</span></span>
<span id="cb22-1197"><a href="#cb22-1197" aria-hidden="true" tabindex="-1"></a><span class="in"># https://services.nacse.org/prism/data/public/4km/&lt;element&gt;/&lt;date&gt;&lt;?format=[nc|asc|grib2]&gt;</span></span>
<span id="cb22-1198"><a href="#cb22-1198" aria-hidden="true" tabindex="-1"></a><span class="in"># https://services.nacse.org/prism/data/public/4km/tmin/20090405</span></span>
<span id="cb22-1199"><a href="#cb22-1199" aria-hidden="true" tabindex="-1"></a><span class="in"># https://prism.oregonstate.edu/documents/PRISM_update_schedule.pdf</span></span>
<span id="cb22-1200"><a href="#cb22-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1201"><a href="#cb22-1201" aria-hidden="true" tabindex="-1"></a><span class="in"># dates &lt;- gen_dates(minDate = minDate, maxDate = maxDate, dates = dates)</span></span>
<span id="cb22-1202"><a href="#cb22-1202" aria-hidden="true" tabindex="-1"></a><span class="in">dates &lt;- date("2024-05-12")</span></span>
<span id="cb22-1203"><a href="#cb22-1203" aria-hidden="true" tabindex="-1"></a><span class="in"># prism:::prism_vars() |&gt; sort()</span></span>
<span id="cb22-1204"><a href="#cb22-1204" aria-hidden="true" tabindex="-1"></a><span class="in">service &lt;- "http://services.nacse.org/prism/data/public/4km"</span></span>
<span id="cb22-1205"><a href="#cb22-1205" aria-hidden="true" tabindex="-1"></a><span class="in">type = "ppt"</span></span>
<span id="cb22-1206"><a href="#cb22-1206" aria-hidden="true" tabindex="-1"></a><span class="in">uri_dates &lt;- gsub(pattern = "-",replacement = "",dates)</span></span>
<span id="cb22-1207"><a href="#cb22-1207" aria-hidden="true" tabindex="-1"></a><span class="in"># uris &lt;- prism:::gen_prism_url(uri_dates, type, service)</span></span>
<span id="cb22-1208"><a href="#cb22-1208" aria-hidden="true" tabindex="-1"></a><span class="in">uris &lt;- paste(service, type, dates, sep = "/")</span></span>
<span id="cb22-1209"><a href="#cb22-1209" aria-hidden="true" tabindex="-1"></a><span class="in"># "http://services.nacse.org/prism/data/public/4km/ppt/2024-05-12"</span></span>
<span id="cb22-1210"><a href="#cb22-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1211"><a href="#cb22-1211" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- httr::HEAD(uris[1])</span></span>
<span id="cb22-1212"><a href="#cb22-1212" aria-hidden="true" tabindex="-1"></a><span class="in">fn &lt;- x$headers$`content-disposition`</span></span>
<span id="cb22-1213"><a href="#cb22-1213" aria-hidden="true" tabindex="-1"></a><span class="in">fn &lt;- regmatches(fn,regexpr('\\"[a-zA-Z0-9_\\.]+',fn))</span></span>
<span id="cb22-1214"><a href="#cb22-1214" aria-hidden="true" tabindex="-1"></a><span class="in">fn &lt;- substr(fn,2,nchar((fn)))</span></span>
<span id="cb22-1215"><a href="#cb22-1215" aria-hidden="true" tabindex="-1"></a><span class="in">fn &lt;- gsub("provisional|early", "stable", fn)</span></span>
<span id="cb22-1216"><a href="#cb22-1216" aria-hidden="true" tabindex="-1"></a><span class="in">file_names &lt;- stringr::str_replace(</span></span>
<span id="cb22-1217"><a href="#cb22-1217" aria-hidden="true" tabindex="-1"></a><span class="in">  fn, </span></span>
<span id="cb22-1218"><a href="#cb22-1218" aria-hidden="true" tabindex="-1"></a><span class="in">  "[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]", </span></span>
<span id="cb22-1219"><a href="#cb22-1219" aria-hidden="true" tabindex="-1"></a><span class="in">  uri_dates</span></span>
<span id="cb22-1220"><a href="#cb22-1220" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb22-1221"><a href="#cb22-1221" aria-hidden="true" tabindex="-1"></a><span class="in">to_download_lgl &lt;- prism_check(file_names, lgl = TRUE)</span></span>
<span id="cb22-1222"><a href="#cb22-1222" aria-hidden="true" tabindex="-1"></a><span class="in">uris &lt;- uris[to_download_lgl]</span></span>
<span id="cb22-1223"><a href="#cb22-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1224"><a href="#cb22-1224" aria-hidden="true" tabindex="-1"></a><span class="in">get_prism_dailys &lt;- function(type, minDate = NULL, maxDate =  NULL, </span></span>
<span id="cb22-1225"><a href="#cb22-1225" aria-hidden="true" tabindex="-1"></a><span class="in">                             dates = NULL, keepZip = TRUE, check = "httr",</span></span>
<span id="cb22-1226"><a href="#cb22-1226" aria-hidden="true" tabindex="-1"></a><span class="in">                             service = NULL)</span></span>
<span id="cb22-1227"><a href="#cb22-1227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1228"><a href="#cb22-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1229"><a href="#cb22-1229" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">PRISM datasets</span><span class="co">](https://prism.oregonstate.edu/documents/PRISM_datasets.pdf)</span>:</span>
<span id="cb22-1230"><a href="#cb22-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1231"><a href="#cb22-1231" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; AN - Daily Time Series (AN81d/AN91d) Climate elements: tmin, tmax, tmean (derived), tdmean, ppt, vpdmin, vpdmax Units and scaling: tmin, tmax, tmean, tdmean (deg C); ppt (mm); vpdmin, vpdmax (hPa); all values are floating point Description: Daily dataset covering the conterminous US, starting on 1 January 1981 and ending yesterday.</span></span>
<span id="cb22-1232"><a href="#cb22-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1233"><a href="#cb22-1233" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">PRISM_update_schedule</span><span class="co">](https://prism.oregonstate.edu/documents/PRISM_update_schedule.pdf)</span>:</span>
<span id="cb22-1234"><a href="#cb22-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1235"><a href="#cb22-1235" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>asdf <span class="sc">\&gt;</span> The PRISM map sequence is first updated to include a particular day about 24 hours after it has ended (Grid Count = 1). <span class="sc">\&gt;</span> Note that a “PRISM Day” is defined as the 24-hour period ending at 1200 UTC on that day, e.g., a grid for July 2 covers the period 1200 UTC July 1 – 1200 UTC July 2</span>
<span id="cb22-1236"><a href="#cb22-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1237"><a href="#cb22-1237" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>asdf <span class="sc">\&gt;</span> A second update (Grid Count = 2) is made after five days have elapsed; the five-day milestone was chosen because a large amount of new station data is typically received at this point.</span>
<span id="cb22-1238"><a href="#cb22-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1239"><a href="#cb22-1239" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span></span>
<span id="cb22-1240"><a href="#cb22-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1241"><a href="#cb22-1241" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The third update (Grid Count = 3) is produced during what is termed the “monthly update,” which is typically completed on about the 15th of the following month.</span></span>
<span id="cb22-1242"><a href="#cb22-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1243"><a href="#cb22-1243" aria-hidden="true" tabindex="-1"></a><span class="fu">## Map Swipe Yesterday vs Climatology</span></span>
<span id="cb22-1244"><a href="#cb22-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1247"><a href="#cb22-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1248"><a href="#cb22-1248" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calc_climatologies</span></span>
<span id="cb22-1249"><a href="#cb22-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1250"><a href="#cb22-1250" aria-hidden="true" tabindex="-1"></a><span class="fu">prism_set_dl_dir</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"tmp/prism"</span>))</span>
<span id="cb22-1251"><a href="#cb22-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1252"><a href="#cb22-1252" aria-hidden="true" tabindex="-1"></a>var <span class="ot">=</span> <span class="st">"tmax"</span></span>
<span id="cb22-1253"><a href="#cb22-1253" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">today</span>() <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">1</span>)  <span class="co"># yesterday</span></span>
<span id="cb22-1254"><a href="#cb22-1254" aria-hidden="true" tabindex="-1"></a>yrs <span class="ot">&lt;-</span> <span class="dv">1981</span><span class="sc">:</span>(<span class="dv">1981</span><span class="sc">+</span><span class="dv">20</span>) <span class="co"># 20 yr climatology</span></span>
<span id="cb22-1255"><a href="#cb22-1255" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%d-%02d-%02d"</span>, yrs, <span class="fu">month</span>(date), <span class="fu">day</span>(date))</span>
<span id="cb22-1256"><a href="#cb22-1256" aria-hidden="true" tabindex="-1"></a>pds <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(var, <span class="st">"daily"</span>, <span class="at">dates =</span> dates)</span>
<span id="cb22-1257"><a href="#cb22-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1258"><a href="#cb22-1258" aria-hidden="true" tabindex="-1"></a><span class="co"># web mercator for use with slippy maps</span></span>
<span id="cb22-1259"><a href="#cb22-1259" aria-hidden="true" tabindex="-1"></a>proj4_3857 <span class="ot">&lt;-</span> <span class="st">"+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs +type=crs"</span></span>
<span id="cb22-1260"><a href="#cb22-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1261"><a href="#cb22-1261" aria-hidden="true" tabindex="-1"></a>r_c <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pds) <span class="sc">|&gt;</span> </span>
<span id="cb22-1262"><a href="#cb22-1262" aria-hidden="true" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">projectRaster</span>(<span class="at">crs =</span> proj4_3857) <span class="sc">|&gt;</span> </span>
<span id="cb22-1263"><a href="#cb22-1263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1264"><a href="#cb22-1264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="at">na.rm=</span>T)</span>
<span id="cb22-1265"><a href="#cb22-1265" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_c) <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{var}_historical"</span>)</span>
<span id="cb22-1266"><a href="#cb22-1266" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(r_c)</span></span>
<span id="cb22-1267"><a href="#cb22-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1268"><a href="#cb22-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># get_prism_dailys(type = var, dates = date, keepZip = F)</span></span>
<span id="cb22-1269"><a href="#cb22-1269" aria-hidden="true" tabindex="-1"></a><span class="co"># prism_archive_clean(var, "daily", dates = date)</span></span>
<span id="cb22-1270"><a href="#cb22-1270" aria-hidden="true" tabindex="-1"></a><span class="co"># prism_archive_crop(var, "daily", dates = date)</span></span>
<span id="cb22-1271"><a href="#cb22-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1272"><a href="#cb22-1272" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> prism<span class="sc">::</span><span class="fu">prism_archive_subset</span>(var, <span class="st">"daily"</span>, <span class="at">dates =</span> date)</span>
<span id="cb22-1273"><a href="#cb22-1273" aria-hidden="true" tabindex="-1"></a>r_d <span class="ot">&lt;-</span> <span class="fu">pd_stack</span>(pd) <span class="sc">|&gt;</span> </span>
<span id="cb22-1274"><a href="#cb22-1274" aria-hidden="true" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">projectRaster</span>(<span class="at">crs =</span> proj4_3857) <span class="sc">|&gt;</span> </span>
<span id="cb22-1275"><a href="#cb22-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rast</span>()</span>
<span id="cb22-1276"><a href="#cb22-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(r_d) <span class="ot">&lt;-</span> var</span>
<span id="cb22-1277"><a href="#cb22-1277" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(r_d)</span></span>
<span id="cb22-1278"><a href="#cb22-1278" aria-hidden="true" tabindex="-1"></a><span class="co"># plet(r_d, tiles=providers$Esri.OceanBasemap)</span></span>
<span id="cb22-1279"><a href="#cb22-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1280"><a href="#cb22-1280" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">values</span>(r_c, <span class="at">na.rm=</span>T), <span class="fu">values</span>(r_d, <span class="at">na.rm=</span>T))</span>
<span id="cb22-1281"><a href="#cb22-1281" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorNumeric</span>(</span>
<span id="cb22-1282"><a href="#cb22-1282" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spectral"</span>, vals, <span class="at">reverse =</span> T, <span class="at">na.color =</span> <span class="st">"transparent"</span>)</span>
<span id="cb22-1283"><a href="#cb22-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1284"><a href="#cb22-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># leaflet() |&gt; </span></span>
<span id="cb22-1285"><a href="#cb22-1285" aria-hidden="true" tabindex="-1"></a><span class="co">#   addProviderTiles(</span></span>
<span id="cb22-1286"><a href="#cb22-1286" aria-hidden="true" tabindex="-1"></a><span class="co">#     providers$Stadia.StamenTonerLite) |&gt; </span></span>
<span id="cb22-1287"><a href="#cb22-1287" aria-hidden="true" tabindex="-1"></a><span class="co">#   addRasterImage(</span></span>
<span id="cb22-1288"><a href="#cb22-1288" aria-hidden="true" tabindex="-1"></a><span class="co">#     # r_c, colors = pal, opacity = 0.8, project = F) |&gt; </span></span>
<span id="cb22-1289"><a href="#cb22-1289" aria-hidden="true" tabindex="-1"></a><span class="co">#     r_d, colors = pal, opacity = 0.8, project = F) |&gt; </span></span>
<span id="cb22-1290"><a href="#cb22-1290" aria-hidden="true" tabindex="-1"></a><span class="co">#   addLegend(</span></span>
<span id="cb22-1291"><a href="#cb22-1291" aria-hidden="true" tabindex="-1"></a><span class="co">#     pal = pal, values = vals, title = var)</span></span>
<span id="cb22-1292"><a href="#cb22-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1293"><a href="#cb22-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1294"><a href="#cb22-1294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMapPane</span>(<span class="st">"left"</span>,  <span class="at">zIndex =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-1295"><a href="#cb22-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMapPane</span>(<span class="st">"right"</span>, <span class="at">zIndex =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-1296"><a href="#cb22-1296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb22-1297"><a href="#cb22-1297" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.DarkMatter,</span>
<span id="cb22-1298"><a href="#cb22-1298" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">"left"</span>),</span>
<span id="cb22-1299"><a href="#cb22-1299" aria-hidden="true" tabindex="-1"></a>    <span class="at">group   =</span> <span class="st">"base"</span>, </span>
<span id="cb22-1300"><a href="#cb22-1300" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"base_l"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1301"><a href="#cb22-1301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(</span>
<span id="cb22-1302"><a href="#cb22-1302" aria-hidden="true" tabindex="-1"></a>    providers<span class="sc">$</span>CartoDB.DarkMatter,</span>
<span id="cb22-1303"><a href="#cb22-1303" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">"right"</span>),</span>
<span id="cb22-1304"><a href="#cb22-1304" aria-hidden="true" tabindex="-1"></a>    <span class="at">group   =</span> <span class="st">"base"</span>, </span>
<span id="cb22-1305"><a href="#cb22-1305" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"base_r"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1306"><a href="#cb22-1306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb22-1307"><a href="#cb22-1307" aria-hidden="true" tabindex="-1"></a>    r_c, <span class="at">colors =</span> pal, <span class="at">opacity =</span> <span class="fl">0.8</span>, <span class="at">project =</span> F,</span>
<span id="cb22-1308"><a href="#cb22-1308" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">pane =</span> <span class="st">"left"</span>),</span>
<span id="cb22-1309"><a href="#cb22-1309" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"r_c"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1310"><a href="#cb22-1310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addRasterImage</span>(</span>
<span id="cb22-1311"><a href="#cb22-1311" aria-hidden="true" tabindex="-1"></a>    r_d, <span class="at">colors =</span> pal, <span class="at">opacity =</span> <span class="fl">0.8</span>, <span class="at">project =</span> F,</span>
<span id="cb22-1312"><a href="#cb22-1312" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">pane =</span> <span class="st">"right"</span>),</span>
<span id="cb22-1313"><a href="#cb22-1313" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"r_d"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1314"><a href="#cb22-1314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLayersControl</span>(<span class="at">overlayGroups =</span> <span class="fu">c</span>(<span class="st">"r_c"</span>, <span class="st">"r_d"</span>)) <span class="sc">|&gt;</span>  </span>
<span id="cb22-1315"><a href="#cb22-1315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addSidebyside</span>(</span>
<span id="cb22-1316"><a href="#cb22-1316" aria-hidden="true" tabindex="-1"></a>    <span class="at">layerId =</span> <span class="st">"sidecontrols"</span>,</span>
<span id="cb22-1317"><a href="#cb22-1317" aria-hidden="true" tabindex="-1"></a>    <span class="at">leftId  =</span> <span class="st">"base_l"</span>,</span>
<span id="cb22-1318"><a href="#cb22-1318" aria-hidden="true" tabindex="-1"></a>    <span class="at">rightId =</span> <span class="st">"base_r"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-1319"><a href="#cb22-1319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addControl</span>(</span>
<span id="cb22-1320"><a href="#cb22-1320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">HTML</span>(<span class="fu">glue</span>(</span>
<span id="cb22-1321"><a href="#cb22-1321" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&lt;b&gt;Historical&lt;/b&gt;&lt;br&gt;</span></span>
<span id="cb22-1322"><a href="#cb22-1322" aria-hidden="true" tabindex="-1"></a><span class="st">      ({paste(range(yrs), collapse = '-')})-{str_pad(month(date),2,pad='0')}-{str_pad(day(date),2,pad='0')}"</span>)), </span>
<span id="cb22-1323"><a href="#cb22-1323" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"topleft"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1324"><a href="#cb22-1324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addControl</span>(</span>
<span id="cb22-1325"><a href="#cb22-1325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">HTML</span>(<span class="fu">glue</span>(</span>
<span id="cb22-1326"><a href="#cb22-1326" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&lt;b&gt;Yesterday&lt;/b&gt;&lt;br&gt;</span></span>
<span id="cb22-1327"><a href="#cb22-1327" aria-hidden="true" tabindex="-1"></a><span class="st">      {date}"</span>)), </span>
<span id="cb22-1328"><a href="#cb22-1328" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"topright"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1329"><a href="#cb22-1329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># leaflet() |&gt; </span></span>
<span id="cb22-1330"><a href="#cb22-1330" aria-hidden="true" tabindex="-1"></a>  <span class="co"># addTiles() |&gt; </span></span>
<span id="cb22-1331"><a href="#cb22-1331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(</span>
<span id="cb22-1332"><a href="#cb22-1332" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tbeptools<span class="sc">::</span>tbsegshed, </span>
<span id="cb22-1333"><a href="#cb22-1333" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"white"</span>, <span class="at">weight =</span> <span class="dv">2</span>, <span class="at">fillOpacity=</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1334"><a href="#cb22-1334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapview::mapView()</span></span>
<span id="cb22-1335"><a href="#cb22-1335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(</span>
<span id="cb22-1336"><a href="#cb22-1336" aria-hidden="true" tabindex="-1"></a>    <span class="at">pal =</span> pal, <span class="at">values =</span> vals, <span class="at">title =</span> var)</span>
<span id="cb22-1337"><a href="#cb22-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1338"><a href="#cb22-1338" aria-hidden="true" tabindex="-1"></a>d_c <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb22-1339"><a href="#cb22-1339" aria-hidden="true" tabindex="-1"></a>  r_c,</span>
<span id="cb22-1340"><a href="#cb22-1340" aria-hidden="true" tabindex="-1"></a>  tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb22-1341"><a href="#cb22-1341" aria-hidden="true" tabindex="-1"></a>  <span class="at">exact =</span> T, <span class="at">touches =</span> T, <span class="at">method =</span> <span class="st">"bilinear"</span>,</span>
<span id="cb22-1342"><a href="#cb22-1342" aria-hidden="true" tabindex="-1"></a>  <span class="at">bind =</span> T,</span>
<span id="cb22-1343"><a href="#cb22-1343" aria-hidden="true" tabindex="-1"></a>  mean, <span class="at">na.rm=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb22-1344"><a href="#cb22-1344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1345"><a href="#cb22-1345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb22-1346"><a href="#cb22-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1347"><a href="#cb22-1347" aria-hidden="true" tabindex="-1"></a>d_d <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(</span>
<span id="cb22-1348"><a href="#cb22-1348" aria-hidden="true" tabindex="-1"></a>  r_d,</span>
<span id="cb22-1349"><a href="#cb22-1349" aria-hidden="true" tabindex="-1"></a>  tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb22-1350"><a href="#cb22-1350" aria-hidden="true" tabindex="-1"></a>  <span class="at">exact =</span> T, <span class="at">touches =</span> T, <span class="at">method =</span> <span class="st">"bilinear"</span>,</span>
<span id="cb22-1351"><a href="#cb22-1351" aria-hidden="true" tabindex="-1"></a>  <span class="at">bind =</span> T,</span>
<span id="cb22-1352"><a href="#cb22-1352" aria-hidden="true" tabindex="-1"></a>  mean, <span class="at">na.rm=</span>T) <span class="sc">|&gt;</span> </span>
<span id="cb22-1353"><a href="#cb22-1353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1354"><a href="#cb22-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb22-1355"><a href="#cb22-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1356"><a href="#cb22-1356" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d_c <span class="sc">|&gt;</span> </span>
<span id="cb22-1357"><a href="#cb22-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb22-1358"><a href="#cb22-1358" aria-hidden="true" tabindex="-1"></a>    d_d,</span>
<span id="cb22-1359"><a href="#cb22-1359" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"long_name"</span>, <span class="st">"bay_segment"</span>))</span>
<span id="cb22-1360"><a href="#cb22-1360" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb22-1361"><a href="#cb22-1361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1362"><a href="#cb22-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1363"><a href="#cb22-1363" aria-hidden="true" tabindex="-1"></a>options(repos=c(CRAN="https://cran.rstudio.com/")); renv::snapshot()</span>
<span id="cb22-1364"><a href="#cb22-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1365"><a href="#cb22-1365" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dewpoint to Humidity</span></span>
<span id="cb22-1366"><a href="#cb22-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1367"><a href="#cb22-1367" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">What is the Dewpoint &amp; How is it Related to Relative Humidity &amp; Heat Index? \| OpenSnow</span><span class="co">](https://opensnow.com/news/post/what-is-the-dewpoint-how-is-it-related-to-the-relative-humidity-heat-index)</span>\</span>
<span id="cb22-1368"><a href="#cb22-1368" aria-hidden="true" tabindex="-1"></a>    Once the dewpoint reaches above 55 degrees Fahrenheit (°F), the air becomes sticky and can be described as ‘muggy’ above 65°F. If the dewpoint reaches above 75°F, the air can often be described as ‘oppressive’...\</span>
<span id="cb22-1369"><a href="#cb22-1369" aria-hidden="true" tabindex="-1"></a>    The relative humidity is expressed in a percent (0-100%) and is the ratio of the amount of atmospheric moisture present relative to the amount that would be present if the air were saturated. What this means is that the relative humidity is **dependent on both the dewpoint and the air temperature.**</span>
<span id="cb22-1370"><a href="#cb22-1370" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Heat Index Calculation</span><span class="co">](https://www.wpc.ncep.noaa.gov/html/heatindex.shtml)</span></span>
<span id="cb22-1371"><a href="#cb22-1371" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">Heat Index Equation</span><span class="co">](https://www.wpc.ncep.noaa.gov/html/heatindex_equation.shtml)</span></span>
<span id="cb22-1372"><a href="#cb22-1372" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">It’s Not the Heat&nbsp;…</span><span class="co">](https://brownmath.com/bsci/notheat.htm#DewpointBackward)</span>\</span>
<span id="cb22-1373"><a href="#cb22-1373" aria-hidden="true" tabindex="-1"></a>        Suppose you know the current temperature and the dew point. Can you get the relative humidity from them? Absolutely!</span>
<span id="cb22-1374"><a href="#cb22-1374" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">Heat Index \| NWS</span><span class="co">](https://w2.weather.gov/arx/heat_index)</span></span>
<span id="cb22-1375"><a href="#cb22-1375" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Lawrence (2005) <span class="co">[</span><span class="ot">The Relationship between Relative Humidity and the Dewpoint Temperature in Moist Air: A Simple Conversion and Applications</span><span class="co">](https://journals.ametsoc.org/view/journals/bams/86/2/bams-86-2-225.xml)</span> *Bulletin of the American Meteorological Society*</span>
<span id="cb22-1376"><a href="#cb22-1376" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">What is Apparent Temperature?</span><span class="co">](https://meteor.geol.iastate.edu/~ckarsten/bufkit/apparent_temperature.html)</span></span>
<span id="cb22-1377"><a href="#cb22-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1378"><a href="#cb22-1378" aria-hidden="true" tabindex="-1"></a>TODO: - <span class="sc">\[</span> <span class="sc">\]</span> summarize by tbeptools::tbsegshed, zip code - <span class="sc">\[</span> <span class="sc">\]</span> compare these precip data w/ Water District data to make case for using PRISM data</span>
<span id="cb22-1379"><a href="#cb22-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1380"><a href="#cb22-1380" aria-hidden="true" tabindex="-1"></a>Questions:</span>
<span id="cb22-1381"><a href="#cb22-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1382"><a href="#cb22-1382" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Given variability within each polygon, which of these products shall we use to plot: min(min_temp), mean(mean_temp), max(max_temp); min(mean_temp), mean(mean_temp), max(max_temp)?</span>
<span id="cb22-1383"><a href="#cb22-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1384"><a href="#cb22-1384" aria-hidden="true" tabindex="-1"></a><span class="fu">### Communicating results</span></span>
<span id="cb22-1385"><a href="#cb22-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1386"><a href="#cb22-1386" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Choi et al. (2024) <span class="co">[</span><span class="ot">North-South disparity in impact of climate change on “outdoor days”</span><span class="co">](https://journals.ametsoc.org/view/journals/clim/aop/JCLI-D-23-0346.1/JCLI-D-23-0346.1.xml)</span>. *Journal of Climate*</span>
<span id="cb22-1387"><a href="#cb22-1387" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>news summary: <span class="co">[</span><span class="ot">A new way to quantify climate change impacts: “Outdoor days” \| MIT News \| Massachusetts Institute of Technology</span><span class="co">](https://news.mit.edu/2024/new-way-quantify-climate-change-impacts-outdoor-days-0322)</span></span>
<span id="cb22-1388"><a href="#cb22-1388" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Shiny app: <span class="co">[</span><span class="ot">California Outdoor Days \| Eltahir Research Group</span><span class="co">](https://eltahir.mit.edu/california-outdoor-days/)</span></span>
<span id="cb22-1389"><a href="#cb22-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1390"><a href="#cb22-1390" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sea</span></span>
<span id="cb22-1391"><a href="#cb22-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1392"><a href="#cb22-1392" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sea Level</span></span>
<span id="cb22-1393"><a href="#cb22-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1394"><a href="#cb22-1394" aria-hidden="true" tabindex="-1"></a>Sea level rise occurs from principally two sources: 1) thermal expansion; and 2) freshwater inputs from glacial melting. Data for these trends can be obtained from NOAA's <span class="co">[</span><span class="ot">Sea Level Trends</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends.html)</span> (@fig-slr-noaa)</span>
<span id="cb22-1395"><a href="#cb22-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1396"><a href="#cb22-1396" aria-hidden="true" tabindex="-1"></a>Types of data:</span>
<span id="cb22-1397"><a href="#cb22-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1398"><a href="#cb22-1398" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Observed (past, present) - tide gauge - satellite, e.g. <span class="co">[</span><span class="ot">Laboratory for Satellite Altimetry / Sea Level Rise</span><span class="co">](https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/)</span></span>
<span id="cb22-1399"><a href="#cb22-1399" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Level-3 products distributed through NOAA CoastWatch (Sea Level Anomaly and along-track altimetry)</span>
<span id="cb22-1400"><a href="#cb22-1400" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Projected (future). modeled</span>
<span id="cb22-1401"><a href="#cb22-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1402"><a href="#cb22-1402" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gauges</span></span>
<span id="cb22-1403"><a href="#cb22-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1404"><a href="#cb22-1404" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Screenshot of NOAA's [Sea Level Trends](https://tidesandcurrents.noaa.gov/sltrends/sltrends.html) zoomed into the Tampa Bay.</span><span class="co">](figures/slr_tidesandcurrents.noaa.gov-sltrends.png)</span>{#fig-slr-noaa}</span>
<span id="cb22-1405"><a href="#cb22-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1406"><a href="#cb22-1406" aria-hidden="true" tabindex="-1"></a>https://tidesandcurrents.noaa.gov/sltrends/</span>
<span id="cb22-1407"><a href="#cb22-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1408"><a href="#cb22-1408" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">PORTS: Tampa Bay PORTS - NOAA Tides &amp; Currents</span><span class="co">](https://tidesandcurrents.noaa.gov/ports/index.html?port=tb)</span></span>
<span id="cb22-1409"><a href="#cb22-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1410"><a href="#cb22-1410" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">api.tidesandcurrents.noaa.gov</span><span class="co">](https://api.tidesandcurrents.noaa.gov/api/prod/)</span></span>
<span id="cb22-1411"><a href="#cb22-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1412"><a href="#cb22-1412" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">CO-OPS Data Retrieval API</span><span class="co">](https://api.tidesandcurrents.noaa.gov/api/prod/)</span></span>
<span id="cb22-1413"><a href="#cb22-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1414"><a href="#cb22-1414" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">CO-OPS Metadata API v1.0</span><span class="co">](https://api.tidesandcurrents.noaa.gov/mdapi/prod/)</span></span>
<span id="cb22-1415"><a href="#cb22-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1416"><a href="#cb22-1416" aria-hidden="true" tabindex="-1"></a>https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/id.extension https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724.json https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724/details.json - "established": "1973-04-19 00:00:00.0" - "origyear": "1995-07-27 23:00:00.0" https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/8726724/products.json - "name": "Water Levels", - "value": "https://tidesandcurrents.noaa.gov/waterlevels.html?id=8726724"</span>
<span id="cb22-1417"><a href="#cb22-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1418"><a href="#cb22-1418" aria-hidden="true" tabindex="-1"></a>https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?id=8726724 https://tidesandcurrents.noaa.gov/sltrends/data/8726724_meantrend.csv</span>
<span id="cb22-1419"><a href="#cb22-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1420"><a href="#cb22-1420" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Inundation History - NOAA Tides &amp; Currents</span><span class="co">](https://tidesandcurrents.noaa.gov/inundationdb/inundation.html?id=8726724#flooddays)</span></span>
<span id="cb22-1421"><a href="#cb22-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1422"><a href="#cb22-1422" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">FAQ for Sea Level Trends \| NOAA Tides &amp; Currents</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/faq.html#:~:text=Relative%20Sea%20Level%20Trends%20reflect%20changes,stations%2C%20called%20monthly%20mean%20sea%20level.)</span> <span class="sc">\&gt;</span> **Relative Sea Level Trends** reflect changes in local sea level over time and are typically the most critical sea level trend for many coastal applications, including coastal mapping, marine boundary delineation, coastal zone management, coastal engineering, sustainable habitat restoration design, and the general public enjoying their favorite beach. This website focuses on relative sea level trends, computed from monthly averages of hourly water levels observed at specific tide stations, called **monthly mean sea level**.</span>
<span id="cb22-1423"><a href="#cb22-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1424"><a href="#cb22-1424" aria-hidden="true" tabindex="-1"></a>See <span class="in">`tbeptools`</span> additions:</span>
<span id="cb22-1425"><a href="#cb22-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1426"><a href="#cb22-1426" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">sealevelstations.R</span><span class="co">](https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/sealevelstations.R)</span></span>
<span id="cb22-1427"><a href="#cb22-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1428"><a href="#cb22-1428" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">read_importsealevels.R</span><span class="co">](https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/R/read_importsealevels.R)</span></span>
<span id="cb22-1429"><a href="#cb22-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1430"><a href="#cb22-1430" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">sealevels.Rmd</span><span class="co">](https://github.com/tbep-tech/tbeptools/blob/climate-change-indicators/vignettes/sealevels.Rmd)</span></span>
<span id="cb22-1431"><a href="#cb22-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1432"><a href="#cb22-1432" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Sea Level Trends - NOAA Tides &amp; Currents</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends.html)</span></span>
<span id="cb22-1433"><a href="#cb22-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1434"><a href="#cb22-1434" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Clearwater Beach, FL\</span>
<span id="cb22-1435"><a href="#cb22-1435" aria-hidden="true" tabindex="-1"></a>    <span class="in">`8726724`</span>\</span>
<span id="cb22-1436"><a href="#cb22-1436" aria-hidden="true" tabindex="-1"></a>    The relative sea level trend is 4.33 mm/year with a 95% confidence interval of +/- 0.52 mm/year based on monthly mean sea level data from 1973 to 2023 which is equivalent to a change of 1.42 feet in 100 years.</span>
<span id="cb22-1437"><a href="#cb22-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1438"><a href="#cb22-1438" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Relative Sea Level Trend</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?id=8726724)</span></span>
<span id="cb22-1439"><a href="#cb22-1439" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Annual Mean Relative Sea Level</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=scenario&amp;id=8726724)</span></span>
<span id="cb22-1440"><a href="#cb22-1440" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Interannual Variation</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=intannvar&amp;id=8726724)</span></span>
<span id="cb22-1441"><a href="#cb22-1441" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Average Seasonal Cycle</span><span class="co">](https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?plot=seasonal&amp;id=8726724)</span></span>
<span id="cb22-1442"><a href="#cb22-1442" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Timelapse – Google Earth Engine</span><span class="co">](https://earthengine.google.com/timelapse/#v=27.978,-82.832,12,latLng&amp;t-3)</span></span>
<span id="cb22-1443"><a href="#cb22-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1444"><a href="#cb22-1444" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>East Bay, FL\</span>
<span id="cb22-1445"><a href="#cb22-1445" aria-hidden="true" tabindex="-1"></a>    <span class="in">`8726674`</span>\</span>
<span id="cb22-1446"><a href="#cb22-1446" aria-hidden="true" tabindex="-1"></a>    The relative sea level trend is 5.8 mm/year with a 95% confidence interval of +/- 0.85 mm/year based on monthly mean sea level data from 1976 to 2023 which is equivalent to a change of 1.90 feet in 100 years.</span>
<span id="cb22-1447"><a href="#cb22-1447" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Port Manatee, FL\</span>
<span id="cb22-1448"><a href="#cb22-1448" aria-hidden="true" tabindex="-1"></a>    <span class="in">`8726384`</span>\</span>
<span id="cb22-1449"><a href="#cb22-1449" aria-hidden="true" tabindex="-1"></a>    The relative sea level trend is 5.5 mm/year with a 95% confidence interval of +/- 0.68 mm/year based on monthly mean sea level data from 1976 to 2023 which is equivalent to a change of 1.80 feet in 100 years.</span>
<span id="cb22-1450"><a href="#cb22-1450" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>St. Petersburg, FL\</span>
<span id="cb22-1451"><a href="#cb22-1451" aria-hidden="true" tabindex="-1"></a>    <span class="in">`8726520`</span>\</span>
<span id="cb22-1452"><a href="#cb22-1452" aria-hidden="true" tabindex="-1"></a>    The relative sea level trend is 3.09 mm/year with a 95% confidence interval of +/- 0.23 mm/year based on monthly mean sea level data from 1947 to 2023 which is equivalent to a change of 1.01 feet in 100 years.</span>
<span id="cb22-1453"><a href="#cb22-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1454"><a href="#cb22-1454" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Inundation Dashboard - NOAA Tides &amp; Currents</span><span class="co">](https://tidesandcurrents.noaa.gov/inundationdb/)</span></span>
<span id="cb22-1455"><a href="#cb22-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1456"><a href="#cb22-1456" aria-hidden="true" tabindex="-1"></a><span class="fu">### Surface Temperature</span></span>
<span id="cb22-1457"><a href="#cb22-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1458"><a href="#cb22-1458" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>coral reefs: ecosystem health, ecotourism</span>
<span id="cb22-1459"><a href="#cb22-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1460"><a href="#cb22-1460" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>fisheries</span>
<span id="cb22-1461"><a href="#cb22-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1462"><a href="#cb22-1462" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>energy for hurricanes</span>
<span id="cb22-1463"><a href="#cb22-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1464"><a href="#cb22-1464" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>background: <span class="co">[</span><span class="ot">NOAA Coral Reef Watch Tutorial</span><span class="co">](https://coralreefwatch.noaa.gov/product/5km/tutorial/crw05a_sst_product.php)</span></span>
<span id="cb22-1465"><a href="#cb22-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1466"><a href="#cb22-1466" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="co">[</span><span class="ot">ERDDAP - Sea Surface Temperature, NOAA Coral Reef Watch Daily Global 5km Satellite SST (CoralTemp), 1985-present, Daily - Data Access Form</span><span class="co">](https://coastwatch.noaa.gov/erddap/griddap/noaacrwsstDaily.html)</span></span>
<span id="cb22-1467"><a href="#cb22-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1468"><a href="#cb22-1468" aria-hidden="true" tabindex="-1"></a>Output is stored in a single raster file containing about a little over 13K layers, which seems to read and render reasonably fast (whereas for the more numerous PRISM layers, it was way too slow).</span>
<span id="cb22-1469"><a href="#cb22-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1470"><a href="#cb22-1470" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Basic Detection and Visualisation of Events • heatwaveR</span><span class="co">](https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation.html)</span></span>
<span id="cb22-1471"><a href="#cb22-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1472"><a href="#cb22-1472" aria-hidden="true" tabindex="-1"></a>    <span class="al">![](https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example1-1.png)</span></span>
<span id="cb22-1473"><a href="#cb22-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1474"><a href="#cb22-1474" aria-hidden="true" tabindex="-1"></a>    <span class="al">![](https://robwschlegel.github.io/heatwaveR/articles/detection_and_visualisation_files/figure-html/fig-example5-1.png)</span></span>
<span id="cb22-1475"><a href="#cb22-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1478"><a href="#cb22-1478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1479"><a href="#cb22-1479" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-1480"><a href="#cb22-1480" aria-hidden="true" tabindex="-1"></a>  sf, tbeptools, mapview)</span>
<span id="cb22-1481"><a href="#cb22-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1482"><a href="#cb22-1482" aria-hidden="true" tabindex="-1"></a>tbshed_buf <span class="ot">&lt;-</span> tbshed <span class="sc">|&gt;</span> </span>
<span id="cb22-1483"><a href="#cb22-1483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="dv">10000</span>) <span class="sc">|&gt;</span> <span class="co"># buffer by 10 km</span></span>
<span id="cb22-1484"><a href="#cb22-1484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1485"><a href="#cb22-1485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-1486"><a href="#cb22-1486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb22-1487"><a href="#cb22-1487" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-1488"><a href="#cb22-1488" aria-hidden="true" tabindex="-1"></a><span class="co"># st_bbox(tbshed_buf) |&gt; round(1)</span></span>
<span id="cb22-1489"><a href="#cb22-1489" aria-hidden="true" tabindex="-1"></a><span class="co">#  xmin  ymin  xmax  ymax </span></span>
<span id="cb22-1490"><a href="#cb22-1490" aria-hidden="true" tabindex="-1"></a><span class="co"># -83.0  27.3 -81.8  28.5</span></span>
<span id="cb22-1491"><a href="#cb22-1491" aria-hidden="true" tabindex="-1"></a><span class="co"># after clipping to non-NA raster values</span></span>
<span id="cb22-1492"><a href="#cb22-1492" aria-hidden="true" tabindex="-1"></a>bbox <span class="ot">=</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.0</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">82.3</span>, <span class="at">ymax=</span> <span class="fl">28.5</span>)</span>
<span id="cb22-1493"><a href="#cb22-1493" aria-hidden="true" tabindex="-1"></a>sst_bbox <span class="ot">&lt;-</span> bbox <span class="sc">|&gt;</span></span>
<span id="cb22-1494"><a href="#cb22-1494" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-1495"><a href="#cb22-1495" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-1496"><a href="#cb22-1496" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="st">"+proj=longlat +datum=WGS84 +no_defs"</span>)</span>
<span id="cb22-1497"><a href="#cb22-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1498"><a href="#cb22-1498" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(tbsegshed, <span class="at">col.regions=</span><span class="st">"gray"</span>) <span class="sc">+</span> </span>
<span id="cb22-1499"><a href="#cb22-1499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapView</span>(tbshed_buf, <span class="at">col.regions =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb22-1500"><a href="#cb22-1500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapView</span>(sst_bbox, <span class="at">col.regions =</span> <span class="st">"red"</span>)</span>
<span id="cb22-1501"><a href="#cb22-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1502"><a href="#cb22-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1505"><a href="#cb22-1505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1506"><a href="#cb22-1506" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: get-sst</span></span>
<span id="cb22-1507"><a href="#cb22-1507" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb22-1508"><a href="#cb22-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1509"><a href="#cb22-1509" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-1510"><a href="#cb22-1510" aria-hidden="true" tabindex="-1"></a>  marinebon<span class="sc">/</span>extractr,</span>
<span id="cb22-1511"><a href="#cb22-1511" aria-hidden="true" tabindex="-1"></a>  here)</span>
<span id="cb22-1512"><a href="#cb22-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1513"><a href="#cb22-1513" aria-hidden="true" tabindex="-1"></a><span class="fu">ed_extract</span>(</span>
<span id="cb22-1514"><a href="#cb22-1514" aria-hidden="true" tabindex="-1"></a>  <span class="at">ed        =</span> <span class="fu">ed_info</span>(<span class="st">"https://coastwatch.noaa.gov/erddap/griddap/noaacrwsstDaily.html"</span>),</span>
<span id="cb22-1515"><a href="#cb22-1515" aria-hidden="true" tabindex="-1"></a>  <span class="at">var       =</span> <span class="st">"analysed_sst"</span>,</span>
<span id="cb22-1516"><a href="#cb22-1516" aria-hidden="true" tabindex="-1"></a>  <span class="at">bbox      =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">83.0</span>, <span class="at">ymin =</span> <span class="fl">27.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">82.3</span>, <span class="at">ymax=</span> <span class="fl">28.5</span>),</span>
<span id="cb22-1517"><a href="#cb22-1517" aria-hidden="true" tabindex="-1"></a>  <span class="at">aoi       =</span> tbeptools<span class="sc">::</span>tbsegshed,</span>
<span id="cb22-1518"><a href="#cb22-1518" aria-hidden="true" tabindex="-1"></a>  <span class="at">zonal_csv =</span> <span class="fu">here</span>(<span class="st">"data/sst/tbep_sst.csv"</span>),</span>
<span id="cb22-1519"><a href="#cb22-1519" aria-hidden="true" tabindex="-1"></a>  <span class="at">rast_tif  =</span> <span class="fu">here</span>(<span class="st">"data/sst/tbep_sst.tif"</span>),</span>
<span id="cb22-1520"><a href="#cb22-1520" aria-hidden="true" tabindex="-1"></a>  <span class="at">mask_tif =</span> F)</span>
<span id="cb22-1521"><a href="#cb22-1521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1522"><a href="#cb22-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1525"><a href="#cb22-1525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1526"><a href="#cb22-1526" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-1527"><a href="#cb22-1527" aria-hidden="true" tabindex="-1"></a>  ggplot2, here, highcharter, lubridate, plotly, readr)</span>
<span id="cb22-1528"><a href="#cb22-1528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1529"><a href="#cb22-1529" aria-hidden="true" tabindex="-1"></a><span class="co"># data("mpg", "diamonds", "economics_long", package = "ggplot2")</span></span>
<span id="cb22-1530"><a href="#cb22-1530" aria-hidden="true" tabindex="-1"></a><span class="co"># economics_long2 &lt;- dplyr::filter(economics_long, variable %in% c("pop", "uempmed", "unemploy"))</span></span>
<span id="cb22-1531"><a href="#cb22-1531" aria-hidden="true" tabindex="-1"></a><span class="co"># hchart(economics_long2, "line", hcaes(x = date, y = value01, group = variable))</span></span>
<span id="cb22-1532"><a href="#cb22-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1533"><a href="#cb22-1533" aria-hidden="true" tabindex="-1"></a>sst_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/sst/tb_sst.csv"</span>)</span>
<span id="cb22-1534"><a href="#cb22-1534" aria-hidden="true" tabindex="-1"></a>d_sst   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(sst_csv, <span class="at">show_col_types =</span> F)</span>
<span id="cb22-1535"><a href="#cb22-1535" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d_sst<span class="sc">$</span>bay_segment)</span>
<span id="cb22-1536"><a href="#cb22-1536" aria-hidden="true" tabindex="-1"></a><span class="co">#   BCB    HB   LTB    MR   MTB   OTB   TCB </span></span>
<span id="cb22-1537"><a href="#cb22-1537" aria-hidden="true" tabindex="-1"></a><span class="co"># 13169 13169 13169 13169 13169 13169 13169 </span></span>
<span id="cb22-1538"><a href="#cb22-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1539"><a href="#cb22-1539" aria-hidden="true" tabindex="-1"></a>bay_segment <span class="ot">&lt;-</span> <span class="st">"BCB"</span></span>
<span id="cb22-1540"><a href="#cb22-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1541"><a href="#cb22-1541" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d_sst <span class="sc">|&gt;</span> </span>
<span id="cb22-1542"><a href="#cb22-1542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bay_segment <span class="sc">==</span> <span class="sc">!!</span>bay_segment) <span class="sc">|&gt;</span> </span>
<span id="cb22-1543"><a href="#cb22-1543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-1544"><a href="#cb22-1544" aria-hidden="true" tabindex="-1"></a>    <span class="at">year  =</span> <span class="fu">year</span>(time),</span>
<span id="cb22-1545"><a href="#cb22-1545" aria-hidden="true" tabindex="-1"></a>    <span class="co"># yday  = yday(time),</span></span>
<span id="cb22-1546"><a href="#cb22-1546" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> <span class="fu">sprintf</span>(</span>
<span id="cb22-1547"><a href="#cb22-1547" aria-hidden="true" tabindex="-1"></a>      <span class="st">"%d-%02d-%02d"</span>, </span>
<span id="cb22-1548"><a href="#cb22-1548" aria-hidden="true" tabindex="-1"></a>      <span class="fu">year</span>(<span class="fu">today</span>()), <span class="fu">month</span>(time), <span class="fu">day</span>(time) ) <span class="sc">|&gt;</span> </span>
<span id="cb22-1549"><a href="#cb22-1549" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.POSIXct</span>(),</span>
<span id="cb22-1550"><a href="#cb22-1550" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">case_when</span>(</span>
<span id="cb22-1551"><a href="#cb22-1551" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">==</span> <span class="fu">year</span>(<span class="fu">today</span>())     <span class="sc">~</span> <span class="st">"red"</span>,</span>
<span id="cb22-1552"><a href="#cb22-1552" aria-hidden="true" tabindex="-1"></a>      year <span class="sc">==</span> <span class="fu">year</span>(<span class="fu">today</span>()) <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"orange"</span>,</span>
<span id="cb22-1553"><a href="#cb22-1553" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="st">"gray"</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb22-1554"><a href="#cb22-1554" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(year, yday, date, color, val) |&gt; </span></span>
<span id="cb22-1555"><a href="#cb22-1555" aria-hidden="true" tabindex="-1"></a>  <span class="co"># arrange(year, yday, date, val)</span></span>
<span id="cb22-1556"><a href="#cb22-1556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, year, date, color, val) <span class="sc">|&gt;</span> </span>
<span id="cb22-1557"><a href="#cb22-1557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, date, val)</span>
<span id="cb22-1558"><a href="#cb22-1558" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d$yday) |&gt; range()</span></span>
<span id="cb22-1559"><a href="#cb22-1559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1560"><a href="#cb22-1560" aria-hidden="true" tabindex="-1"></a>yrs    <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(d<span class="sc">$</span>year))</span>
<span id="cb22-1561"><a href="#cb22-1561" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(<span class="st">"darkgray"</span>, <span class="fu">length</span>(yrs)), yrs)</span>
<span id="cb22-1562"><a href="#cb22-1562" aria-hidden="true" tabindex="-1"></a>colors[<span class="fu">as.character</span>(<span class="fu">year</span>(<span class="fu">today</span>()))]     <span class="ot">&lt;-</span> <span class="st">"red"</span></span>
<span id="cb22-1563"><a href="#cb22-1563" aria-hidden="true" tabindex="-1"></a>colors[<span class="fu">as.character</span>(<span class="fu">year</span>(<span class="fu">today</span>()) <span class="sc">-</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="st">"orange"</span></span>
<span id="cb22-1564"><a href="#cb22-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1565"><a href="#cb22-1565" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb22-1566"><a href="#cb22-1566" aria-hidden="true" tabindex="-1"></a>  slider, scales)</span>
<span id="cb22-1567"><a href="#cb22-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1568"><a href="#cb22-1568" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb22-1569"><a href="#cb22-1569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span> </span>
<span id="cb22-1570"><a href="#cb22-1570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-1571"><a href="#cb22-1571" aria-hidden="true" tabindex="-1"></a>    <span class="at">val_sl =</span> slider<span class="sc">::</span><span class="fu">slide_mean</span>(</span>
<span id="cb22-1572"><a href="#cb22-1572" aria-hidden="true" tabindex="-1"></a>      val, <span class="at">before =</span> <span class="dv">3</span>L, <span class="at">after =</span> <span class="dv">3</span>L, <span class="at">step =</span> <span class="dv">1</span>L, </span>
<span id="cb22-1573"><a href="#cb22-1573" aria-hidden="true" tabindex="-1"></a>      <span class="at">complete =</span> F, <span class="at">na_rm =</span> T),</span>
<span id="cb22-1574"><a href="#cb22-1574" aria-hidden="true" tabindex="-1"></a>    <span class="at">txt_date =</span> <span class="fu">as.Date</span>(time),</span>
<span id="cb22-1575"><a href="#cb22-1575" aria-hidden="true" tabindex="-1"></a>    <span class="at">txt_val  =</span> <span class="fu">round</span>(val_sl, <span class="dv">2</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb22-1576"><a href="#cb22-1576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">|&gt;</span> </span>
<span id="cb22-1577"><a href="#cb22-1577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb22-1578"><a href="#cb22-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1579"><a href="#cb22-1579" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: darkly theme w/ bslib</span></span>
<span id="cb22-1580"><a href="#cb22-1580" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb22-1581"><a href="#cb22-1581" aria-hidden="true" tabindex="-1"></a>  d,</span>
<span id="cb22-1582"><a href="#cb22-1582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(</span>
<span id="cb22-1583"><a href="#cb22-1583" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> date, </span>
<span id="cb22-1584"><a href="#cb22-1584" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> val_sl,</span>
<span id="cb22-1585"><a href="#cb22-1585" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> year,</span>
<span id="cb22-1586"><a href="#cb22-1586" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(year),</span>
<span id="cb22-1587"><a href="#cb22-1587" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> txt_date,</span>
<span id="cb22-1588"><a href="#cb22-1588" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> txt_val)) <span class="sc">+</span>  <span class="co"># frame = yday</span></span>
<span id="cb22-1589"><a href="#cb22-1589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb22-1590"><a href="#cb22-1590" aria-hidden="true" tabindex="-1"></a>    <span class="co"># aes(text  = text),</span></span>
<span id="cb22-1591"><a href="#cb22-1591" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb22-1592"><a href="#cb22-1592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb22-1593"><a href="#cb22-1593" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> colors) <span class="sc">+</span> </span>
<span id="cb22-1594"><a href="#cb22-1594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb22-1595"><a href="#cb22-1595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_datetime</span>(</span>
<span id="cb22-1596"><a href="#cb22-1596" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">date_format</span>(<span class="st">"%b %d"</span>)) <span class="sc">+</span> </span>
<span id="cb22-1597"><a href="#cb22-1597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-1598"><a href="#cb22-1598" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day of year"</span>,</span>
<span id="cb22-1599"><a href="#cb22-1599" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Temperature ºC"</span>)</span>
<span id="cb22-1600"><a href="#cb22-1600" aria-hidden="true" tabindex="-1"></a>g</span>
<span id="cb22-1601"><a href="#cb22-1601" aria-hidden="true" tabindex="-1"></a><span class="co"># x, y, alpha, color, group, linetype, size</span></span>
<span id="cb22-1602"><a href="#cb22-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1603"><a href="#cb22-1603" aria-hidden="true" tabindex="-1"></a><span class="co"># add color theming</span></span>
<span id="cb22-1604"><a href="#cb22-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1605"><a href="#cb22-1605" aria-hidden="true" tabindex="-1"></a><span class="co"># https://rstudio.github.io/thematic/articles/auto.html</span></span>
<span id="cb22-1606"><a href="#cb22-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1607"><a href="#cb22-1607" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(g, <span class="at">tooltip=</span><span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"value"</span>))</span>
<span id="cb22-1608"><a href="#cb22-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1609"><a href="#cb22-1609" aria-hidden="true" tabindex="-1"></a><span class="co"># https://plotly-r.com/scatter-traces 3</span></span>
<span id="cb22-1610"><a href="#cb22-1610" aria-hidden="true" tabindex="-1"></a><span class="co"># https://plotly-r.com/client-side-linking 16</span></span>
<span id="cb22-1611"><a href="#cb22-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1612"><a href="#cb22-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1613"><a href="#cb22-1613" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/76435688/how-to-autoplay-a-plotly-chart-in-shiny</span></span>
<span id="cb22-1614"><a href="#cb22-1614" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb22-1615"><a href="#cb22-1615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb22-1616"><a href="#cb22-1616" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> <span class="sc">~</span>date,</span>
<span id="cb22-1617"><a href="#cb22-1617" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="sc">~</span>val,</span>
<span id="cb22-1618"><a href="#cb22-1618" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span>yday,</span>
<span id="cb22-1619"><a href="#cb22-1619" aria-hidden="true" tabindex="-1"></a>    <span class="co"># group = ~year,</span></span>
<span id="cb22-1620"><a href="#cb22-1620" aria-hidden="true" tabindex="-1"></a>    <span class="co"># color = ~color,</span></span>
<span id="cb22-1621"><a href="#cb22-1621" aria-hidden="true" tabindex="-1"></a>    <span class="at">type  =</span> <span class="st">'scatter'</span>, </span>
<span id="cb22-1622"><a href="#cb22-1622" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode  =</span> <span class="st">'lines'</span>,</span>
<span id="cb22-1623"><a href="#cb22-1623" aria-hidden="true" tabindex="-1"></a>    <span class="co"># marker = list(size = 20),</span></span>
<span id="cb22-1624"><a href="#cb22-1624" aria-hidden="true" tabindex="-1"></a>    <span class="at">showlegend =</span> F,</span>
<span id="cb22-1625"><a href="#cb22-1625" aria-hidden="true" tabindex="-1"></a>    <span class="at">transforms =</span> <span class="fu">list</span>(</span>
<span id="cb22-1626"><a href="#cb22-1626" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb22-1627"><a href="#cb22-1627" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">'groupby'</span>,</span>
<span id="cb22-1628"><a href="#cb22-1628" aria-hidden="true" tabindex="-1"></a>      <span class="at">groups =</span> d<span class="sc">$</span>year,</span>
<span id="cb22-1629"><a href="#cb22-1629" aria-hidden="true" tabindex="-1"></a>      <span class="at">styles =</span> <span class="fu">list</span>(</span>
<span id="cb22-1630"><a href="#cb22-1630" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2024</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'red'</span>))),</span>
<span id="cb22-1631"><a href="#cb22-1631" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2023</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'orange'</span>))),</span>
<span id="cb22-1632"><a href="#cb22-1632" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">target =</span> <span class="dv">2022</span>, <span class="at">value =</span> <span class="fu">list</span>(<span class="at">line =</span><span class="fu">list</span>(<span class="at">color =</span> <span class="st">'darkgray'</span>))) ) ) ) )</span>
<span id="cb22-1633"><a href="#cb22-1633" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-1634"><a href="#cb22-1634" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-1635"><a href="#cb22-1635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_button</span>(<span class="at">visible =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb22-1636"><a href="#cb22-1636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb22-1637"><a href="#cb22-1637" aria-hidden="true" tabindex="-1"></a><span class="st">    function(el,x) {</span></span>
<span id="cb22-1638"><a href="#cb22-1638" aria-hidden="true" tabindex="-1"></a><span class="st">      Plotly.animate(el);</span></span>
<span id="cb22-1639"><a href="#cb22-1639" aria-hidden="true" tabindex="-1"></a><span class="st">    }"</span>)</span>
<span id="cb22-1640"><a href="#cb22-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1641"><a href="#cb22-1641" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb22-1642"><a href="#cb22-1642" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmlwidgets)</span>
<span id="cb22-1643"><a href="#cb22-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1644"><a href="#cb22-1644" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-1645"><a href="#cb22-1645" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), </span>
<span id="cb22-1646"><a href="#cb22-1646" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), </span>
<span id="cb22-1647"><a href="#cb22-1647" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb22-1648"><a href="#cb22-1648" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-1649"><a href="#cb22-1649" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb22-1650"><a href="#cb22-1650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb22-1651"><a href="#cb22-1651" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span>x,</span>
<span id="cb22-1652"><a href="#cb22-1652" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span>y,</span>
<span id="cb22-1653"><a href="#cb22-1653" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span>f,</span>
<span id="cb22-1654"><a href="#cb22-1654" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">'scatter'</span>,</span>
<span id="cb22-1655"><a href="#cb22-1655" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode =</span> <span class="st">'markers'</span>,</span>
<span id="cb22-1656"><a href="#cb22-1656" aria-hidden="true" tabindex="-1"></a>    <span class="at">marker =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb22-1657"><a href="#cb22-1657" aria-hidden="true" tabindex="-1"></a>    <span class="at">showlegend =</span> <span class="cn">FALSE</span></span>
<span id="cb22-1658"><a href="#cb22-1658" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-1659"><a href="#cb22-1659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_button</span>(<span class="at">visible =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-1660"><a href="#cb22-1660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb22-1661"><a href="#cb22-1661" aria-hidden="true" tabindex="-1"></a><span class="st">        function(el,x) {</span></span>
<span id="cb22-1662"><a href="#cb22-1662" aria-hidden="true" tabindex="-1"></a><span class="st">          Plotly.animate(el);</span></span>
<span id="cb22-1663"><a href="#cb22-1663" aria-hidden="true" tabindex="-1"></a><span class="st">        }"</span>)</span>
<span id="cb22-1664"><a href="#cb22-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1665"><a href="#cb22-1665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1666"><a href="#cb22-1666" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/61152879/change-the-frame-label-in-plotly-animation</span></span>
<span id="cb22-1667"><a href="#cb22-1667" aria-hidden="true" tabindex="-1"></a>DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-1668"><a href="#cb22-1668" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1980</span>L, <span class="dv">2020</span>L), <span class="at">each =</span> <span class="dv">12</span>), </span>
<span id="cb22-1669"><a href="#cb22-1669" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="dv">41</span>), </span>
<span id="cb22-1670"><a href="#cb22-1670" aria-hidden="true" tabindex="-1"></a>  <span class="at">month_char =</span> <span class="fu">rep</span>(<span class="fu">factor</span>(month.abb), <span class="dv">41</span>),</span>
<span id="cb22-1671"><a href="#cb22-1671" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_depth =</span> <span class="fu">runif</span>(<span class="dv">492</span>) )</span>
<span id="cb22-1672"><a href="#cb22-1672" aria-hidden="true" tabindex="-1"></a><span class="co"># with(DF, paste0(sprintf("%02d", month), " - ", month_char) )</span></span>
<span id="cb22-1673"><a href="#cb22-1673" aria-hidden="true" tabindex="-1"></a>fig <span class="ot">&lt;-</span> DF <span class="sc">|&gt;</span> </span>
<span id="cb22-1674"><a href="#cb22-1674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_ly</span>(</span>
<span id="cb22-1675"><a href="#cb22-1675" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">~</span>year, </span>
<span id="cb22-1676"><a href="#cb22-1676" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="sc">~</span>avg_depth,</span>
<span id="cb22-1677"><a href="#cb22-1677" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame =</span> <span class="sc">~</span><span class="fu">paste0</span>(<span class="fu">sprintf</span>(<span class="st">"%02d"</span>, month), <span class="st">" - "</span>, month_char),</span>
<span id="cb22-1678"><a href="#cb22-1678" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">'bar'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-1679"><a href="#cb22-1679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">animation_slider</span>(</span>
<span id="cb22-1680"><a href="#cb22-1680" aria-hidden="true" tabindex="-1"></a>    <span class="at">currentvalue =</span> <span class="fu">list</span>(<span class="at">prefix =</span> <span class="st">"Month: "</span>) )</span>
<span id="cb22-1681"><a href="#cb22-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1682"><a href="#cb22-1682" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb22-1683"><a href="#cb22-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1684"><a href="#cb22-1684" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/50843134/r-plotly-animated-chart-only-showing-groups-with-data-in-initial-frame</span></span>
<span id="cb22-1685"><a href="#cb22-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1686"><a href="#cb22-1686" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2010</span></span>
<span id="cb22-1687"><a href="#cb22-1687" aria-hidden="true" tabindex="-1"></a>countries <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"US"</span>, <span class="st">"GB"</span>, <span class="st">"JP"</span>)</span>
<span id="cb22-1688"><a href="#cb22-1688" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">merge</span>(dates, countries, <span class="at">all=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-1689"><a href="#cb22-1689" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"Country"</span>)</span>
<span id="cb22-1690"><a href="#cb22-1690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1691"><a href="#cb22-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1692"><a href="#cb22-1692" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df))</span>
<span id="cb22-1693"><a href="#cb22-1693" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df))</span>
<span id="cb22-1694"><a href="#cb22-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1695"><a href="#cb22-1695" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb22-1696"><a href="#cb22-1696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1697"><a href="#cb22-1697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1698"><a href="#cb22-1698" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x, y, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb22-1699"><a href="#cb22-1699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">frame =</span> Date)) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb22-1700"><a href="#cb22-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1701"><a href="#cb22-1701" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(p)</span>
<span id="cb22-1702"><a href="#cb22-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1703"><a href="#cb22-1703" aria-hidden="true" tabindex="-1"></a><span class="co"># other</span></span>
<span id="cb22-1704"><a href="#cb22-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1705"><a href="#cb22-1705" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb22-1706"><a href="#cb22-1706" aria-hidden="true" tabindex="-1"></a>  d,</span>
<span id="cb22-1707"><a href="#cb22-1707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(</span>
<span id="cb22-1708"><a href="#cb22-1708" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> date, </span>
<span id="cb22-1709"><a href="#cb22-1709" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> val, </span>
<span id="cb22-1710"><a href="#cb22-1710" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(year))) <span class="sc">+</span></span>
<span id="cb22-1711"><a href="#cb22-1711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb22-1712"><a href="#cb22-1712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb22-1713"><a href="#cb22-1713" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> colors) <span class="sc">+</span> </span>
<span id="cb22-1714"><a href="#cb22-1714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb22-1715"><a href="#cb22-1715" aria-hidden="true" tabindex="-1"></a>g</span>
<span id="cb22-1716"><a href="#cb22-1716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1717"><a href="#cb22-1717" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb22-1718"><a href="#cb22-1718" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplotly</span>(g) <span class="sc">|&gt;</span> </span>
<span id="cb22-1719"><a href="#cb22-1719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRender</span>(<span class="st">"</span></span>
<span id="cb22-1720"><a href="#cb22-1720" aria-hidden="true" tabindex="-1"></a><span class="st">    function(el,x) {</span></span>
<span id="cb22-1721"><a href="#cb22-1721" aria-hidden="true" tabindex="-1"></a><span class="st">      Plotly.animate(el);</span></span>
<span id="cb22-1722"><a href="#cb22-1722" aria-hidden="true" tabindex="-1"></a><span class="st">    }"</span>)</span>
<span id="cb22-1723"><a href="#cb22-1723" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb22-1724"><a href="#cb22-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1725"><a href="#cb22-1725" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span> </span>
<span id="cb22-1726"><a href="#cb22-1726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hchart</span>(</span>
<span id="cb22-1727"><a href="#cb22-1727" aria-hidden="true" tabindex="-1"></a>    <span class="st">"line"</span>, <span class="co"># "line"</span></span>
<span id="cb22-1728"><a href="#cb22-1728" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hcaes</span>(</span>
<span id="cb22-1729"><a href="#cb22-1729" aria-hidden="true" tabindex="-1"></a>      <span class="at">x            =</span> date, </span>
<span id="cb22-1730"><a href="#cb22-1730" aria-hidden="true" tabindex="-1"></a>      <span class="at">y            =</span> val, </span>
<span id="cb22-1731"><a href="#cb22-1731" aria-hidden="true" tabindex="-1"></a>      <span class="at">group        =</span> year,</span>
<span id="cb22-1732"><a href="#cb22-1732" aria-hidden="true" tabindex="-1"></a>      <span class="at">segmentColor =</span> clr),</span>
<span id="cb22-1733"><a href="#cb22-1733" aria-hidden="true" tabindex="-1"></a>    <span class="at">showInLegend =</span> F)</span>
<span id="cb22-1734"><a href="#cb22-1734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1735"><a href="#cb22-1735" aria-hidden="true" tabindex="-1"></a>mpgman2 <span class="ot">&lt;-</span> <span class="fu">count</span>(mpg, manufacturer, year)</span>
<span id="cb22-1736"><a href="#cb22-1736" aria-hidden="true" tabindex="-1"></a><span class="fu">hchart</span>(</span>
<span id="cb22-1737"><a href="#cb22-1737" aria-hidden="true" tabindex="-1"></a>  mpgman2, </span>
<span id="cb22-1738"><a href="#cb22-1738" aria-hidden="true" tabindex="-1"></a>  <span class="st">"bar"</span>,</span>
<span id="cb22-1739"><a href="#cb22-1739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcaes</span>(<span class="at">x =</span> manufacturer, <span class="at">y =</span> n, <span class="at">group =</span> year),</span>
<span id="cb22-1740"><a href="#cb22-1740" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="fu">c</span>(<span class="st">"#7CB5EC"</span>, <span class="st">"#F7A35C"</span>),</span>
<span id="cb22-1741"><a href="#cb22-1741" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Year 1999"</span>, <span class="st">"Year 2008"</span>),</span>
<span id="cb22-1742"><a href="#cb22-1742" aria-hidden="true" tabindex="-1"></a>  <span class="at">showInLegend =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>) <span class="co"># only show the first one in the legend</span></span>
<span id="cb22-1743"><a href="#cb22-1743" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-1744"><a href="#cb22-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1745"><a href="#cb22-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1746"><a href="#cb22-1746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1747"><a href="#cb22-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1748"><a href="#cb22-1748" aria-hidden="true" tabindex="-1"></a><span class="fu">### Acidification</span></span>
<span id="cb22-1749"><a href="#cb22-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1750"><a href="#cb22-1750" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extreme Weather</span></span>
<span id="cb22-1751"><a href="#cb22-1751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1752"><a href="#cb22-1752" aria-hidden="true" tabindex="-1"></a>Or "Severe Weather"</span>
<span id="cb22-1753"><a href="#cb22-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1754"><a href="#cb22-1754" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">SWDI vignette • rnoaa</span><span class="co">](https://docs.ropensci.org/rnoaa/articles/swdi_vignette.html)</span></span>
<span id="cb22-1755"><a href="#cb22-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1756"><a href="#cb22-1756" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hurricanes</span></span>
<span id="cb22-1757"><a href="#cb22-1757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1758"><a href="#cb22-1758" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>property damage</span>
<span id="cb22-1759"><a href="#cb22-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1762"><a href="#cb22-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1763"><a href="#cb22-1763" aria-hidden="true" tabindex="-1"></a>rnoaa<span class="sc">::</span><span class="fu">coops_search</span>()</span>
<span id="cb22-1764"><a href="#cb22-1764" aria-hidden="true" tabindex="-1"></a><span class="co"># swdi - Severe Weather Data Inventory (SWDI) vignette</span></span>
<span id="cb22-1765"><a href="#cb22-1765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1766"><a href="#cb22-1766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-1767"><a href="#cb22-1767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1768"><a href="#cb22-1768" aria-hidden="true" tabindex="-1"></a><span class="fu">### Floods</span></span>
<span id="cb22-1769"><a href="#cb22-1769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1770"><a href="#cb22-1770" aria-hidden="true" tabindex="-1"></a><span class="fu">## OLD</span></span>
<span id="cb22-1771"><a href="#cb22-1771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1772"><a href="#cb22-1772" aria-hidden="true" tabindex="-1"></a><span class="fu">### Satellite</span></span>
<span id="cb22-1773"><a href="#cb22-1773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1774"><a href="#cb22-1774" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">NOAA / NESDIS / STAR - Laboratory for Satellite Altimetry / Sea Level Rise</span><span class="co">](https://www.star.nesdis.noaa.gov/socd/lsa/SeaLevelRise/LSA_SLR_maps.php)</span></span>
<span id="cb22-1775"><a href="#cb22-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1778"><a href="#cb22-1778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-1779"><a href="#cb22-1779" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-slr-satellite</span></span>
<span id="cb22-1780"><a href="#cb22-1780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1781"><a href="#cb22-1781" aria-hidden="true" tabindex="-1"></a>slr_nc    <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/slr/slr_map_txj1j2.nc"</span>)</span>
<span id="cb22-1782"><a href="#cb22-1782" aria-hidden="true" tabindex="-1"></a>r_slr_gcs <span class="ot">&lt;-</span> <span class="fu">rast</span>(slr_nc)  <span class="co"># 0.5 degree resolution</span></span>
<span id="cb22-1783"><a href="#cb22-1783" aria-hidden="true" tabindex="-1"></a>r_slr_mer <span class="ot">&lt;-</span> <span class="fu">projectRasterForLeaflet</span>(r_slr_gcs, <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb22-1784"><a href="#cb22-1784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1785"><a href="#cb22-1785" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbsegshed)</span>
<span id="cb22-1786"><a href="#cb22-1786" aria-hidden="true" tabindex="-1"></a>r_slr_tb_mer <span class="ot">&lt;-</span> <span class="fu">rast</span>(slr_nc) <span class="sc">|&gt;</span> </span>
<span id="cb22-1787"><a href="#cb22-1787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crop</span>(b) <span class="co"># |&gt; </span></span>
<span id="cb22-1788"><a href="#cb22-1788" aria-hidden="true" tabindex="-1"></a>  <span class="co"># projectRasterForLeaflet(method="bilinear")</span></span>
<span id="cb22-1789"><a href="#cb22-1789" aria-hidden="true" tabindex="-1"></a><span class="co"># only one value for Tampa Bay extracted at 0.5 degree resolution</span></span>
<span id="cb22-1790"><a href="#cb22-1790" aria-hidden="true" tabindex="-1"></a><span class="co"># values(r_slr_tb_mer, mat=F, na.rm=T)  # 5.368306</span></span>
<span id="cb22-1791"><a href="#cb22-1791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-1792"><a href="#cb22-1792" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(tbshed)</span>
<span id="cb22-1793"><a href="#cb22-1793" aria-hidden="true" tabindex="-1"></a><span class="fu">plet</span>(r_slr_mer, <span class="at">tiles=</span>providers<span class="sc">$</span>Esri.OceanBasemap) <span class="sc">|&gt;</span> </span>
<span id="cb22-1794"><a href="#cb22-1794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>CartoDB.DarkMatterOnlyLabels) <span class="sc">|&gt;</span> </span>
<span id="cb22-1795"><a href="#cb22-1795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolygons</span>(<span class="at">data =</span> tbsegshed) <span class="sc">|&gt;</span></span>
<span id="cb22-1796"><a href="#cb22-1796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fitBounds</span>(</span>
<span id="cb22-1797"><a href="#cb22-1797" aria-hidden="true" tabindex="-1"></a>    <span class="at">lng1 =</span> b[[<span class="st">"xmin"</span>]], <span class="at">lat1 =</span> b[[<span class="st">"ymin"</span>]], </span>
<span id="cb22-1798"><a href="#cb22-1798" aria-hidden="true" tabindex="-1"></a>    <span class="at">lng2 =</span> b[[<span class="st">"xmax"</span>]], <span class="at">lat2 =</span> b[[<span class="st">"ymax"</span>]])</span>
<span id="cb22-1799"><a href="#cb22-1799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© <a href="https://tbep.org" target="_blank">Tampa Bay Estuary Program</a></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tbep-tech/climate-change-indicators/edit/main/data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/" target="_blank">Quarto</a></p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"loop":false,"descPosition":"bottom","selector":".lightbox","openEffect":"zoom","closeEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>